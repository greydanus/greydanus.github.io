<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="http://greydanus.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="http://greydanus.github.io/" rel="alternate" type="text/html" /><updated>2022-06-27T00:00:26-07:00</updated><id>http://greydanus.github.io/feed.xml</id><title type="html">Natural Intelligence</title><subtitle>A blog by Sam Greydanus</subtitle><entry><title type="html">Studying Growth with Cellular Automata</title><link href="http://greydanus.github.io/2022/05/23/studying-growth/" rel="alternate" type="text/html" title="Studying Growth with Cellular Automata" /><published>2022-05-23T23:50:00-07:00</published><updated>2022-05-23T23:50:00-07:00</updated><id>http://greydanus.github.io/2022/05/23/studying-growth</id><content type="html" xml:base="http://greydanus.github.io/2022/05/23/studying-growth/">&lt;!-- &quot;We simulate the process of cell growth called morphogenesis. Then we find growth rules that generate a range of flowers and use them to grow a garden.&quot; --&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;video1&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/studying-growth/rose.jpg&quot;&gt;
      &lt;source src=&quot;/assets/studying-growth/rose.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video1_button&quot; onclick=&quot;playPauseVideo1()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;video2&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/studying-growth/marigold.jpg&quot;&gt;
      &lt;source src=&quot;/assets/studying-growth/marigold.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video2_button&quot; onclick=&quot;playPauseVideo2()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
   &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;video3&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/studying-growth/crocus.jpg&quot;&gt;
      &lt;source src=&quot;/assets/studying-growth/crocus.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video3_button&quot; onclick=&quot;playPauseVideo3()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
  &lt;div style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:95%&quot;&gt;&lt;b&gt;Growing flowers.&lt;/b&gt; The pixels in the images above represent cells. By exchanging signals with their neighbors, these cells coordinate their behavior and assemble themselves in the shapes of the three flowers shown.&lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseVideo1() { 
  var video = document.getElementById(&quot;video1&quot;); 
  var button = document.getElementById(&quot;video1_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 

function playPauseVideo2() { 
  var video = document.getElementById(&quot;video2&quot;); 
  var button = document.getElementById(&quot;video2_button&quot;);
  if (video.paused) {
    video.play();
  button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 

function playPauseVideo3() { 
  var video = document.getElementById(&quot;video3&quot;); 
  var button = document.getElementById(&quot;video3_button&quot;);
  if (video.paused) {
    video.play();
  button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://colab.research.google.com/drive/1TgGN5qjjH6MrMrTcStEkdHO-giEJ4bZr&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Run&lt;/span&gt; in browser&lt;/a&gt;
  &lt;a href=&quot;https://github.com/greydanus/studying_growth&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Get the code&lt;/a&gt;
&lt;/div&gt;

&lt;!-- ## A Productive Question --&gt;

&lt;p&gt;How does a single fertilized egg grow into a population of seventy trillion cells: a population that can walk, talk, and write sonnets? This is one of the great unanswered questions of biology. We may never finish answering it, but it is a productive question nonetheless. In asking it, scientists have discovered the structure of DNA, sequenced the human genome, and made essential contributions to modern medicine.&lt;/p&gt;

&lt;p&gt;In this post, we will explore this question with a new tool called Neural Cellular Automata (NCA).&lt;/p&gt;

&lt;!-- **Neural Cellular Automata.** A few years ago, scientists showed that it is possible to use neural networks to represent the rules for how simulated cells interact with one another. This allowed them to teach simulated cells to interact with one another at a local scale in order to produce complex emergent behaviors at the population level. So far, only a few papers have been written about these &quot;Neural Cellular Automata&quot; models. One reason is that they are a relatively new idea. Another reason is that, although they require expertise in ML to implement, their main intellectual appeal is to an audience interested in cellular morphogenesis. The intersection of people who are comfortable in both worlds is relatively small.

But the mechanics of cellular morphogenesis are extremely important. Indeed, NCA may be the best long-term means of understanding the programming language of our bodies&apos; cells. If DNA is the source code that comes pre-installed on your computer, then cellular morphogenesis is the complex and varied means by which your computer performs its functions: booting up, decompressing files, creating pop-up windows, and so forth. In order to understand your computer as a whole, it makes a lot of sense to start by studying the mechanics of these everyday functions.

With all of this in mind, let&apos;s take a closer look at how NCA work and then apply them to some simple biology problems. --&gt;

&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;

&lt;p&gt;The purpose of cellular automata (CA) &lt;em&gt;writ large&lt;/em&gt; is to mimic biological growth at the cellular level. Most CAs begin with a grid of pixels where each pixel represents a different cell. Then a set of growth rules, controlling how cells respond to their neighbors, are applied to the population in an iterative manner. Although these growth rules are simple to write down, they are choosen so as to produce complex self-organizing behaviors. For example, Conway’s Game of Life has just three simple growth rules that give rise to a diverse range of structures.&lt;sup id=&quot;fnref:fn4&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn4&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:49.4%; min-width:280px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;img src=&quot;/assets/studying-growth/conway_rules.jpg&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:49.7%; min-width:280px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;video_conway&quot; controls=&quot;&quot; style=&quot;width:100%&quot;&gt;
      &lt;source src=&quot;/assets/studying-growth/conway.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Classic versions of cellular automata like Conway’s Game of Life are interesting because they produce emergent behavior starting from simple rules. But in a way, these versions of CA are &lt;em&gt;too simple&lt;/em&gt;. Their cells only get to have two states, dead or alive, whereas biological cells get to have a near-infinite number of states, states which are determined by a wide variety of signaling molecules. We refer to these molecules as &lt;em&gt;morphogens&lt;/em&gt; because they work together to control growth and guide organisms towards specific final shapes or &lt;em&gt;morphologies&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Neural CA.&lt;/strong&gt; Based on this observation, we should move away from CA with cells that are only dead or alive. Instead, we should permit their cells to exist in a variety of states with each state defined by a list of continuous variables. Growth rules should operate on combinations of these variables in the same way that biological growth rules operate on combinations of different morphogens. And unlike Conway’s Game of Life, the self-organizing behaviors that arise should not be arbitrary or chaotic. Rather, they should involve stable convergence to &lt;em&gt;specific&lt;/em&gt; large-scale morphologies like those that occur in biology. Much more complex growth rules are needed for this to occur.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/comparison.jpg&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;The diagram above shows how NCA take a step in the right direction. Unlike regular cellular automata, they represent each cell state with a real-valued \(n\)-dimensional vector and then allow arbitrary growth rules to operate on that domain. They do this by &lt;em&gt;parameterizing growth rules with a neural network and then optimizing the neural network to obtain the desired pattern of growth&lt;/em&gt;. To showcase the model’s expressivity, the authors trained it to arrange a population of a 1600 cells in the shape of a lizard starting from local-only interactions between initially identical cells.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/nca_schema.jpg&quot; /&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;b&gt;NCA diagram.&lt;/b&gt; The diagram above how a neural network can be used to parameterize the growth rules of a cellular autiomata. The &lt;a href=&quot;https://distill.pub/2020/growing-ca/&quot;&gt;original NCA article&lt;/a&gt; uses this diagram to introduce the model and its training procedure.
  &lt;/div&gt;
&lt;/div&gt;

&lt;h2 id=&quot;getting-started&quot;&gt;Getting started&lt;/h2&gt;

&lt;!-- We need to start with a high-quality NCA implementation, one that is flexible enough to modify for the purposes of our experiments. The authors of the original NCA paper released a series of excellent Colab notebooks which show how to implement the model in TensorFlow. But after experimenting with their code, I decided to reimplement everything in PyTorch. I like PyTorch better and I wanted to make a minimalist implementation that would be easy to hack on in order to try out new ideas. You can find it [here](https://colab.research.google.com/drive/13wCM9OV2JR004zFvh7zPgUxrga8sU4d1). --&gt;

&lt;p&gt;The authors of the original paper released a Colab notebook that showed how to implement NCA in TensorFlow. Starting from this notebook, we reimplemented everything in PyTorch and boiled it down to a minimalist, 150-line implementation. Our goal was to make the NCA model as simple as possible so that we could hack and modify it without getting overwhelmed by implementation details.&lt;/p&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://colab.research.google.com/drive/13wCM9OV2JR004zFvh7zPgUxrga8sU4d1&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;NCA&lt;/span&gt; in 150 lines&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;Having implemented our own NCA model, the next step was to scale it to determine the maximum size and complexity of the “organisms” it could produce. We found that the population size was going to be limited by the amount of RAM available on Google Colab GPUs. We maxed things out with a population of about 7500 cells running for about 100 updates. For context, the original paper used a population of 1600 cells running for 86 updates.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/bloopers.jpg&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;Working in this scaled-up regime, we trained our NCA to grow a number of different flowers. Some of the early results were a bit mangled and blurry. Many were biased towards radial symmetry and required extra training in order to reveal symmetric features such as individual petals. But soon, after a few hyperparameter fixes, our NCA was able to grow some “HD” 64x64 flowers:&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:65%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/garden.jpg&quot; /&gt;
&lt;/div&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://colab.research.google.com/drive/1TgGN5qjjH6MrMrTcStEkdHO-giEJ4bZr&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;HD&lt;/span&gt; flowers&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;Having implemented the NCA model and gained some intuition for how it trained, we were ready to use it to investigate patterns of biological growth.&lt;/p&gt;

&lt;h2 id=&quot;patterns-of-biological-growth&quot;&gt;Patterns of biological growth&lt;/h2&gt;

&lt;p&gt;Biological growth is wonderfully diverse. Consider this passage from the first chapter of &lt;em&gt;Growth&lt;/em&gt; by Life Science Library:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;A eucalyptus native to Uganda has been known to grow 45 feet in two years, whereas dwarf ivy generally grows one inch a year. The majestic sequoia of California, which starts out as a seed weighing only one three-thousandth of an ounce, may end up… [with a] weight estimated at 6,200 tons. It takes more than 1,000 years for the sequoia to achieve the feat of multiplying 600 billion times in mass.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;The animal kingdom, too, has its champions of growth. The blue whale, which cruises the oceans from the North to the South Pole, begins life as a barely visible egg weighing only a fraction of an ounce. At birth, it weighs from two to three tons. When it is weaned, at about seven months, it is 52 feet long and weighs 23 tons, having gained an average of 200 pounds a day.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Given the diversity of life forms on our planet, maybe one of the biggest surprises is how much they have in common. For the most part they share the same genetic materials, signaling mechanisms, and metabolic pathways. Their cells have the same life cycles. Indeed, the cellular mechanics in a gnat look pretty similar to those in a blue whale…even though the creatures themselves could not be more different.&lt;/p&gt;

&lt;h3 id=&quot;1-gnomonic-growth&quot;&gt;&lt;a href=&quot;https://colab.research.google.com/drive/1DUFL5glyej725r8VAYDZIFrWvpR6a6-0&quot;&gt;1. Gnomonic growth&lt;/a&gt;&lt;/h3&gt;

&lt;p&gt;One shared pattern of growth is called &lt;em&gt;gnomonic growth&lt;/em&gt;. This pattern tends to occur when an organism needs to increase in size and part of its body is defined by a rigid structure. You can see this in clams, for example. Their shells are rigid and cannot be deformed. And yet they need to grow their shells as the rest of them grows. Clams solve this problem by incrementally adding long crescent-shaped lips to the edges of their shells. Each new lip is just a little larger than the one that came before it. These lips, or &lt;em&gt;gnomons&lt;/em&gt; as they are called, permit organisms to increase in size without changing form. Gnomons also appear in horns, tusks, and tree trunks.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width:300px&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/gnomons.jpeg&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;One of the most famous products of gnomonic growth is the nautilus shell. In this shell, the gnomons grow with such regularity that the overall shape can be modeled with a simple Fibonacci sequence. The elegance and simplicity of the pattern makes it an interesting testbed for NCA.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width:300px&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/nautilus_photo.jpeg&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;To set up this problem, we split the shell into three regions: frozen, mature, and growing. These regions are shown in cyan, black and magenta respectively:&lt;/p&gt;
&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/nautilus_train.png&quot; /&gt;
&lt;/div&gt;
&lt;p&gt;The cells in the frozen region are, as the name would suggest, frozen. Both their RGBA and hidden channels are fixed throughout training. The cells in the mature region are similar; the only difference is that their hidden channels are allowed to change. The growing region, meanwhile, begins the simulation without any living cells. Cells from the mature region need to grow outwards into this area and arrange themselves properly before the simulation ends.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Scale and rotation invariance.&lt;/strong&gt; Part of the objective in this “gnomonic growth” problem is to learn a growth rule that is scale and rotation invariant. We can accomplish this by rotating and scaling the nautilus template as shown in the six examples above. By training on all of these examples at once, we are able to obtain a model that grows properly at any scale or orientation. Once it learns to do this, it can grow multiple gnomons, one after the other, without much interference. Below, for example, we add eight new compartments and quadruple the shell’s size by letting the NCA run for eight growth cycles.&lt;sup id=&quot;fnref:fn3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/nautilus_bw.png&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;One of the things that makes this growth pattern interesting is that the NCA cells have to reach a global consensus as to what the scale and rotation of the mature region is. Only by agreeing on this are they able to construct a properly-sized addition. And yet in practice, we see that expansion into the growth region begins from the first simulation step. This suggests that cells in the mature region try to come to a distributed consensus as to the target shape &lt;em&gt;even as&lt;/em&gt; new cells are already beginning to grow that shape. Once cells in the mature region know the proper scale and rotation of the gnomon, they transmit this information to the growing region so that it can make small adjustments to its borders. If you look closely, you can see these adjustments happening in the video below.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;naut_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/studying-growth/nautilus.png&quot;&gt;
      &lt;source src=&quot;/assets/studying-growth/nautilus.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;naut_video_button&quot; onclick=&quot;playPauseNaut()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseNaut() { 
  var video = document.getElementById(&quot;naut_video&quot;); 
  var button = document.getElementById(&quot;naut_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://colab.research.google.com/drive/1DUFL5glyej725r8VAYDZIFrWvpR6a6-0&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Growing&lt;/span&gt; a nautilus&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;This process of &lt;em&gt;reaching a consensus in a decentralized and asynchronous manner&lt;/em&gt; is a common problem for biological cells. In fact, we already touched on it in our &lt;a href=&quot;/2020/08/27/selforg-mnist/&quot;&gt;Self-classifying MNIST Digits&lt;/a&gt; post. It’s also important in human organizations: from new cities agreeing on development codes, to democratic institutions agreeing on legislation, to the stock market agreeing on how to value companies. It is not always a low-entropy process.&lt;/p&gt;

&lt;p&gt;Indeed, sometimes groups of cells have to resort to other means of reaching consensus…&lt;/p&gt;

&lt;h3 id=&quot;2-embryonic-induction&quot;&gt;&lt;a href=&quot;https://colab.research.google.com/drive/1fbakmrgkk1y-ZXamH1mKbN1tvkogNrWq&quot;&gt;2. Embryonic induction&lt;/a&gt;&lt;/h3&gt;

&lt;p&gt;The alternative to a fully decentralized consensus mechanism is cellular induction. This happens when one small group of cells (usually in an embryo) tells the rest how to grow. The first group of cells is called the inducing tissue and the second is called the responding tissue. Induction controls the growth of many tissues and organs including the eye and the heart.&lt;/p&gt;

&lt;p&gt;In this section, we will grow an image of a newt and then graft part of its eye tissue onto its belly. After doing this, we will watch to see whether those cells are able to induce growth in the rest of the eye in that region. We’ve chosen this particular experiment as an homage to &lt;a href=&quot;https://en.wikipedia.org/wiki/Hans_Spemann&quot;&gt;Hans Spemann&lt;/a&gt;,&lt;sup id=&quot;fnref:fn2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn2&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt; who won the Nobel Prize for Medicine in 1935 for using similar experiments on real newts to discover “the organizer effect in embryonic development.”&lt;sup id=&quot;fnref:fn5&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn5&quot; class=&quot;footnote&quot;&gt;4&lt;/a&gt;&lt;/sup&gt; Spemann’s major insight was that “at every stage of embryonic development, structures already present act as organizers, inducing the emergence of whatever structures are next on the timetable.”&lt;sup id=&quot;fnref:fn7&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn7&quot; class=&quot;footnote&quot;&gt;5&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:90%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/newt_timeline_tall.png&quot; style=&quot;width:75%; min-width:320px&quot; /&gt;
  &lt;!-- &lt;div class=&quot;thecap&quot;  style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
    &lt;b&gt;Reproducing Hans Spemann&apos;s newt experiment.&lt;/b&gt; In the first 100 frames, we grow an image of a newt using the vanilla NCA model described in &lt;a href=&quot;https://distill.pub/2020/growing-ca/&quot;&gt;Mordvintsev et al. (2020)&lt;/a&gt;. Then, in frame 150 we copy the pixels in the yellow rectangle and paste them onto the newt&apos;s belly, as shown by the yellow arrow. Note that these pixels contain the upper half of the newt&apos;s eye, but not the lower half. We freeze those cells and let the rest of the cells perform updates for another 25 steps. As you can see in frame 175, this induces the belly cells in the blue rectangle to turn black, completing the lower half of the new eye.
  &lt;/div&gt; --&gt;
&lt;/div&gt;

&lt;p&gt;To reproduce this effect, we first trained an NCA to grow a picture of a newt. Once the growth phase was complete, we grafted a patch of cells from its head onto its stomach. This patch of cells included the upper, light-colored portion of the newt’s eye but not the dark-colored, lower portion. Then we froze their states and allowed the rest of the cells to undergo updates as usual. Within 25 steps, the stomach cells below the grafted patch had regrown into a dark-colored strip to complete the lower half of the new eye.&lt;/p&gt;

&lt;!-- Hans Spemann&apos;s experiment involved the same procedure and produced the same results: he grafted eye lens cells onto the stomach of a real newt and induced the growth of a new eye.
 --&gt;
&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:300px; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;newt_video&quot; style=&quot;width:100%;min-width:250px;&quot; controls=&quot;&quot; poster=&quot;/assets/studying-growth/newt.jpg&quot;&gt;
      &lt;source src=&quot;/assets/studying-growth/newt.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;newt_video_button&quot; onclick=&quot;playPauseNewt()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseNewt() { 
  var video = document.getElementById(&quot;newt_video&quot;); 
  var button = document.getElementById(&quot;newt_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://colab.research.google.com/drive/1fbakmrgkk1y-ZXamH1mKbN1tvkogNrWq&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Embryonic&lt;/span&gt; induction&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;Cellular induction offers a simple explanation for how many growth rules are implemented: by and large, they are implemented as &lt;code&gt;if-then&lt;/code&gt; statements. For example, &lt;em&gt;“If I am growing below some light-colored eye tissue, then I should be black-colored eye tissue.”&lt;/em&gt; Early in embryonic development, these &lt;code&gt;if-then&lt;/code&gt; statements are very general: &lt;em&gt;“If I am on the outside layer of the embryo, then I am going to be an ectoderm cell. Else, if I am on the inside layer of the embryo, then I am going to be a mesoderm cell. Else, if I am in the center of the embryo, then I am going to be an endoderm cell.”&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;As development progresses, these branching milestones occur dozens of times, each time causing a group of cells to become more specialized. Towards the end of development, the branching rules might read, &lt;em&gt;“If I am an ectoderm cell and if I am a nervous system cell and if I am an eye cell and if I am distal to the optic nerve then I am going to be part of the corneal epithelium.”&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Attractor theory of development.&lt;/strong&gt; While this sounds complex, it’s actually the simplest and most robust way to construct a multicellular organism. Each of these branching statements determines how morphogenesis unfolds at a different hierarchy of complexity. Unlike a printer, which has to place every dot of ink on a page with perfect precision, a growing embryo doesn’t need to know the final coordinates of every mature adult cell. Moreover, it can withstand plenty of noise and perturbations at each stage of development and still produce an intricate, well-formed organism in the end.&lt;sup id=&quot;fnref:fn6&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn6&quot; class=&quot;footnote&quot;&gt;6&lt;/a&gt;&lt;/sup&gt; Intuitively, this is possible because during each stage of growth, clusters of cells naturally converge to target “attractor” states in spite of perturbations. Errors get corrected before the next stage of growth begins. And in the next stage, new attractor states perform error-correction as well. In this way, embryonic induction allows nature to construct multicellular organisms with great reliability, even in a world full of noise and change.&lt;/p&gt;

&lt;h3 id=&quot;3-apoptosis&quot;&gt;&lt;a href=&quot;https://colab.research.google.com/drive/1qQcztNsqyMLLMB00CVRxc0Pm7ipca0ww&quot;&gt;3. Apoptosis&lt;/a&gt;&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;Death to form the living.&lt;/strong&gt; One of the most dramatic &lt;code&gt;if-then&lt;/code&gt; statements is &lt;em&gt;“If I am in state &lt;code&gt;x&lt;/code&gt;, then I must die.”&lt;/em&gt; This gives rise to what biologists call &lt;em&gt;apoptosis&lt;/em&gt;, or programmed cell death. Apoptosis is most common when an organism needs to undergo a major change in form: for example, a tadpole losing its tail as it grows into a frog, or a stubby projection in a chick embryo being sculpted into a leg.&lt;/p&gt;

&lt;!-- This process is highly choreographed. For example, in the tail of a tadpole, each cell contains a sort of &quot;suicide capsule&quot; full of particular enzymes. When this capsule is broken at the appointed time, the enzymes are released to destroy the cell from the inside. --&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/apoptosis.jpg&quot; /&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;b&gt;Left.&lt;/b&gt; The metamorphosis of a tadpole into a frog is a spectacular example of apoptosis. Soon after the tadpole&apos;s tail reaches full size, the frog&apos;s back legs begin to grow and the tail rapidly shrinks. In the span of a few months it vanishes entirely. &lt;b&gt;Right.&lt;/b&gt; A blue dye that stains only dead cells is applied to a four-year-old chick embryo, revealing apoptosis in the wing and foot buds. These cells are programmed to die at an appointed time in order to shape the wings and feet of the newborn chick (see white circles). Even if these cells are moved to another part of the embryo, they still die at the appointed time. Photo credit: &lt;i&gt;Growth&lt;/i&gt; from the LIFE Science Library.
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;One of the best examples of apoptosis in the human body is &lt;a href=&quot;https://en.wikipedia.org/wiki/Bone_resorption&quot;&gt;&lt;em&gt;bone remodeling&lt;/em&gt;&lt;/a&gt;. This is the process by which bones grow, change shape, and even regrow after a fracture. It’s also a process by which the body manages the supply of important minerals and nutrients such as calcium. In the first year of life, bone resorption proceeds at an especially rapid pace. By the end of that year, almost 100% of the skeleton has been absorbed and replaced.&lt;/p&gt;

&lt;p&gt;Even in adults, about 10% of the skeleton is replaced every year.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:80%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/grow_bone.png&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;In this experiment, we trained an NCA model to grow into the shape of a slice of human bone. Since the bone starts its growth in the center of the image, but the center of the target image is empty, the NCA naturally learns a growth pattern that resembles apoptosis. Early in development, a small tan circle forms. The outside edge of this circle expands rapidly outward in a pattern of “bone growth” that would be carried out by &lt;a href=&quot;https://en.wikipedia.org/wiki/Osteoblast&quot;&gt;osteoblasts&lt;/a&gt; in nature. Meanwhile, the inside edge of the circle deteriorates at the same rate in a pattern of “bone resorption” associated with &lt;a href=&quot;https://en.wikipedia.org/wiki/Osteoclast&quot;&gt;osteoclasts&lt;/a&gt; in nature.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;bone_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/studying-growth/bone.png&quot;&gt;
      &lt;source src=&quot;/assets/studying-growth/bone.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;bone_video_button&quot; onclick=&quot;playPauseBone()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseBone() { 
  var video = document.getElementById(&quot;bone_video&quot;); 
  var button = document.getElementById(&quot;bone_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://colab.research.google.com/drive/1qQcztNsqyMLLMB00CVRxc0Pm7ipca0ww&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Growing&lt;/span&gt; a bone&lt;/a&gt;
&lt;/div&gt;

&lt;!-- We should note that the cells in this particular NCA don&apos;t exactly _die_. They simply turn white. In the future, we hope to grow images with alpha values below 0.1 in the interior.[^fn8] --&gt;

&lt;h3 id=&quot;4-speciation&quot;&gt;&lt;a href=&quot;https://colab.research.google.com/drive/1vG7yjOHxejdk_YfvKhASanNs0YvKDO5-&quot;&gt;4. Speciation&lt;/a&gt;&lt;/h3&gt;

&lt;p&gt;We have remarked that gnats and blue whales have more in common, at least in terms of cellular mechanics, than one would guess. They share many of the same cell structures, protiens, and even stages of development like &lt;a href=&quot;https://en.wikipedia.org/wiki/Gastrulation&quot;&gt;gastrulation&lt;/a&gt;. This points to the fact that many different organisms share the same cellular infrastructure. In more closely-related species, this observation is even more apt. For example, the three flowers we grew at the beginning of the article – the rose, the marigold, and the crocus – are all &lt;a href=&quot;https://en.wikipedia.org/wiki/Flowering_plant&quot;&gt;angiosperms&lt;/a&gt; and thus share structures like the &lt;a href=&quot;https://en.wikipedia.org/wiki/Xylem&quot;&gt;xylem&lt;/a&gt; and &lt;a href=&quot;https://en.wikipedia.org/wiki/Phloem&quot;&gt;phloem&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Indeed, one of the biggest differences between these flowers is their genetic code. Making an analogy to computers, you might say that they have the same hardware (cell mechanics), but different software (DNA).&lt;/p&gt;

&lt;p&gt;Our final experiment uses NCA to explore this idea. We run the same cellular dynamics (NCA neural network weights) across several flowers while varying the genetic information (initial state of the seed cell). Our training objective involved three separate targets: the rose, the marigold, and the crocus, each with its own trainable “seed state.” Early in training, our model produced blurry flower-like images with various mixtures of red, yellow, and purple. As training progressed, these images diverged from one another and began to resemble the three target images.&lt;/p&gt;

&lt;p&gt;Even though the final shapes diverge, you can still see shared features in the “embryonic” versions of the flowers. If you watch the video below, you can see that the three “embryos” all start out with red, yellow, and purple coloration. The developing crocus, in particular, has both red and purple petals during growth steps 10-20.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;seeds_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/studying-growth/seeds.png&quot;&gt;
      &lt;source src=&quot;/assets/studying-growth/seeds.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;seeds_video_button&quot; onclick=&quot;playPauseSeeds()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseSeeds() { 
  var video = document.getElementById(&quot;seeds_video&quot;); 
  var button = document.getElementById(&quot;seeds_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://colab.research.google.com/drive/1vG7yjOHxejdk_YfvKhASanNs0YvKDO5-&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Speciation&lt;/span&gt; with NCA&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;From a dynamical systems perspective, this NCA model has three different &lt;a href=&quot;http://www.scholarpedia.org/article/Basin_of_attraction&quot;&gt;&lt;em&gt;basins of attraction&lt;/em&gt;&lt;/a&gt;, one for each flower. The initial seed determines which basin the system ultimately converges to. In the future, it would be interesting to train a model that produces a wider variety of final organisms. Then we could use its “DNA” vectors to construct a “tree of life,” showing how closely-related various organisms are&lt;sup id=&quot;fnref:fn9&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn9&quot; class=&quot;footnote&quot;&gt;7&lt;/a&gt;&lt;/sup&gt; and at what point in training they split from a common ancestor.&lt;/p&gt;

&lt;h2 id=&quot;final-remarks&quot;&gt;Final remarks&lt;/h2&gt;

&lt;p&gt;There are a number of ways that NCA can contribute to civilization. The prospect of isolating the top one hundred signaling molecules used in natural morphogenesis, tracking their concentrations during growth in various tissues, and then training an NCA to reproduce the same growth patterns with the same morphogens is particularly exciting. This would allow us to obtain a complex model of biological morphogenesis with some degree of predictive power. Such a model could allow us to solve for the optimal cocktail of signaling molecules needed to speed up, slow down, or otherwise modify cell growth. It could even be used to adversarially slow down the growth of cancerous cells in a patient with cancer or artificially accelerate the growth of bone cells in a patient with osteoporosis.&lt;/p&gt;

&lt;p&gt;One of the themes of this post is that &lt;em&gt;patterns of growth are surprisingly similar&lt;/em&gt; across organisms. This hints at the fact that there are principles of growth that transcend biology. These principles can be studied in a computational substrate in a way that gives useful insights about the original biological systems. These insights, we believe, shine a new light on the everyday miracle of growth.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/studying-growth/ferns.jpeg&quot; /&gt;
&lt;/div&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;

&lt;!-- _Now two organisms are exactly alike. Each grows and develops in a unique fashion within the limits that its environment permits. Every species, however, has its own way of growing, and each has its own rate of growth. The range of variations is overwhelming. In as little as three months, for example, one of the grasses native to tropical Ceylon, a bamboo, may shoot up to a height of 120 feet, as tall as a 12-story building, by growing at an average rate of 16 inches a day. A eucalyptus native to Uganda has been known to grow 45 feet in two years, whereas dwarf ivy generally grows one inch a year. The majestic sequoia of California, which starts out as a seed weighing only one three-thousandth of an ounce, may end up 270 feet tall, with a base diameter of 40 feet and a weight estimated at 6,200 tons. It takes more than 1,000 years for the sequoia to achieve the feat of multiplying 600 billion times in mass._

_The animal kingdom, too, has its champions of growth. The blue whale, which cruises the oceans from the North to the South Pole, begins life as a barely visible egg weighing only a fraction of an ounce. At birth, it weighs from two to three tons. When it is weaned, at about seven months, it is 52 feet long and weighs 23 tons, having gained an average of 200 pounds a day. By the time it reaches maturity, in about 13 years, the blue whale is serious competition for many submarines. Then it may weight more than 85 tons and exceet 80 feet in length._ --&gt;

&lt;!-- 
Just as there is a shared but invisible structure -- based on Newtonian physics -- that underlies the motion of the planets or of a falling apple, so too there is shared structure to the growth rules of multicellular organisms. Of course, it&apos;s harder to reduce this structure to a clean set of equations than in physics. There are more exceptions and special cases. But since it reoccurs in diverse and unrelated biological organisms, there is good reason to believe that we can reproduce it in simulations of multicellular systems.
 --&gt;
&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn4&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;In fact, Conway’s Game of Life is Turing Complete; it can be used to simulate computations of arbitrary complexity. It can even be used to &lt;a href=&quot;https://twitter.com/AlanZucconi/status/1315967202797981696&quot;&gt;simulate itself&lt;/a&gt;. &lt;a href=&quot;#fnref:fn4&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Out only interference is to convert growin regions to mature regions and mature regions to frozen regions every 160 steps. This causes the system to move on to the next unit of growth. &lt;a href=&quot;#fnref:fn3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;And his student Hilde &lt;a href=&quot;#fnref:fn2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn5&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;“&lt;a href=&quot;https://www.nobelprize.org/prizes/medicine/1935/spemann/lecture/&quot;&gt;The Organizer-Effect in Embryonic Development&lt;/a&gt;,” Hans Spemann, Nobel Lecture, December 12, 1935 &lt;a href=&quot;#fnref:fn5&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn7&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;&lt;em&gt;Growth&lt;/em&gt;, p38. &lt;a href=&quot;#fnref:fn7&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn6&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;There’s probably an analogy to be made to fourier analysis where the spatial modes are reconstructed in order of their principal components. Like decompressing a .JPEG file. &lt;a href=&quot;#fnref:fn6&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn9&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;These “organisms” are actually &lt;em&gt;images of organisms&lt;/em&gt; in this context. &lt;a href=&quot;#fnref:fn9&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html">We train simulated cells to grow into organisms by communicating with their neighbors. Then we use them to study patterns of growth found in nature.</summary></entry><entry><title type="html">A Structural Optimization Tutorial</title><link href="http://greydanus.github.io/2022/05/08/structural-optimization/" rel="alternate" type="text/html" title="A Structural Optimization Tutorial" /><published>2022-05-08T04:00:00-07:00</published><updated>2022-05-08T04:00:00-07:00</updated><id>http://greydanus.github.io/2022/05/08/structural-optimization</id><content type="html" xml:base="http://greydanus.github.io/2022/05/08/structural-optimization/">&lt;style&gt;
.wrap {
    max-width: 900px;
}
p {
    font-family: sans-serif;
    font-size: 16.75px;
    font-weight: 300;
    overflow-wrap: break-word; /* allow wrapping of very very long strings, like txids */
}
.post pre,
.post code {
    background-color: #fafafa;
    font-size: 14px; /* make code smaller for this post... */
}
pre {
 white-space: pre-wrap;       /* css-3 */
 white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
 white-space: -pre-wrap;      /* Opera 4-6 */
 white-space: -o-pre-wrap;    /* Opera 7 */
 word-wrap: break-word;       /* Internet Explorer 5.5+ */
}
&lt;/style&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;hero_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/structural-optimization/causeway.png&quot;&gt;
      &lt;source src=&quot;/assets/structural-optimization/causeway.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;hero_video_button&quot; onclick=&quot;playPauseHero()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
  &lt;div style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;&lt;b&gt;Causeway bridge.&lt;/b&gt; When you play the video, you&apos;ll notice that initially the matter is evenly distributed over the design space. From there, we iteratively move it around so as to create a structure that optimally supports a set of forces and fixed points (not shown). The result is a causeway bridge design.&lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseHero() { 
  var video = document.getElementById(&quot;hero_video&quot;); 
  var button = document.getElementById(&quot;hero_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right:auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://twitter.com/samgreydanus/status/1524020782053134342&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Twitter thread&lt;/a&gt;
    &lt;a href=&quot;https://arxiv.org/abs/2205.08966&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;PDF version&lt;/a&gt;
  &lt;a href=&quot;https://bit.ly/394DUcL&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Run&lt;/span&gt; in browser&lt;/a&gt;
  &lt;a href=&quot;https://github.com/greydanus/structural_optimization&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Get the code&lt;/a&gt;
&lt;/div&gt;

&lt;!-- In modern cities, the least expensive structural designs tend to have blocky and inorganic shapes. Buildings such as warehouses and shopping malls follow these patterns. In contrast, buildings which are meant to have spiritual or aesthetic appeal -- buildings like churches, museums, and sports stadiums -- tend to have more organic-looking features like arches, spires, and scaffolds.

Although the tradeoff between cost and aesthetic appeal is as old as time, it has grown sharper in the modern era. Thanks to large-scale, mass-production building techniques, a Walmart in one city now looks exactly like a Walmart in the next.

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; text-align:center; width:100%&quot; &gt;
    &lt;img src=&quot;/assets/structural-optimization/reno.png&quot; style=&quot;width:49%; min-width:350px&quot;&gt;
    &lt;img src=&quot;/assets/structural-optimization/amsterdam.png&quot; style=&quot;width:49%; min-width:350px&quot;&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt; Google Earth snapshots of the city centers of Reno and Amsterdam. The first, of Reno, is dominated by large rectlinear buildings, roads, and parking lots. The second, of Amsterdam, features a wider variety of shapes and textures.&lt;/div&gt;
&lt;/div&gt;

Even so, modern technology is not _intrinsically limited_ to enabling mass production and enforcing uniformity. Certain technological tools can actually help to reduce the uniformity of the manmade environment and make it more inviting to the thoughtful pedestrian. One such tool is structural optimization.

**Structural optimization.** Structural optimization permits us to express the constraints of structural design problems in general terms and then find organic-looking solutions to those problems in an open-ended manner. Just as no two trees are the same, no two structural optimization designs are either.

There are a number of companies that provide structural optimization services, but they do not open-source their code. Indeed, their code is often complex and highly technical. Academic researchers have produced a few [high-quality tutorials](http://www.topopt.mek.dtu.dk/Apps-and-software/Efficient-topology-optimization-in-MATLAB) on the topic, but these tutorials are now a few decades old. Most of them, although well written, are aimed at readers with substantial domain knowledge. They obscure the fact that structural optimization is really quite simple, elegant, and easy to implement.

With that in mind, let&apos;s write our own structural optimization code, from scratch, in 180 lines. --&gt;

&lt;!-- ```python
import time
import numpy as np                                                # for dense matrix ops
import matplotlib.pyplot as plt                                   # for plotting
import autograd, autograd.core, autograd.extend, autograd.tracer  # for computing adjoints
import autograd.numpy as anp      
import scipy, scipy.ndimage, scipy.sparse, scipy.sparse.linalg    # mostly for sparse matrix ops

!pip install nlopt
import nlopt                                                      # for optimization
```
&lt;pre class=&apos;outputarea&apos;&gt;
Collecting nlopt
  Downloading nlopt-2.7.1-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (424 kB)
     |████████████████████████████████| 424 kB 5.1 MB/s 
Requirement already satisfied: numpy&gt;=1.14 in /usr/local/lib/python3.7/dist-packages (from nlopt) (1.21.6)
Installing collected packages: nlopt
Successfully installed nlopt-2.7.1
&lt;/pre&gt; --&gt;

&lt;p&gt;Structural optimization is a useful and interesting tool. Unfortunately, it can be hard to get started on the topic because existing tutorials assume the reader has substantial domain knowledge. They obscure the fact that structural optimization is really quite simple, elegant, and easy to implement.&lt;/p&gt;

&lt;p&gt;With that in mind, let’s write our own structural optimization code, from scratch, in 180 lines.&lt;/p&gt;

&lt;h2 id=&quot;problem-setup&quot;&gt;Problem setup&lt;/h2&gt;
&lt;p&gt;The goal of structural optimization is to place material in a design space so that it rests on some fixed points or “normals” and resists a set of applied forces or &lt;em&gt;loads&lt;/em&gt; as efficiently as possible. To see how we might set this up, let’s start with a beam design problem from &lt;a href=&quot;https://www.topopt.mek.dtu.dk/-/media/subsites/topopt/apps/dokumenter-og-filer-til-apps/topopt88.pdf?la=da&amp;amp;hash=E80FAB2808804A29FFB181CA05D2EEFECAA86686&quot;&gt;Andreassen et al (2010)&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:50%; min-width:300px;&quot;&gt;
  &lt;img src=&quot;/assets/structural-optimization/stopt_mbb_setup.png&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;The large gray rectangle here represents the design space. We are going to enforce symmetry by optimizing half of the beam and then mirroring the result around the left wall. This means that the center of the beam is actually on the left side of the diagram. This is where the load force, denoted by the downwards-pointing arrow, is being applied. There are horizontally fixed points here as well. They represent forces transmitted to this half of the beam from its other half. Meanwhile, the vertically fixed point at the bottom right corner of the design space corresponds to a normal force from some external support, perhaps the top of a wall.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Finite elements.&lt;/strong&gt; Although the physics of elastic materials is continuous, our computer can only work with discrete approximations. This means that we have to cut the design space up into a discrete number of regions or &lt;em&gt;finite elements&lt;/em&gt; which, when allowed to interact, reproduce the behavior of an elastic solid as realistically as possible. We can link their boundaries together with a set of nodes and allow these nodes to interact with one another as though connected by springs. This way, whenever a force is applied to one node, it transmits a fraction of that force on to all the other nodes in the structure, causing each to move a small amount and, in doing so, deform the finite elements. As this happens, the entire structure deforms as though it were an elastic solid.&lt;/p&gt;

&lt;p&gt;There are many ways to choose the arrangement of these finite elements. The simplest one is to make them square and organize them on a rectangular grid.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:50%; min-width:300px;&quot;&gt;
  &lt;img src=&quot;/assets/structural-optimization/stopt_design_domain.png&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;In the diagram above, there are 12 elements with four nodes per element and two degrees of freedom (DOFs) per node. The first is horizontal and the second is vertical. The numbering scheme proceeds columnwise from left to right so that the horizontal and vertical displacements of node \(n\) are given by DOFs \(2n-1\) and \(2n\) respectively. As the authors point out, this grid structure is useful because it can be exploited “…in order to reduce the computational effort in the optimization loop…” It also simplifies the code.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Python representations.&lt;/strong&gt; Given this problem setup, every DOF in our design space can either have a force applied to it or be fixed by a normal force. For a design space that is \(y\) units high and \(x\) units wide, we can represent these parts of the problem setup with NumPy arrays called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;forces&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;normals&lt;/code&gt;, each of shape \((y+1,x+1,2)\). Here the first two axes index over all the nodes in the design space and the third axis indexes over the two DOFs available to each node. Starting with the code below – and continuing throughout the rest of this tutorial – we are going to flatten these arrays to one dimension.&lt;/p&gt;

&lt;p&gt;There are a few other important details. The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mask&lt;/code&gt; variable can be either a scalar of value 1 (no mask) or an array of shape \((x,y)\). As a default, we will use no mask. Then there are all the material constants, constraints, filter widths, and so forth to consider. For these, we use the values reported by &lt;a href=&quot;https://www.topopt.mek.dtu.dk/-/media/subsites/topopt/apps/dokumenter-og-filer-til-apps/topopt88.pdf?la=da&amp;amp;hash=E80FAB2808804A29FFB181CA05D2EEFECAA86686&quot;&gt;Andreassen et al. (2010)&lt;/a&gt;. Finally, we have the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mbb_beam&lt;/code&gt; function which sets up the forces and normals particular to the MBB beam design constraints. This function can easily be swapped out if we wish to design a structure with different constraints.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ObjectView&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;__init__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;__dict__&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;
    
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get_args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# Manage the problem setup parameters
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;flatnonzero&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ravel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;alldofs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arange&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;alldofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;params&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# material properties
&lt;/span&gt;      &lt;span class=&quot;s&quot;&gt;&apos;young&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;young_min&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1e-9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;poisson&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;g&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# constraints
&lt;/span&gt;      &lt;span class=&quot;s&quot;&gt;&apos;density&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;xmin&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.001&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;xmax&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# input parameters
&lt;/span&gt;      &lt;span class=&quot;s&quot;&gt;&apos;nelx&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;nely&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;mask&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;penal&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;3.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;filter_width&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;&apos;freedofs&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;fixdofs&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;forces&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ravel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# optimization parameters
&lt;/span&gt;      &lt;span class=&quot;s&quot;&gt;&apos;opt_steps&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;print_every&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ObjectView&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;mbb_beam&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# textbook beam example
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width:300px;&quot;&gt;
  &lt;img src=&quot;/assets/structural-optimization/setup.png&quot; /&gt;
    &lt;div style=&quot;text-align:center; display:block; margin-left: auto; margin-right: auto; width:75%&quot;&gt;Visualizing the normals and forces in the MBB beam setup. Here the rectangle represents the design area and the colored pixels represent matrix entries (blue = -1, green = 0, and yellow = 1).&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;The density method.&lt;/strong&gt; Now that we have parameterized the design space, it is time to parameterize the material that moves around on it. At a high level, each finite element is going to have a certain density of material, given by some number between 0 and 1. We will use this density to determine the element stiffness coefficient \(E_e\), also called Young’s modulus. In the nodes-connected-by-springs analogy, this coefficient would control all the spring constants.&lt;/p&gt;

&lt;p&gt;Let’s discuss how to choose the mapping between finite element density \(x_e\) and Young’s modulus in more detail. First of all, we’d like to avoid having any elements with zero stiffness. When this happens, they stop transmitting forces to their neighbors before optimization is complete and we are liable to end up with suboptimal solutions. We can prevent this by giving each finite element a baseline stiffness, \(E_{min}\), regardless of whether it has any material density.&lt;/p&gt;

&lt;p&gt;We’d also like black-and-white final solutions. In other words, although our design space may start out with material densities of 0.5, by the end of optimization we’d like all of the grid cells to have densities very close to either 0 or 1. We can ensure this happens by raising our densities to a power \(p\) greater than one (typically \(p=3\)) so as to make our structure’s stiffness more sensitive to small changes in density.&lt;/p&gt;

&lt;p&gt;Putting these ideas together, we obtain the “modified SIMP” equation from &lt;a href=&quot;https://www.topopt.mek.dtu.dk/-/media/subsites/topopt/apps/dokumenter-og-filer-til-apps/topopt88.pdf?la=da&amp;amp;hash=E80FAB2808804A29FFB181CA05D2EEFECAA86686&quot;&gt;Andreasson et al. (2010)&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&lt;span id=&quot;longEqnWithSmallScript_A&quot; style=&quot;display:block; margin-left:auto;margin-right:auto;text-align:center;&quot;&gt;
\(\begin{align}
E_e(x_e)=&amp;amp;E_{min} + x^p_e(E_0-E_{min}) \\
&amp;amp; x_e \in [0,1]
\end{align}\)
&lt;/span&gt;
&lt;span id=&quot;longEqnWithLargeScript_A&quot; style=&quot;display:block; margin-left:auto;margin-right:auto;text-align:center;&quot;&gt;
\(E_e(x_e)=E_{min} + x^p_e(E_0-E_{min}), \quad \quad x_e \in [0,1]\)
&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Here \(E_0\) is the stiffness of the material. For a comparison between modified SIMP and other approaches, see &lt;a href=&quot;https://www.sciencedirect.com/science/article/abs/pii/S0045782506003252&quot;&gt;Sigmund (2007)&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Filtering.&lt;/strong&gt; Finally, in order to avoid grid-level pathologies (especially scenarios where a grid element with full density ends up next to a grid element with zero density and a discontinuity occurs), we are going to use a 2D Gaussian filter&lt;sup id=&quot;fnref:fn1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn1&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; to smooth the grid densities. This technique, called “&lt;a href=&quot;https://en.wikipedia.org/wiki/Filter_(large_eddy_simulation)&quot;&gt;filtering&lt;/a&gt;,” shows up in almost all physics simulations where continuous fields have to be discretized.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;young_modulus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_min&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e_0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;physical_density&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;volume_contraint&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;use_filter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nelx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# reshape from 1D to 2D
&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gaussian_filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filter_width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;use_filter&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# maybe filter
&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;mean_density&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;volume_contraint&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;use_filter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;physical_density&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;volume_contraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;use_filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point, we have constructed a finite element parameterization of an elastic solid. We are applying forces to this solid in some places and supporting it with fixed points in others. As it deforms, it stretches and compresses in proportion to the stiffness of its finite elements. Now the question we need to ask is: &lt;em&gt;what does the best structure look like under these conditions?&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;the-objective-function&quot;&gt;The objective function&lt;/h2&gt;

&lt;p&gt;At a high level, the best structure is the one that minimizes the elastic potential energy or &lt;a href=&quot;https://en.wikipedia.org/wiki/Topology_optimization#Structural_compliance&quot;&gt;&lt;em&gt;compliance&lt;/em&gt;&lt;/a&gt; of the 2D grid of springs. We can express this idea mathematically as follows:&lt;/p&gt;

&lt;p&gt;&lt;span id=&quot;longEqnWithSmallScript_B&quot; style=&quot;display:block; margin-left:auto;margin-right:auto;text-align:center;&quot;&gt;
\(\begin{align}
\scriptstyle \underset{\mathbf{x}}{\textrm{min}}: &amp;amp; \quad \scriptstyle c(\mathbf{x}) ~~=~~ \mathbf{U}^T\mathbf{K}\mathbf{U} ~~=~~ \sum_{e=1}^NE_e(x_e)\mathbf{u}_e^T\mathbf{k}_0\mathbf{u}_e \\
\scriptstyle \textrm{subject to}: &amp;amp; \quad \scriptstyle V(\mathbf{x})/V_0 = f \\
\scriptstyle &amp;amp; \quad \scriptstyle 0 \leq \mathbf{x} \leq 1 \\
\scriptstyle &amp;amp; \quad \scriptstyle \mathbf{KU=F} \\
\end{align}\)
&lt;/span&gt;
&lt;span id=&quot;longEqnWithLargeScript_B&quot; style=&quot;display:block; margin-left:auto;margin-right:auto;text-align:center;&quot;&gt;
\(\begin{align}
\scriptstyle \underset{\mathbf{x}}{\textrm{min}}: &amp;amp; \quad \scriptstyle c(\mathbf{x}) ~~=~~ \mathbf{U}^T\mathbf{K}\mathbf{U} ~~=~~ \sum_{e=1}^NE_e(x_e)\mathbf{u}_e^T\mathbf{k}_0\mathbf{u}_e \qquad \textrm{Potential energy (compliance) of a 2D grid of springs} \\
\scriptstyle \textrm{subject to}: &amp;amp; \quad \scriptstyle V(\mathbf{x})/V_0 = f \qquad \quad ~ \textrm{A fixed quantity of material} \\
\scriptstyle &amp;amp; \quad \scriptstyle 0 \leq \mathbf{x} \leq 1 \qquad \qquad \textrm{Densities that remain between 0 and 1} \\
\scriptstyle &amp;amp; \quad \scriptstyle \mathbf{KU=F}  \qquad \qquad \textrm{Hooke&apos;s law for a 2D grid of springs} \\
\end{align}\)
&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Here \(c\) is the compliance, \(\mathbf{x}\) is a vector containing the material densities of the elements, \(\mathbf{K}\) is the global stiffness matrix, \(\mathbf{U}\) is a vector containing the displacements of the nodes, and \(E_e\) is Young’s modulus. The external forces or “loads” are given by the vector \(\mathbf{F}\).&lt;/p&gt;

&lt;p&gt;We can write the core part of this objective, the part that says \(c(\mathbf{x})=\mathbf{U}^T\mathbf{K}\mathbf{U}\), as a high-level objective function that calls a series of subroutines.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;objective&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;volume_contraint&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;use_filter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;kwargs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;dict&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;penal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;penal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_min&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;young_min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;young&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x_phys&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;physical_density&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;volume_contraint&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;volume_contraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;use_filter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;use_filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_stiffness_matrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;young&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;poisson&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# stiffness matrix
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;displace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x_phys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kwargs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;compliance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x_phys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kwargs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;computing-sensitivities&quot;&gt;Computing sensitivities&lt;/h2&gt;
&lt;p&gt;The objective function gives us a single number, \(c(\mathbf{x})\), which we can use to rate the quality of our structure. But the question remains: &lt;em&gt;how should we update \(\mathbf{x}\) so as to minimize this number?&lt;/em&gt; To answer this question, we need to compute the gradients or &lt;em&gt;sensitivities&lt;/em&gt; of \(c\) with respect to \(\mathbf{x}\). These sensitivities will give us the direction to move \(\mathbf{x}\) in order to decrease \(c\) as much as possible. Ignoring filtering for a moment and applying the chain rule to the first line of the objective function, we obtain&lt;/p&gt;

\[\begin{align}
\frac{\partial c}{\partial x_e} &amp;amp;= -px_e^{p-1}(E_0-E_{min})\mathbf{u}_e^T\mathbf{k}_0\mathbf{u}
\end{align}\]

&lt;p&gt;If we want to add filtering back in, the notation becomes a bit more complicated. But we’re not going to do that here because, actually, we don’t need to calculate these sensitivities by hand. There is an elegant little library called &lt;a href=&quot;https://github.com/HIPS/autograd&quot;&gt;Autograd&lt;/a&gt; which can do this for us using a process called &lt;a href=&quot;https://en.wikipedia.org/wiki/Automatic_differentiation&quot;&gt;&lt;em&gt;automatic differentiation&lt;/em&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Custom gradients.&lt;/strong&gt; There are a few cases where we need to operate on NumPy arrays with functions from other libraries. In these cases, we need to define a custom gradient function so that Autograd knows how to differentiate through them. For example, in the code we have already written, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gaussian_filter&lt;/code&gt; function comes from the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;scipy&lt;/code&gt; library. Here’s how we can wrap that function to make it work properly with Autograd:&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;autograd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;extend&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;primitive&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;gaussian_filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 2D gaussian blur/filter
&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scipy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndimage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gaussian_filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;reflect&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;_gaussian_filter_vjp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# gives the gradient of orig. function w.r.t. x
&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;del&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# unused
&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;lambda&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gaussian_filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;autograd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;extend&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;defvjp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gaussian_filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_gaussian_filter_vjp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;implementing-the-physics&quot;&gt;Implementing the physics&lt;/h2&gt;
&lt;p&gt;In between \(\mathbf{x}\) and \(c(\mathbf{x})\), there are a series of physics functions that we still need to implement.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Compliance.&lt;/strong&gt; At a high level, the compliance is just \(\mathbf{U}^T\mathbf{K}\mathbf{U}\). But \(\mathbf{U}\) and \(\mathbf{K}\) are very sparse so it’s much more efficient to calculate \(\sum_{e=1}^NE_e(x_e)\mathbf{u}_e^T\mathbf{k}_0\mathbf{u}_e\). That’s what we will do in the code below. It’s a little hard to follow because everything is vectorized (hence the einsums) but this does speed things up considerably compared to a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;for&lt;/code&gt; loop.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;The element stiffness matrix.&lt;/strong&gt; The variable \(\mathbf{k}_0\) that appears in the compliance calculation is called the element stiffness matrix. An intuitive way to think about this matrix is as a 2D analogue of the spring constant \(k\) in a simple harmonic oscillator. The reason it is a matrix (instead of a scalar or a vector) is that we need to take into account all of the various interaction terms between the corner nodes in a square finite element.&lt;sup id=&quot;fnref:fn2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn2&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; When we represent the displacement of all these nodes with a vector \(u=[u^a_1,u^a_2,u^b_1,u^b_2,u^c_1,u^c_2,u^d_1,u^d_2]\), then it becomes easy to calculate the potential energy of the system: we just write \(PE = \frac{1}{2}u^Tk_0u\) (this is the 2D analogue to the potential energy of a 1D harmonic oscillator, which is written as \(\frac{1}{2}kx^2\)).&lt;/p&gt;

&lt;p&gt;From this you should be able to see why compliance is the potential energy of the entire structure: it’s just a sum over the potential energies of all the finite elements. You should note that each term in the sum is getting scaled by a factor of \(E_e(x_e)\). This is happening because the stiffness matrix varies with Young’s modulus, and we have made Young’s modulus dependent on the local material density.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Material constants.&lt;/strong&gt; You’ll notice that two material constants appear in the element stiffness matrix. The first is &lt;a href=&quot;https://en.wikipedia.org/wiki/Young%27s_modulus&quot;&gt;Young’s modulus&lt;/a&gt; which measures the stiffness of a material. Intuitively, it is the distortion per unit of force (“How hard do you need to pull a rubber band to stretch it one inch?”). A more technical definition is &lt;em&gt;the ratio of tensile stress to tensile strain&lt;/em&gt;. The &lt;a href=&quot;https://en.wikipedia.org/wiki/Poisson%27s_ratio&quot;&gt;Poisson coefficient&lt;/a&gt;, meanwhile, measures the amount of contraction in the direction perpendicular to a region of stretching, due to that stretching (“How much thinner does the rubber band get when you stretch it one inch?”). A technical definition is &lt;em&gt;the ratio between the lateral contraction per unit length and the longitudinal extension also per unit length.&lt;/em&gt; Both of these coefficients come into play when we construct the element stiffness matrix.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;compliance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x_phys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;penal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_min&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1e-9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nelx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x_phys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;meshgrid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nelx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# x, y coords for the index map
&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;n1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# nodes
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;n2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;n3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;n4&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;all_ixs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;u_selected&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;all_ixs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# select from u matrix
&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ke_u&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;einsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;ij,jkl-&amp;gt;ikl&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u_selected&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# compute x^penal * U.T @ ke @ U
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;ce&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;einsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;ijk,ijk-&amp;gt;jk&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u_selected&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ke_u&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;C&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;young_modulus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x_phys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;penal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;C&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get_stiffness_matrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# e=young&apos;s modulus, nu=poisson coefficient
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt;
                               &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt;
                               &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt;
                               &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt;
                               &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt;
                               &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt;
                               &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt;
                               &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Calculating displacements.&lt;/strong&gt; Now we need to tackle one of the most important physics problems: calculating the displacements of the nodes. The way to do this with a 1D spring would be to solve the equation \(F=kx\) for \(x\). Here we can do the same thing, except by solving the matrix equation \(\mathbf{F=KU}\). For a system with \(N\) nodes with 2 degrees of freedom each, the matrix \(\mathbf{K}\) will have dimensions \(2N\) x \(2N\). This gives us a system of \(2N\) simultaneous linear equations for \(2N\) unknown node displacements.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;A global stiffness matrix with \(N\) nodes.&lt;/strong&gt; The number of nodes  \(N\) grows as the product of the width and height of our design space. Thus it is not unusual to have over \(10^4\) nodes in a design space. Since the size of  \(\mathbf{K}\) grows as \(N^2\), it quickly becomes too large to fit in memory. For example, using \(10^4\) nodes and the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data format, we get a \(\mathbf{K}\) matrix that consumes 1.6 GB of RAM. Increasing its width and height by 50% increases that number to 8 GB. This is not a sustainable rate of growth!&lt;/p&gt;

&lt;p&gt;Luckily, since our nodes are locally-connected, most of the entries in \(\mathbf{K}\) are zero. We can save a vast amount of memory by representing it with a sparse “coordinate list” or COO format. The purpose of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;get_k&lt;/code&gt; function below is to assemble just such a matrix. If you want to see all the details for how this matrix is constructed, read the “global stiffness matrices with \(N\) nodes” section of &lt;a href=&quot;http://solidmechanics.org/text/Chapter7_2/Chapter7_2.htm&quot;&gt;this textbook chapter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;The sparse matrix solve.&lt;/strong&gt; Having constructed \(\mathbf{K}\), all we have left to do is solve the system of equations. This is the most important part of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;displace&lt;/code&gt; function. It uses Scipy’s SuperLU function (which supports COO) to solve for nodal displacements without ever instantiating a \(2N\) x \(2N\) matrix.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get_k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stiffness&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Constructs sparse stiffness matrix k (used in the displace fn)
&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# First, get position of the nodes of each element in the stiffness matrix
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nelx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stiffness&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;meshgrid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nelx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# x, y coords
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;n1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;n2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;n3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;n4&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ely&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;edof&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;edof&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x_list&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;repeat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# flat list pointer of each node in an element
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;y_list&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;flatten&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# flat list pointer of each node in elem
&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# make the global stiffness matrix K
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;kd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stiffness&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nelx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;value_list&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;flatten&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value_list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x_list&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;displace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x_phys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;penal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_min&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1e-9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Displaces the load x using finite element techniques (solve_coo=most of runtime)
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;stiffness&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;young_modulus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x_phys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e_min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;penal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;k_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k_ylist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k_xlist&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stiffness&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;index_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;keep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_get_dof_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k_ylist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k_xlist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  
  &lt;span class=&quot;n&quot;&gt;u_nonzero&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solve_coo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;keep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sym_pos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;u_values&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;concatenate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;u_nonzero&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))])&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u_values&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;index_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;sparse-matrix-helper-functions&quot;&gt;Sparse matrix helper functions&lt;/h2&gt;

&lt;p&gt;You may notice that the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;displace&lt;/code&gt; function uses a helper function, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_get_dof_indices&lt;/code&gt;, to update \(\mathbf{K}\)’s indices. The point here is to keep only the degrees of freedom that were actually free in the problem setup (the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;freedofs&lt;/code&gt;). To do this, we need to remove the degrees of freedom where normal forces were introduced (the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fixdofs&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;The second function is the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;inverse_permutation&lt;/code&gt; function. It is a &lt;a href=&quot;https://mathworld.wolfram.com/InversePermutation.html&quot;&gt;mathematical operation&lt;/a&gt; that gives us the indices needed to undo a permutation. For example, if &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ixs&lt;/code&gt; is a list of indices that permutes the list &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A&lt;/code&gt;, then this function gives us a second list of indices &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;inv_ixs&lt;/code&gt; such that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;A[ixs][inv_ixs] = A&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;_get_dof_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k_xlist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k_ylist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;index_map&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inverse_permutation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;concatenate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fixdofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;keep&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k_xlist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k_ylist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;freedofs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Now we index an indexing array that is being indexed by the indices of k
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k_ylist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;keep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k_xlist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;keep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;keep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stack&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;inverse_permutation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# reverses an index operation
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;inverse_perm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;int64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;inverse_perm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arange&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;int64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;inverse_perm&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Custom gradients for a sparse matrix solve.&lt;/strong&gt; Our sparse solve, like our 2D Gaussian filter, comes from the Scipy library and is not supported by Autograd. So we need to tell Autograd how to differentiate through it. To do this, we’ll copy a few lines of code from &lt;a href=&quot;https://github.com/google-research/neural-structural-optimization/blob/1c11b8c6ef50274802a84cf1a244735c3ed9394d/neural_structural_optimization/autograd_lib.py#L188&quot;&gt;this Google Research repo&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;These lines are similar to &lt;a href=&quot;https://github.com/HIPS/autograd/blob/96a03f44da43cd7044c61ac945c483955deba957/autograd/numpy/linalg.py#L40&quot;&gt;Autograd’s implementation&lt;/a&gt; of the gradient of a matrix solve. The main difference is that whereas the Autograd version is written for dense matrices, this version is written for sparse matrices. The underlying mathematical idea is the same either way; see “&lt;a href=&quot;https://people.maths.ox.ac.uk/gilesm/files/NA-08-01.pdf&quot;&gt;An extended collection of matrix derivative results for forward and reverse mode algorithmic differentiation&lt;/a&gt;” by Mike Giles for the relevant formulas.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;_get_solver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sym_pos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# a is (usu.) symmetric positive; could solve 2x faster w/sksparse.cholmod.cholesky(a).solve_A
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scipy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sparse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;coo_matrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tocsc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scipy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sparse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;linalg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;splu&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;solve&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;autograd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;primitive&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;solve_coo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sym_pos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_get_solver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sym_pos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;grad_solve_coo_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sym_pos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;jvp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grad_ans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;lambda_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solve_coo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_indices&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sym_pos&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;grad_ans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sym_pos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a_indices&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lambda_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jvp&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;autograd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;extend&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;defvjp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;solve_coo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grad_solve_coo_entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                       &lt;span class=&quot;k&quot;&gt;lambda&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;err: gradient undefined&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                       &lt;span class=&quot;k&quot;&gt;lambda&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;err: gradient not implemented&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And with that, we are done with the physics! Now we are ready to set up the optimization itself.&lt;/p&gt;

&lt;h2 id=&quot;optimization&quot;&gt;Optimization&lt;/h2&gt;
&lt;p&gt;To do this, we’ll use the Method of Moving Asymptotes (MMA). Originally described by &lt;a href=&quot;https://scholar.google.com/scholar?q=the+method+of+moving+asymptotes%E2%80%94a+new+method&quot;&gt;Svanberg (1987)&lt;/a&gt; and refined in &lt;a href=&quot;https://scholar.google.com/scholar?hl=en&amp;amp;as_sdt=0%2C38&amp;amp;q=A+class+of+globally+convergent+optimization+methods&quot;&gt;Svanberg (2002)&lt;/a&gt;, MMA is a good fit for structural optimization problems because it accepts nonlinear inequality constraints and scales to large parameter spaces. In the code below, we rewrite the mass conservation constraint as a mass &lt;em&gt;threshold&lt;/em&gt; constraint so that it looks like an inequality. Then we set the density constraint by giving upper and lower bounds on the parameter space. Finally, we use Autograd to obtain gradients with respect to the objective and pass them to the solver. The &lt;a href=&quot;https://nlopt.readthedocs.io/en/latest/&quot;&gt;NLopt package&lt;/a&gt; makes this process pretty straightforward. Also, its &lt;a href=&quot;https://nlopt.readthedocs.io/en/latest/NLopt_Algorithms/#mma-method-of-moving-asymptotes-and-ccsa&quot;&gt;documentation&lt;/a&gt; gives some good practical advice on how to think about MMA.&lt;/p&gt;

&lt;p&gt;Other optimization approaches we tried included the optimality criteria (by &lt;a href=&quot;https://www.topopt.mek.dtu.dk/-/media/subsites/topopt/apps/dokumenter-og-filer-til-apps/topopt88.pdf?la=da&amp;amp;hash=E80FAB2808804A29FFB181CA05D2EEFECAA86686&quot;&gt;Andreasson et al. 2010&lt;/a&gt;), plain gradient descent, &lt;a href=&quot;https://en.wikipedia.org/wiki/Limited-memory_BFGS&quot;&gt;L-BFGS&lt;/a&gt;, and the &lt;a href=&quot;https://scholar.google.com/scholar?hl=en&amp;amp;as_sdt=0%2C38&amp;amp;q=adam+optimizer+kingma&amp;amp;oq=adam+optimizer+&quot;&gt;Adam optimizer&lt;/a&gt;. Consistent with the findings of &lt;a href=&quot;https://arxiv.org/abs/1909.04240&quot;&gt;this paper&lt;/a&gt;, MMA outperformed all these approaches.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fast_stopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;anp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ones&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nelx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# init mass
&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;lambda&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nely&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nelx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;objective_fn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;lambda&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objective&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# don&apos;t enforce mass constraint here
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;constraint&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;lambda&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mean_density&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;wrap_autograd_func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;wrapper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[:]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;autograd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value_and_grad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;print_every&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;step {}, loss {:.2e}, t={:.2f}s&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wrapper&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;Optimizing a problem with {} nodes&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;opt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nlopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nlopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LD_MMA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;opt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;set_lower_bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;set_upper_bounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;opt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;set_min_objective&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wrap_autograd_func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;objective_fn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;opt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;add_inequality_constraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wrap_autograd_func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;constraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1e-8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;opt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;set_maxeval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opt_steps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;opt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;optimize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;flatten&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reshape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;we-are-finally-ready-to-optimize-our-mbb-beam&quot;&gt;We are finally ready to optimize our MBB beam&lt;/h2&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;c1&quot;&gt;# run the simulation and visualize the result
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mbb_beam&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fast_stopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;plt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;figure&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dpi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;Final design space:&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;plt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;imshow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;show&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;plt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;figure&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dpi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;Final MBB beam design:&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;plt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;imshow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;concatenate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[:,::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;axis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;show&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;pre class=&quot;outputarea&quot;&gt;
Optimizing a problem with 4212 nodes
step 10, loss 1.28e+03, t=1.31s
step 20, loss 5.38e+02, t=2.51s
step 30, loss 4.17e+02, t=3.92s
step 40, loss 3.67e+02, t=5.36s
step 50, loss 3.61e+02, t=6.84s
step 60, loss 3.58e+02, t=8.30s
step 70, loss 3.55e+02, t=9.67s
step 80, loss 3.44e+02, t=10.79s

Final design space:
&lt;img src=&quot;/assets/structural-optimization/mbb1.png&quot; align=&quot;left&quot; /&gt;





Final MBB beam design:
&lt;img src=&quot;/assets/structural-optimization/mbb2.png&quot; align=&quot;left&quot; /&gt;
&lt;/pre&gt;

&lt;h2 id=&quot;optimizing-the-eves-of-a-gazebo-roof&quot;&gt;Optimizing the eves of a gazebo roof&lt;/h2&gt;
&lt;p&gt;Let’s turn to a slightly more challenging and interesting task. This is a design problem that came up recently at the engineering firm where I work. It consists of a gazebo roof that is 16’ wide and 4’ high (with a 2:1 pitch). The fixed points include the bottom region, where a large beam runs as well as a vertical center beam.&lt;/p&gt;

&lt;p&gt;The dead load for the structure is 12-17 pounds per square foot (psf), the live load is 25 psf, snow load is 10 psf, wind load ranges from 10 psf downward to 4 psf upwards. Combining the vertical and horizontal forces with one another and estimating the worst-case net force on the roof, we obtain a vector with a magnitude that is 20 degrees (0.349 radians) off of the vertical. Putting all this together, we have a structural optimization problem which can be solved to obtain a support strucure for the roof.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;eves&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;theta&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=-&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.349&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# theta is the angle (rad) between vertical and the net force on the roof
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[:,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;start_coords&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stop_coords&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;skimage.draw&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;skimage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line_aa&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_coords&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stop_coords&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;theta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;minimum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;theta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;minimum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# run the simulation and visualize the result
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eves&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fast_stopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;pre class=&quot;outputarea&quot;&gt;
Optimizing a problem with 66306 nodes
step 10, loss 1.01e+02, t=34.68s
step 20, loss 7.87e+00, t=69.54s
step 30, loss 3.05e+00, t=104.69s
step 40, loss 2.68e+00, t=138.80s
step 50, loss 2.53e+00, t=173.08s
step 60, loss 2.48e+00, t=206.53s
step 70, loss 2.47e+00, t=240.59s
step 80, loss 2.47e+00, t=278.73s
step 90, loss 2.46e+00, t=312.37s
step 100, loss 2.46e+00, t=347.35s
&lt;/pre&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:70%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;eves_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/structural-optimization/eves.png&quot;&gt;
      &lt;source src=&quot;/assets/structural-optimization/eves.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;eves_video_button&quot; onclick=&quot;playPauseEves()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseEves() { 
  var video = document.getElementById(&quot;eves_video&quot;); 
  var button = document.getElementById(&quot;eves_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;h2 id=&quot;a-few-other-designs&quot;&gt;A few other designs&lt;/h2&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;causeway_bridge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;128&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;128&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.08&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;deck_level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;A bridge supported by columns at a regular interval.&quot;&quot;&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[:,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;deck_level&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# run the simulation and visualize the result
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;causeway_bridge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opt_steps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;160&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;print_every&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fast_stopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;pre class=&quot;outputarea&quot;&gt;
Optimizing a problem with 33282 nodes
step 20, loss 6.45e+02, t=32.45s
step 40, loss 6.99e+01, t=66.31s
step 60, loss 6.22e+01, t=96.67s
step 80, loss 6.08e+01, t=127.47s
step 100, loss 6.01e+01, t=158.28s
step 120, loss 5.97e+01, t=188.59s
step 140, loss 5.90e+01, t=222.50s
step 160, loss 5.84e+01, t=253.61s
&lt;/pre&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:70%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;causeway_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/structural-optimization/causeway.png&quot;&gt;
      &lt;source src=&quot;/assets/structural-optimization/causeway.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;causeway_video_button&quot; onclick=&quot;playPauseCauseway()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseCauseway() { 
  var video = document.getElementById(&quot;causeway_video&quot;); 
  var button = document.getElementById(&quot;causeway_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;staggered_points&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;256&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;break_symmetry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;A staggered grid of points with downward forces, supported from below.&quot;&quot;&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[:,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# intentionally break horizontal symmetry?
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;break_symmetry&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;break_symmetry&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# run the simulation and visualize the result
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;staggered_points&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fast_stopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;pre class=&quot;outputarea&quot;&gt;
Optimizing a problem with 33410 nodes
step 10, loss 1.91e+02, t=13.35s
step 20, loss 1.43e+02, t=26.34s
step 30, loss 6.96e+01, t=39.41s
step 40, loss 6.46e+01, t=52.50s
step 50, loss 4.44e+01, t=65.47s
step 60, loss 3.97e+01, t=78.36s
step 70, loss 3.76e+01, t=91.24s
step 80, loss 3.58e+01, t=104.05s
&lt;/pre&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:40%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;points_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/structural-optimization/points.png&quot;&gt;
      &lt;source src=&quot;/assets/structural-optimization/points.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;points_video_button&quot; onclick=&quot;playPausePoints()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPausePoints() { 
  var video = document.getElementById(&quot;points_video&quot;); 
  var button = document.getElementById(&quot;points_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;staircase&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;256&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;256&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;num_stories&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;A ramp that zig-zags upward, supported from the ground.&quot;&quot;&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[:,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;

  &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;skimage.draw&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;story&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;num_stories&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parity&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;story&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;start_coordinates&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;story&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;num_stories&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;stop_coordiates&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;story&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;num_stories&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;skimage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line_aa&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_coordinates&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stop_coordiates&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;minimum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;num_stories&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# run the simulation and visualize the result
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;staircase&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opt_steps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fast_stopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;pre class=&quot;outputarea&quot;&gt;
Optimizing a problem with 132098 nodes
step 10, loss 9.65e+01, t=98.39s
step 20, loss 3.04e+01, t=197.26s
step 30, loss 7.37e+00, t=294.96s
step 40, loss 4.38e+00, t=390.48s
step 50, loss 3.98e+00, t=483.45s
step 60, loss 3.88e+00, t=575.68s
step 70, loss 3.86e+00, t=668.17s
step 80, loss 3.83e+00, t=758.19s
step 90, loss 3.82e+00, t=847.92s
step 100, loss 3.81e+00, t=939.67s
&lt;/pre&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:50%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;staircase_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/structural-optimization/staircase.png&quot;&gt;
      &lt;source src=&quot;/assets/structural-optimization/staircase.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;staircase_video_button&quot; onclick=&quot;playPauseStaircase()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseStaircase() { 
  var video = document.getElementById(&quot;staircase_video&quot;); 
  var button = document.getElementById(&quot;staircase_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;multistory_building&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;128&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[:,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[:,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;interval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y_ix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;normals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;forces&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;density&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# run the simulation and visualize the result
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;multistory_building&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opt_steps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;160&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;print_every&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;losses&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fast_stopt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verbose&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;pre class=&quot;outputarea&quot;&gt;
Optimizing a problem with 132354 nodes
step 10, loss 1.28e+04, t=72.03s
step 20, loss 8.77e+03, t=144.31s
step 30, loss 7.23e+03, t=215.94s
step 40, loss 1.74e+03, t=289.13s
step 50, loss 9.65e+02, t=362.98s
step 60, loss 8.40e+02, t=434.95s
step 70, loss 8.06e+02, t=506.56s
step 80, loss 7.97e+02, t=577.98s
step 90, loss 7.89e+02, t=648.11s
step 100, loss 7.87e+02, t=718.23s
step 110, loss 7.85e+02, t=787.93s
step 120, loss 7.83e+02, t=857.21s
step 130, loss 7.82e+02, t=927.52s
step 140, loss 7.81e+02, t=996.80s
step 150, loss 7.79e+02, t=1066.46s
step 160, loss 7.77e+02, t=1135.57s
&lt;/pre&gt;
&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:80%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;building_video&quot; style=&quot;width:100%;min-width:250px;&quot; poster=&quot;/assets/structural-optimization/building.png&quot;&gt;
      &lt;source src=&quot;/assets/structural-optimization/building.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;building_video_button&quot; onclick=&quot;playPauseBuilding()&quot;&gt;Play&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseBuilding() { 
  var video = document.getElementById(&quot;building_video&quot;); 
  var button = document.getElementById(&quot;building_video_button&quot;);
  if (video.paused) {
    video.play();
    button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;p&gt;There are many, many more structures in &lt;a href=&quot;https://arxiv.org/src/1909.04240v2/anc/all-designs.pdf&quot;&gt;this supplement&lt;/a&gt; from &lt;a href=&quot;https://scholar.google.com/scholar?hl=en&amp;amp;as_sdt=0%2C38&amp;amp;q=Neural+reparameterization+improves+structural+optimization&amp;amp;btnG=&quot;&gt;Hoyer et al. 2019&lt;/a&gt;. The problem setups are all listed &lt;a href=&quot;https://github.com/google-research/neural-structural-optimization/blob/1c11b8c6ef50274802a84cf1a244735c3ed9394d/neural_structural_optimization/problems.py&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;discussion&quot;&gt;Discussion&lt;/h2&gt;

&lt;p&gt;In sci-fi representations of the healthy cities of the future, we often find manmade structures that are well integrated with their natural surroundings. Sometimes we even see a convergence where nature has adapted to the city and the city has adapted to nature. The more decadent cities, on the other hand, tend to define themselves in opposition to the patterns of nature. Their architecture is more blocky and inorganic. Perhaps tools like structural optimization can help us build the healthy cities of the future – and steer clear of the decadent ones.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width:320px;&quot;&gt;
  &lt;img src=&quot;/assets/structural-optimization/asgard.jpeg&quot; /&gt;
  &lt;div style=&quot;text-align:center; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;The city of Asgard from &lt;i&gt;Thor&lt;/i&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;

&lt;script&gt;
    function getBrowserSize(){
       var w, h;

         if(typeof window.innerWidth != &apos;undefined&apos;)
         {
          w = window.innerWidth; //other browsers
          h = window.innerHeight;
         } 
         else if(typeof document.documentElement != &apos;undefined&apos; &amp;&amp; typeof      document.documentElement.clientWidth != &apos;undefined&apos; &amp;&amp; document.documentElement.clientWidth != 0) 
         {
          w =  document.documentElement.clientWidth; //IE
          h = document.documentElement.clientHeight;
         }
         else{
          w = document.body.clientWidth; //IE
          h = document.body.clientHeight;
         }
       return {&apos;width&apos;:w, &apos;height&apos;: h};
}

if(parseInt(getBrowserSize().width) &lt; 800){
 document.getElementById(&quot;longEqnWithLargeScript_A&quot;).style.display = &quot;none&quot;;
}
if(parseInt(getBrowserSize().width) &gt; 800){
 document.getElementById(&quot;longEqnWithSmallScript_A&quot;).style.display = &quot;none&quot;;
}

if(parseInt(getBrowserSize().width) &lt; 800){
 document.getElementById(&quot;longEqnWithLargeScript_B&quot;).style.display = &quot;none&quot;;
}
if(parseInt(getBrowserSize().width) &gt; 800){
 document.getElementById(&quot;longEqnWithSmallScript_B&quot;).style.display = &quot;none&quot;;
}
&lt;/script&gt;

&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn1&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;&lt;a href=&quot;https://www.topopt.mek.dtu.dk/-/media/subsites/topopt/apps/dokumenter-og-filer-til-apps/topopt88.pdf?la=da&amp;amp;hash=E80FAB2808804A29FFB181CA05D2EEFECAA86686&quot;&gt;Andreassen et al (2010)&lt;/a&gt; use a cone filter; we found that a Gaussian filter gave similar results and was easier to implement. &lt;a href=&quot;#fnref:fn1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Deriving the specific entries of the element stiffness matrix takes quite a few steps. We won’t go through all of them here, but you can walk yourself through them using &lt;a href=&quot;http://solidmechanics.org/text/Chapter7_2/Chapter7_2.htm&quot;&gt;this textbook chapter&lt;/a&gt;. &lt;a href=&quot;#fnref:fn2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name>Sam Greydanus</name></author><summary type="html">Structural optimization lets us design trusses, bridges, and buildings starting from the physics of elastic materials. Let&apos;s code it up, from scratch, in 180 lines.</summary></entry><entry><title type="html">How Simulating the Universe Could Yield Quantum Mechanics</title><link href="http://greydanus.github.io/2022/03/27/how-simulating/" rel="alternate" type="text/html" title="How Simulating the Universe Could Yield Quantum Mechanics" /><published>2022-03-27T04:00:00-07:00</published><updated>2022-03-27T04:00:00-07:00</updated><id>http://greydanus.github.io/2022/03/27/how-simulating</id><content type="html" xml:base="http://greydanus.github.io/2022/03/27/how-simulating/">&lt;!-- ## The Universe as a Simulation --&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:15%; min-width:200px;&quot;&gt;
  &lt;img src=&quot;/assets/how-simulating/galaxy.png&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;Let’s imagine the universe is being simulated. Based on what we know about physics, what can we say about how the simulation would be implemented? Well, it would probably have:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;strong&gt;Massive parallelism.&lt;/strong&gt; Taking advantage of the fact that, in physics, all interactions are local and limited by the speed of light, one could parallelize the simulation. Spatially adjacent regions would run on the same CPUs whereas spatially distant regions would run on separate CPUs.&lt;sup id=&quot;fnref:fn1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn1&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Conservation laws enforced.&lt;/strong&gt; Physics is built on the idea that certain quantities are strictly conserved. Scalar quantities like &lt;a href=&quot;https://en.wikipedia.org/wiki/Conservation_law#Exact_laws&quot;&gt;mass-energy&lt;/a&gt; are conserved, as are vector quantities like &lt;a href=&quot;https://en.wikipedia.org/wiki/Conservation_law#Exact_laws&quot;&gt;angular momentum&lt;/a&gt;.&lt;sup id=&quot;fnref:fn2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn2&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Binary logic.&lt;/strong&gt; Our computers use discrete, binary logic to represent and manipulate information. Non-discrete numbers are represented with sequences of discrete symbols (see &lt;a href=&quot;https://en.wikipedia.org/wiki/Single-precision_floating-point_format&quot;&gt;float32&lt;/a&gt;). Let’s assume our simulation does the same thing.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Adaptive computation.&lt;/strong&gt; To simulate the universe efficiently, we would want to spend most of our compute time on regions where a lot of matter and energy are concentrated: that’s where the dynamics would be most complex. So we’d probably want to use a &lt;a href=&quot;https://en.wikipedia.org/wiki/Lagrangian_particle_tracking&quot;&gt;particle-based (Lagrangian) simulation&lt;/a&gt; of some sort.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Isotropy.&lt;/strong&gt; Space would be &lt;a href=&quot;https://en.wikipedia.org/wiki/Isotropy&quot;&gt;uniform in all directions&lt;/a&gt;; physics would be invariant under rotation.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;We can determine whether these are reasonable assumptions by checking that they hold true for existing state-of-the-art physics simulations. It turns out that they hold true for the best &lt;a href=&quot;https://www.myroms.org/&quot;&gt;oceanography&lt;/a&gt;, &lt;a href=&quot;https://confluence.ecmwf.int/display/S2S/ECMWF+model+description&quot;&gt;meteorology&lt;/a&gt;, &lt;a href=&quot;https://arxiv.org/abs/0810.5757&quot;&gt;plasma&lt;/a&gt;, &lt;a href=&quot;https://en.wikipedia.org/wiki/NEMO_(Stellar_Dynamics_Toolbox)&quot;&gt;cosmology&lt;/a&gt;, and &lt;a href=&quot;https://en.wikipedia.org/wiki/Computational_fluid_dynamics&quot;&gt;computational fluid dynamics&lt;/a&gt; models. So, having laid out some basic assumptions about how our simulation would be implemented, let’s look at their implications.&lt;/p&gt;

&lt;h2 id=&quot;enforcing-conservation-laws-in-parallel&quot;&gt;Enforcing conservation laws in parallel&lt;/h2&gt;

&lt;p&gt;The first thing to see is that assumptions 1 and 2 are in tension with one another. In order to ensure that a quantity (eg mass-energy) is conserved, you need to sum that quantity across the entire simulation, determine whether a correction is needed, and then apply that correction to the system as a whole. Computationally, this requires a synchronous &lt;a href=&quot;https://en.wikipedia.org/wiki/Reduction_operator&quot;&gt;reduction operation&lt;/a&gt; and an element-wise divide at virtually every timestep.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/how-simulating/fig1.png&quot; /&gt;
      &lt;div class=&quot;thecap&quot; style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  A conceptual outline of a large-scale physics simulation where different regions of space are being simulated in parallel. This parallelization is possible because nothing can travel faster than the speed of light; thus the separate regions can be simulated independently over short timescales.
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;When you write a single-threaded physics simulation, this can account for about half of the computational cost (these &lt;a href=&quot;https://github.com/greydanus/optimize_wing/blob/3d661cae6ca6a320981fd5fc29848e1233d891cd/simulate.py#L57&quot;&gt;fluid&lt;/a&gt; and &lt;a href=&quot;https://github.com/google-research/neural-structural-optimization/blob/1c11b8c6ef50274802a84cf1a244735c3ed9394d/neural_structural_optimization/topo_physics.py#L236&quot;&gt;topology&lt;/a&gt; simulations are good examples). As you parallelize your simulation more and more, you can expect the cost of enforcing conservation laws to grow higher in proportion. This is because simulating dynamics is pretty easy to do in parallel. But enforcing system-wide conservation laws requires transferring data between distant CPU cores and keeping them more or less in sync. As a result, enforcing conservation laws in this manner quickly grows to be a limiting factor on runtime. We find ourselves asking: &lt;em&gt;is there a more parallelizable approach to enforcing global conservation laws?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;One option is to use a &lt;a href=&quot;https://en.wikipedia.org/wiki/Finite_volume_method&quot;&gt;finite volume method&lt;/a&gt; to keep track of quantities moving between grid cells rather than absolute values. If we don’t care about &lt;em&gt;exactly&lt;/em&gt; enforcing a conservation law, then this may be sufficient. We should note, though, that under a finite volume scheme small rounding and integration errors will occur and over time they will cause the globally-conserved quantity to change slightly. (More speculatively, this may be a particularly serious problem if people in the simulation are liable to stumble upon this phenomenon and exploit it adversarially to create or destroy energy.)&lt;/p&gt;

&lt;p&gt;If we want to &lt;em&gt;strictly&lt;/em&gt; enforce a globally-conserved quantity in a fully parallel manner, there is a third option that we could try: we could quantize it. We could quantize energy, for example, and then only transfer it in the form of discrete packets.&lt;/p&gt;

&lt;p&gt;To see why this would be a good idea, let’s use financial markets as an analogy. Financial markets are massively parallel and keeping a proper accounting of the total amount of currency in circulation is very important. So they allow currency to function as a continuous quantity on a practical level, but they quantize it at a certain scale by making small measures of value (pennies) indivisible. We could enforce conservation of energy in the same way, for the same reasons.&lt;/p&gt;

&lt;h2 id=&quot;conserving-vector-quantities&quot;&gt;Conserving vector quantities&lt;/h2&gt;

&lt;p&gt;Quantization may work well for conserving scalar values like energy. But what about conserving vector quantities like angular momentum? In these cases, isotropy/rotational symmetry (assumption 5) makes things difficult. Isotropy says that our simulation will be invariant under rotation, but if we quantized the directions of our angular momentum vectors, we would be unable to represent all spatial directions equally. We’d get &lt;a href=&quot;https://en.wikipedia.org/wiki/Round-off_error&quot;&gt;rounding errors&lt;/a&gt; which would compound over time.&lt;/p&gt;

&lt;p&gt;So how are we to implement exact conservation of vector quantities? One option is to require that one particle’s vector quantities always be defined in reference to some other particle’s vector quantities. This could be implemented by creating multiple &lt;a href=&quot;https://en.wikipedia.org/wiki/Pointer_(computer_programming)&quot;&gt;pointer references&lt;/a&gt; to a single variable and then giving each of those pointers to a different particle. As a concrete example, we might imagine an atom releasing energy in the form of two photons. The polarization angle of the first photon could be expressed as a 90\(^\circ\) clockwise rotation of a pointer to variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;x&lt;/code&gt;. Meanwhile, the polarization angle of the second photon could be expressed as a 90\(^\circ\) counterclockwise rotation of a pointer to the same variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;x&lt;/code&gt;. As we advance our simulation through time, the polarization angles of the two photons would change. Perhaps some small integration and rounding errors would accumulate. But even if that happens, we can say with confidence that the relative difference in polarization angle will be a constant 180\(^\circ\). In this way, we could enforce conservation of angular momentum in parallel across the entire simulation.&lt;/p&gt;

&lt;p&gt;We should recognize that this approach comes at a price. It demands that we sacrifice &lt;em&gt;locality&lt;/em&gt;, the principle that an object is influenced directly only by its immediate surroundings. It’s one of the most sacred principles in physics. This gets violated in the example of the two photons because a change in the polarization of the first photon will update the value of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;x&lt;/code&gt;, implicitly changing the polarization of the second photon.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/how-simulating/fig2.png&quot; /&gt;
    &lt;div class=&quot;thecap&quot; style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  This figure is inspired by the experimental setup of &lt;a href=&quot;https://drive.google.com/file/d/1ac4E87cKMgp90PfoNeTaRiVE3HEC9ubJ/view?usp=sharing&quot;&gt;Clauser and Horne (1974)&lt;/a&gt; used to test the Bell inequality. Here we are hypothesizing the existence of a shared hidden variable &lt;i&gt;x&lt;/i&gt; which, when updated due the left photon&apos;s interaction with a polarizer, also affects the right photon&apos;s polarization.
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Interestingly, the mechanics of this nonlocal relationship would predict a violation of &lt;a href=&quot;https://www.youtube.com/watch?v=zcqZHYo7ONs&amp;amp;vl=en&quot;&gt;Bell’s inequality&lt;/a&gt; which would match experimental results. Physicists agree that violation of Bell’s inequality implies that nature violates either &lt;em&gt;realism&lt;/em&gt;, the principle that reality exists with definite properties even when not being observed, or locality. Since locality is seen as a more fundamental principle than realism, the modern consensus is that quantum mechanics violates realism. In this line of thinking, entangled particles cannot be said to have deterministic states and instead exist in a state of superposition until they are measured. But in our simulated universe, realism would be preserved and locality would be sacrificed. Entangled particles would have definite states but sometimes those states would change due to shared references to spatially distant “twins.”&lt;sup id=&quot;fnref:fn4&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn4&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt; To see how this would work in practice, try simulating it yourself at the link below.&lt;/p&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right:auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://colab.research.google.com/drive/1b_DJo27Cq9E6zxSD9KpvyilaVV512SkU?usp=sharing&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Run&lt;/span&gt; in browser&lt;/a&gt;
&lt;/div&gt;

&lt;h2 id=&quot;explaining-the-double-slit-experiment&quot;&gt;Explaining the double slit experiment&lt;/h2&gt;

&lt;p&gt;Our findings thusfar may lead us to ask whether other quantum mechanical phenomena can be derived from the simulation &lt;em&gt;ansatz&lt;/em&gt;. For example, what could be causing the wave-particle duality of light as seen in the double slit experiment?&lt;/p&gt;

&lt;p&gt;The important idea here is &lt;a href=&quot;https://en.wikipedia.org/wiki/Filter_(large_eddy_simulation)&quot;&gt;filtering&lt;/a&gt;. Filtering is a common technique where a Gaussian or cone filter is convolved with a grid in order to smooth out the physics and eliminate grid-level pathologies. This step is essential – for example, these &lt;a href=&quot;https://github.com/greydanus/optimize_wing/blob/3d661cae6ca6a320981fd5fc29848e1233d891cd/simulate.py#L83&quot;&gt;fluid&lt;/a&gt; and &lt;a href=&quot;https://github.com/google-research/neural-structural-optimization/blob/1c11b8c6ef50274802a84cf1a244735c3ed9394d/neural_structural_optimization/topo_physics.py#L84&quot;&gt;topology&lt;/a&gt; simulations would not work without it.&lt;/p&gt;

&lt;p&gt;How would one implement filtering in a large-scale, particle-based simulation of the universe? Well, if the simulation were particle-based instead of grid-based, we couldn’t apply a Gaussian or cone filter. An alternative would be to simulate the dynamics of each particle using ensembles of virtual particles. One could initialize a group of these virtual particles with slightly different initial conditions and then simulate all of them through time. If you allowed these virtual particles to interact with other virtual particles in the ensemble, the entire ensemble would collectively behave as though it were a wave.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/how-simulating/fig3.png&quot; style=&quot;width:90%&quot; /&gt;
    &lt;div class=&quot;thecap&quot; style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  Wave-particle behavior of a photon as a consequence of using an ensemble of virtual particles and selecting just one to transfer a quanta of energy to the photoreceptor.
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;You might notice that there is a tension between this spatially delocalized, wave-like behavior (a consequence of filtering, which is related to assumption 3) and the conservation/quantization of quantities like energy (assumption 2). The tension is this: when a wave interacts with an object, it transfers energy in a manner that is delocalized and proportionate to its amplitude at a given location. But we have decided to quantize energy in order to keep an exact accounting of it across our simulation. So when our ensemble of particles interacts with some matter, it must transfer exactly one quanta of energy and it must do so at one particular location.&lt;/p&gt;

&lt;p&gt;The simplest way to implement this would be to choose one particle out of the ensemble and allow it to interact with other matter and transfer energy. The rest of the particles in the ensemble would be removed from the simulation upon coming into contact with other matter. The interesting thing about this approach is that it could help explain the wave-particle duality of subatomic particles such as photons. For example, it could be used to reproduce the empirical results of the double slit experiment in a fully deterministic manner.&lt;sup id=&quot;fnref:fn6&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn6&quot; class=&quot;footnote&quot;&gt;4&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;h2 id=&quot;but-classical-computers-cant-simulate-quantum-effects&quot;&gt;“But classical computers can’t simulate quantum effects”&lt;/h2&gt;

&lt;p&gt;It is generally accepted that the cost of simulating \(N\) entangled particles, each with \(d\) degrees of freedom, grows as \(d^{N}\). This means that simulating a quantum system with a classical computer becomes prohibitively expensive for even small groups of particles. And if you simulate such systems probabilistically, you will inevitably encounter cases where the simulated physics doesn’t match reality.&lt;sup id=&quot;fnref:fn5&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn5&quot; class=&quot;footnote&quot;&gt;5&lt;/a&gt;&lt;/sup&gt; If it’s that difficult for classical computers to simulate quantum effects – and the universe is quantum mechanical – then isn’t this entire thought experiment destined to fail?&lt;/p&gt;

&lt;p&gt;Perhaps not. Claims about the difficulty of simulating quantum effects are based on &lt;a href=&quot;https://en.wikipedia.org/wiki/Quantum_indeterminacy&quot;&gt;quantum indeterminacy&lt;/a&gt;, the idea that entangled particles do not have definite states prior to measurement. This interpretation of quantum effects comes about when we sacrifice the assumption of realism. But if we sacrifice locality (as we have done in this article), then we need not sacrifice realism. In a world where entangled particles can affect each other’s states instantaneously at a distance (nonlocality), they can always have specific states (realism) and still produce the empirical behaviors (&lt;a href=&quot;https://en.wikipedia.org/wiki/Bell%27s_theorem#Experiments&quot;&gt;violation of Bell’s theorem&lt;/a&gt;) that consitute the basis of the theory of quantum mechanics. This sort of world could be simulated on a classical computer.&lt;/p&gt;

&lt;h2 id=&quot;testing-our-hypothesis&quot;&gt;Testing our hypothesis&lt;/h2&gt;

&lt;p&gt;Suppose the ideas we have discussed are an accurate model of reality. How would we test them? We could start by showing that in quantum mechanics, realism is actually preserved whereas locality is not. To that end, here’s one potential experiment:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;We set up the apparatus used to test Bell’s inequality. Entangled photons emerge from a source and head in opposite directions. Eventually they get their polarizations measured. We allow the first photon in the pair to enter a double slit experiment. As it passes through the double slit, it interferes with itself, producing a wavelike diffraction pattern on the detector.&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/how-simulating/fig4.png&quot; style=&quot;width:80%&quot; /&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  One possible means of testing the hypothesis we have outlined. If photons used to test the Bell inequality behave in this manner when they encounter a double slit setup, one could use them to transmit information faster than the speed of light, violating the locality assumption.
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;em&gt;Then we change the experiment by measuring the second photon in the pair before the first photon reaches the double slit. This will break the entanglement, causing both photons to enter well-defined polarization states. When this happens, the first photon will behave like a particle as it passes through the double slit experiment. This would be a surprising result because such a setup would violate the locality assumption&lt;sup id=&quot;fnref:fn3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;6&lt;/a&gt;&lt;/sup&gt; and could be used to transmit information faster than light.&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;closing-thoughts&quot;&gt;Closing thoughts&lt;/h2&gt;

&lt;p&gt;To the followers of Plato, the world of the senses was akin to shadows dancing on the wall of a cave. The essential truths and realities of life were not to be found on the wall at all, but rather somewhere else in the cave in the form of real dancers and real flames. A meaningful life was to be spent seeking to understand those forms, elusive though they might be.&lt;/p&gt;

&lt;p&gt;In this post, we took part in that tradition by using our knowledge of physics simulations to propose a new interpretation of quantum mechanics. It’s hard to know whether we do indeed live in a simulation. Perhaps we will never know. But at the very least, the idea serves as a good basis for a thought-provoking discussion.&lt;/p&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;

&lt;script language=&quot;javascript&quot;&gt;
function hideShowNote() {
  var x = document.getElementById(&quot;note_to_reader&quot;);
  var y = document.getElementById(&quot;note_toggle&quot;);
  if (x.style.display === &quot;none&quot;) {
    x.style.display = &quot;inline&quot;; y.textContent = &quot;(–)&quot;
  } else {
    x.style.display = &quot;none&quot;; y.textContent = &quot;(+)&quot;
  }
}
&lt;/script&gt;

&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn1&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;This is connected to the notion of &lt;a href=&quot;https://plato.stanford.edu/entries/cellular-automata/#CAModeReal&quot;&gt;cellular automata as models of reality&lt;/a&gt;. &lt;a href=&quot;#fnref:fn1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;As a subset of conservation of angular momentum, &lt;a href=&quot;https://www.nature.com/articles/s41467-019-10939-x&quot;&gt;polarization&lt;/a&gt; is also conserved. This is relevant to later examples which assume conservation of polarization. &lt;a href=&quot;#fnref:fn2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn4&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Physicists have certainly entertained the idea of using non-local theories to explain Bell’s inequality. One of the reasons these theories are not more popular is that &lt;a href=&quot;https://drive.google.com/file/d/1RTlV08KhQ7lNwOukbNcMok0f6E42uMyI/view?usp=sharing&quot;&gt;Groblacher et al, 2007&lt;/a&gt; and others have reported experimental results that rule out some of the more reasonable options (eg Leggett-style non-local theories). But the idea we are proposing here is somewhat more radical; it would permit information to travel faster than the speed of light, violating the &lt;a href=&quot;https://en.wikipedia.org/wiki/No-communication_theorem&quot;&gt;No-communication theorem&lt;/a&gt;. Of course, the only information that could be communicated faster than the speed of light would be &lt;em&gt;whether a given pair of particles is in a superposition of states or not&lt;/em&gt;. Look at the “Testing our hypothesis” section for more discussion on this topic. &lt;a href=&quot;#fnref:fn4&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn6&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Update (May 16, 2022): I tried to &lt;a href=&quot;https://colab.research.google.com/drive/1Ayh4mGyx4Td63nfF2-bLd5cQJaGQLEz5?usp=sharing&quot;&gt;code this up&lt;/a&gt; and encountered some problems. First of all, it’s a nontrivial simulation problem. But apart from that, it’s difficult to achieve wavelike behaviors across the group without faster-than-light propagation of electric fields (which I suspect is nonphysical). I suspect that this filtering path is still a viable route to explaining the double slit experiment, but I now believe that the implementation details may look a bit different. One idea Jason Yosinski suggested was: what if our simulator was solving a PDE in both the spatial domain &lt;em&gt;and&lt;/em&gt; the frequency domain and occasionally, whenever a spatial pattern got too diffuse, it would be transferred over to the frequency domain. Conversely, whenever a frequency pattern got too localized, it would be transferred over to the spatial domain. This could help to explain, for example &lt;a href=&quot;https://en.wikipedia.org/wiki/Vacuum_energy&quot;&gt;particle generation in a vacuum&lt;/a&gt;. More on this in the future. &lt;a href=&quot;#fnref:fn6&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn5&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;See Section 5 of Feynman’s “&lt;a href=&quot;https://www.taylorfrancis.com/chapters/edit/10.1201/9780429500459-11/simulating-physics-computers-richard-feynman&quot;&gt;Simulating physics with computers&lt;/a&gt;” &lt;a href=&quot;#fnref:fn5&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Relatedly, it will also violate the &lt;a href=&quot;https://en.wikipedia.org/wiki/No-communication_theorem&quot;&gt;no-communication theorem&lt;/a&gt;, which is a core claim of quantum mechanics. &lt;a href=&quot;#fnref:fn3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html">We look at the logistics of simulating the universe. We find that enforcing conservation laws, isotropy, etc. in parallel could lead to quantum-like effects.</summary></entry><entry><title type="html">Dissipative Hamiltonian Neural Networks</title><link href="http://greydanus.github.io/2022/01/25/dissipative-hnns/" rel="alternate" type="text/html" title="Dissipative Hamiltonian Neural Networks" /><published>2022-01-25T03:00:00-08:00</published><updated>2022-01-25T03:00:00-08:00</updated><id>http://greydanus.github.io/2022/01/25/dissipative-hnns</id><content type="html" xml:base="http://greydanus.github.io/2022/01/25/dissipative-hnns/">&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/dissipative-hnns/hero.jpg&quot; /&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  Dissipative HNNs (D-HNNs) improve upon &lt;a href=&quot;https://greydanus.github.io/2019/05/15/hamiltonian-nns/&quot;&gt;Hamiltonian Neural Networks&lt;/a&gt;. They output two scalar functions, denoted here by &lt;i&gt;&lt;b&gt;H&lt;/b&gt;&lt;/i&gt; and &lt;i&gt;&lt;b&gt;D&lt;/b&gt;&lt;/i&gt;. The first of these two, &lt;i&gt;&lt;b&gt;H&lt;/b&gt;&lt;/i&gt;, is the Hamiltonian. We use its symplectic gradient to model energy-conserving dynamics. The second, &lt;i&gt;&lt;b&gt;D&lt;/b&gt;&lt;/i&gt;, is the Rayleigh dissipation function. We use it to model the dissipative component of the system. The addition of this dissipation function allows D-HNNs to model systems where energy is not quite conserved, as, for example, in the case of the damped mass-spring system shown here.
  &lt;/div&gt;
&lt;/div&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right:auto; width:100%; text-align:center;&quot;&gt;
  &lt;a href=&quot;https://arxiv.org/abs/2201.10085&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Read the paper&lt;/a&gt;
  &lt;a href=&quot;https://github.com/DrewSosa/dissipative_hnns&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Get the code&lt;/a&gt;
&lt;/div&gt;

&lt;h2 id=&quot;a-sea-of-change&quot;&gt;A sea of change&lt;/h2&gt;

&lt;p&gt;We are immersed in a complex, dynamic world where change is the only constant. And yet there are certain patterns to this change that suggest natural laws. These laws include conservation of mass, energy, and momentum. Taken together, they constitute a powerful simplifying constraint on reality. Indeed, physics tells us that a small set of laws and their associated invariances are at the heart of all natural phenomena. Whether we are studying weather, ocean currents, earthquakes, or molecular interactions, we should take care to respect these laws. And when we apply learning algorithms to these domains, we should ensure that they, too, respect these laws.&lt;/p&gt;

&lt;p&gt;We can do this by building models that are primed to learn invariant quantities from data: these models include &lt;a href=&quot;https://greydanus.github.io/2019/05/15/hamiltonian-nns/&quot;&gt;HNNs&lt;/a&gt;, &lt;a href=&quot;https://greydanus.github.io/2020/03/10/lagrangian-nns/&quot;&gt;LNNs&lt;/a&gt;, and a &lt;a href=&quot;https://scholar.google.com/scholar?hl=en&amp;amp;as_sdt=0%2C38&amp;amp;q=hamiltonian+neural+networks&amp;amp;btnG=&quot;&gt;growing class&lt;/a&gt; of &lt;a href=&quot;https://scholar.google.com/scholar?hl=en&amp;amp;as_sdt=0,38&amp;amp;q=symplectic+neural+networks&quot;&gt;related models&lt;/a&gt;. But one problem with these models is that, for the most part, they can only handle data where some quantity (such as energy) is exactly conserved. If the data is collected in the real world and there is even a small amount of friction, then these models struggle. In this post, we introduce Dissipative HNNs, a class of models which can learn conservation laws from data even when energy isn’t perfectly conserved.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/dissipative-hnns/sea_of_change.jpg&quot; /&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left; display:block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  We live in a sea of change. But no matter how complex a system&apos;s dynamics are, they can always be decomposed into the sum of dissipative dynamics and conservative dynamics.
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;The core idea is to use a neural network to parameterize both a Hamiltonian &lt;em&gt;and&lt;/em&gt; a Rayleigh dissipation function. During training, the Hamiltonian function fits the conservative (rotational) component of the dynamics whereas the Rayleigh function fits the dissipative (irrotational) component. Let’s dive in to how this works.&lt;/p&gt;

&lt;h2 id=&quot;a-quick-theory-section&quot;&gt;A quick theory section&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;The Hamiltonian function.&lt;/strong&gt; The Hamiltonian \(\mathcal{H}(\textbf{q},\textbf{p})\) is scalar function where by definition \( \frac{\partial \mathcal{H}}{\partial \textbf{p}} = \frac{\partial \textbf{q}}{dt},  -\frac{\partial \mathcal{H}}{\partial \textbf{q}} = \frac{\partial \textbf{p}}{dt} \). This constraint tells us that, even as the position and momentum coordinates of the system \(\textbf{(q, p)}\) change, the scalar output \(\mathcal{H}\) remains fixed. In other words, \(\mathcal{H}\) is invariant with respect to \(\textbf{q}\) and \(\textbf{p}\) as they change over time; it is a conserved quantity. Hamiltonians often appear in physics because for every natural symmetry/law in the universe, there is a corresponding conserved quantity (see &lt;a href=&quot;https://en.wikipedia.org/wiki/Noether%27s_theorem&quot;&gt;Noether’s theorem&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;The Rayleigh function.&lt;/strong&gt; The Rayleigh dissipation function \(\mathcal{D}(\textbf{q},\textbf{p})\) is a scalar function that provides a way to account for dissipative forces such as friction in the context of Hamiltonian mechanics. As an example, the Rayleigh function for linear, velocity-dependent dissipation would be \(\mathcal{D} = \frac{1}{2}\rho\dot{q}^2\) where \(\rho\) is a constant and \(\dot q\) is the velocity coordinate. We add this function to a Hamiltonian whenever the conserved quantity we are trying to model is changing due to sources and sinks. For example, if \(\mathcal{H}\) measures the total energy of a damped mass-spring system, then we could add the \(\mathcal{D}\) we wrote down above to account for the change in total energy due to friction.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Helmholtz decompositions.&lt;/strong&gt; Like many students today, Hermann von Helmholtz realized that medicine was not his true calling. Luckily for us, he switched to physics and discovered one of the most useful tools in vector analysis: the Helmholtz decomposition. The Helmholtz decomposition says that any vector field \(V\) can be written as the gradient of a scalar potential \(\phi\) plus the curl of a vector potential \(\mathcal{\textbf{A}}\). In other words, \( V = \nabla\phi + \nabla\times \mathcal{\textbf{A}}\). Note that the first term is irrotational and the second term is rotational. This tells us that &lt;em&gt;any vector field can be decomposed into the sum of an irrotational (dissipative) vector field and a rotational (conservative) vector field&lt;/em&gt;. Here’s a visual example:&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/dissipative-hnns/hhd.jpg&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Putting it together.&lt;/strong&gt; In &lt;a href=&quot;https://greydanus.github.io/2019/05/15/hamiltonian-nns/&quot;&gt;Hamiltonian Neural Networks&lt;/a&gt;, we showed how to parameterize the Hamiltonian function and then learn it directly from data. Here, we parameterize a Rayleigh function as well. Our model looks the same as an HNN except now it has a second scalar output which we use for the Rayleigh function (see the first image in this post). During the forward pass, we take the symplectic gradient of the Hamiltonian to obtain conservative forces. Note that as we do this, the symplectic gradient constitutes a rotational vector field over the model’s inputs. During the forward pass we also take the gradient of the Rayleigh function to obtain dissipative forces. This gradient gives us an irrotational vector field over the same domain.&lt;/p&gt;

&lt;p&gt;All of this means that, by construction, our model will learn an implicit Helmholtz decomposition of the forces acting on the system.&lt;/p&gt;

&lt;h2 id=&quot;an-introductory-model&quot;&gt;An introductory model&lt;/h2&gt;

&lt;p&gt;We coded up a D-HNN model and used it to fit three physical systems: a synthetic damped mass-spring, a real-world pendulum, and an ocean current timeseries sampled from the OSCAR dataset. In this post, we’ll focus on the damped mass-spring example in order to build intuition for how D-HNNs work.&lt;/p&gt;

&lt;p&gt;We can describe the state of a damped (one dimensional) mass-spring system with just two coordinates, \(q\) and \(p\). Also, we can plot these coordinates on Cartesian \(x\) and \(y\) axes to obtain &lt;a href=&quot;https://en.wikipedia.org/wiki/Phase_space&quot;&gt;phase-space diagrams&lt;/a&gt;. These diagrams are useful because they allow us to visualize and compare our model to other baseline models.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/dissipative-hnns/dampedspring.jpg&quot; style=&quot;width:100%; max-width: 600px&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;In the image above, the damped mass-spring dataset is plotted in the upper left square. Each arrow represents the time derivative of the system with respect to that \((p,q)\) coordinate. The Helmholtz decomposition tells us that this vector field can be decomposed into conservative and dissipative components, and indeed that is what we have done in the second and third columns.&lt;sup id=&quot;fnref:fn1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn1&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; You may notice that the dissipative field in the third column isolates the force due to friction.&lt;/p&gt;

&lt;p&gt;In the second row, we evaluate a D-HNN trained on the system. The D-HNN produces a trajectory that closely matches ground truth. By plotting the symplectic gradient of \(\mathcal{H}\) and the gradient of \(\mathcal{D}\), we can see that it has properly decoupled the conservative and dissipative dynamics respectively. By contrast, in the third row, we train a baseline model (an MLP) on the same data; this model produces a good trajectory but is unable to learn conservative and dissipative dynamics separately. Finally, in the fourth row, we train an HNN on the same dataset and find that it is only able to model the conservative component of the system’s dynamics. It strictly enforces conservation of energy in a scenario where energy is not actually conserved, leading to a poor prediction.&lt;/p&gt;

&lt;h2 id=&quot;why-decouple-conservative-and-dissipative-dynamics&quot;&gt;Why decouple conservative and dissipative dynamics?&lt;/h2&gt;

&lt;p&gt;We’ve described a model that can learn conservative and dissipative dynamics separately and shown that it works on a toy problem. Why is this a good idea? One answer is that &lt;em&gt;it lets our model fit data in a more physically-realistic manner, leading to better generalization&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;If we were to suddenly double the coefficient of friction \(\rho\), our MLP model would not be able to predict a viable trajectory. This is because it models the dissipative and conservative dynamics of the system together. However, since our D-HNN learned these dynamics separately, &lt;em&gt;it can generalize to new friction coefficients without additional training&lt;/em&gt;. In order to double the scale of dissipative forces, we can simply multiply the gradient of the Rayleigh function by two. The image below shows how this produces viable trajectories under unseen friction coefficients (orange highlights).&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/dissipative-hnns/spring_rho.jpg&quot; style=&quot;width:100%; max-width: 600px&quot; /&gt;
&lt;/div&gt;

&lt;h2 id=&quot;additional-experiments&quot;&gt;Additional experiments&lt;/h2&gt;

&lt;p&gt;We also trained our model on data from a real pendulum and ocean current data from the OSCAR dataset (shown below). On these larger and more more difficult tasks, our model continued to decouple conservative and dissipative dynamics. The details and results are outside the scope of this post, but you can find them in &lt;a href=&quot;https://github.com/greydanus/dissipative_hnns&quot;&gt;our paper&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
  &lt;img src=&quot;/assets/dissipative-hnns/ocean.jpg&quot; style=&quot;width:100%&quot; /&gt;
&lt;/div&gt;

&lt;h2 id=&quot;closing-thoughts&quot;&gt;Closing thoughts&lt;/h2&gt;

&lt;p&gt;This work is a small, practical contribution to science in that it proposes a new physics prior for machine learning models. But it is also a step towards a larger and more ambitious goal: that of building models which can extract conservation laws directly from noisy real-world data. We hope that future work in this direction will benefit from our findings.&lt;/p&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;

&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn1&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;In practice, we performed this decomposition using a few hundred iterations of the Gauss-Seidel method to solve Poisson’s equation. Again, see &lt;a href=&quot;https://drive.google.com/file/d/1upKFdtnM0xcTVxNsPHI1KCvmcanAJheL/view?usp=sharing&quot;&gt;this paper&lt;/a&gt; for details. &lt;a href=&quot;#fnref:fn1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name>Andrew Sosanya and Sam Greydanus</name></author><summary type="html">This class of models can learn Hamiltonians from data even when the total energy of the system is not perfectly conserved.</summary></entry><entry><title type="html">Piecewise-constant Neural ODEs</title><link href="http://greydanus.github.io/2021/06/11/piecewise-nodes/" rel="alternate" type="text/html" title="Piecewise-constant Neural ODEs" /><published>2021-06-11T04:00:00-07:00</published><updated>2021-06-11T04:00:00-07:00</updated><id>http://greydanus.github.io/2021/06/11/piecewise-nodes</id><content type="html" xml:base="http://greydanus.github.io/2021/06/11/piecewise-nodes/">&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;video_sim&quot; style=&quot;width:100%;min-width:250px;&quot;&gt;
    	&lt;source src=&quot;/assets/piecewise-nodes/video_simulator_2.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video_sim_button&quot; onclick=&quot;playPauseSim()&quot;&gt;Play&lt;/button&gt; 
    &lt;div style=&quot;text-align: left;margin-left:10px;margin-right:10px;&quot;&gt;Using model-based planning to play billiards. The goal is to impart the tan cue ball with an initial velocity so as to move the blue ball to the black target.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;video_base&quot; style=&quot;width:100%;min-width:250px;&quot;&gt;
    	&lt;source src=&quot;/assets/piecewise-nodes/video_base_2.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video_base_button&quot; onclick=&quot;playPauseBase()&quot;&gt;Play&lt;/button&gt; 
    &lt;div style=&quot;text-align:left;margin-left:10px;margin-right:10px;&quot;&gt;A baseline ODE-RNN trained on billiards dynamics can also be used for model-based planning. It&apos;s inefficient because it has to &quot;tick&quot; at a constant rate.&lt;/div&gt;
  &lt;/div&gt;
   &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;video_ours&quot; style=&quot;width:100%;min-width:250px;&quot;&gt;
    	&lt;source src=&quot;/assets/piecewise-nodes/video_ours_2.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video_ours_button&quot; onclick=&quot;playPauseOurs()&quot;&gt;Play&lt;/button&gt; 
    &lt;div style=&quot;text-align:left;margin-left:10px;margin-right:10px;&quot;&gt;By contrast, our model, trained on the same task, can perform planning in many fewer steps by jumping over spans of time where motion is predictable.&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseSim() { 
  var video = document.getElementById(&quot;video_sim&quot;); 
  var button = document.getElementById(&quot;video_sim_button&quot;);
  if (video.paused) {
    video.play();
	button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
	button.textContent = &quot;Play&quot;;}
} 

function playPauseBase() { 
  var video = document.getElementById(&quot;video_base&quot;); 
  var button = document.getElementById(&quot;video_base_button&quot;);
  if (video.paused) {
    video.play();
	button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
	button.textContent = &quot;Play&quot;;}
} 

function playPauseOurs() { 
  var video = document.getElementById(&quot;video_ours&quot;); 
  var button = document.getElementById(&quot;video_ours_button&quot;);
  if (video.paused) {
    video.play();
	button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
	button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
	&lt;a href=&quot;https://arxiv.org/abs/2106.06621&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Read the paper&lt;/a&gt;
	&lt;a href=&quot;https://github.com/greydanus/piecewise_node#run-in-your-browser&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Run&lt;/span&gt; in browser&lt;/a&gt;
	&lt;a href=&quot;https://github.com/greydanus/piecewise_node&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Get the code&lt;/a&gt;
&lt;/div&gt;

&lt;h2 id=&quot;change-it-is-said-happens-slowly-and-then-all-at-once&quot;&gt;Change, it is said, happens slowly and then all at once…&lt;/h2&gt;

&lt;p&gt;Billiards balls move across a table before colliding and changing trajectories; water molecules cool slowly and then undergo a rapid phase transition into ice; and economic systems enjoy periods of stability interspersed with abrupt market downturns. That is to say, many time series exhibit periods of relatively homogeneous change divided by important events. Despite this, recurrent neural networks (RNNs), popular for time series modeling, treat time in uniform intervals – potentially wasting prediction resources on long intervals of relatively constant change.&lt;/p&gt;

&lt;p&gt;A recent family of models called &lt;a href=&quot;https://arxiv.org/abs/1806.07366&quot;&gt;Neural ODEs&lt;/a&gt; has attracted interest as a means of mitigating these problems. They parameterize the &lt;em&gt;time derivative&lt;/em&gt; of a hidden state with a neural network and then integrate it over arbitrary amounts of time. This allows them to treat time as a continuous variable. Integration can even be performed using adaptive integrators like &lt;a href=&quot;https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods&quot;&gt;Runge-Kutta&lt;/a&gt;, thus allocating more compute to difficult state transitions.&lt;/p&gt;

&lt;p&gt;Adaptive integration is especially attractive in scenarios where “key events” are separated by variable amounts of time. In the game of billiards, these key events may consist of collisions between balls, walls, and pockets. Between these events, the balls simply undergo linear motion. That motion is not difficult to predict, but it is non-trivial for a model to learn to skip over it so as to focus on the more chaotic dynamics of collisions; this requires a model to employ some notion of &lt;a href=&quot;https://www.sciencedirect.com/science/article/pii/S0004370299000521&quot;&gt;&lt;em&gt;temporal abstraction&lt;/em&gt;&lt;/a&gt;. This problem is not unique to billiards. The same challenge occurs in robotics, where a robot arm occasionally interacts with external objects at varying intervals. It may also occur in financial markets, scientific timeseries, and other environments where change happens at a variable rate.&lt;/p&gt;

&lt;h2 id=&quot;towards-temporally-abstract-hidden-state-dynamics&quot;&gt;Towards temporally-abstract hidden state dynamics&lt;/h2&gt;

&lt;p&gt;In this post, I am going to introduce a special case of Neural ODEs that my research group has been experimenting with recently. The core idea is to restrict the hidden state of a Neural ODE so that it has locally-linear dynamics. The benefit of such a model is that it can be integrated &lt;em&gt;exactly&lt;/em&gt; using Euler integration, and it can also be integrated &lt;em&gt;adaptively&lt;/em&gt; because we allow these locally-linear dynamics to extend over variable-sized durations of time. Like RNNS and Neural ODEs, our model uses a hidden state \(h\) to summarize knowledge about the world at a given point in time. Also, it performs updates on this hidden state using cell updates (eg. with vanilla, LSTM, or GRU cells). But our model differs from existing models in that the amount of simulation time that occurs between cell updates is not fixed. Rather, it changes according to the variable \(\Delta t\), which is itself predicted.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width: 300px&quot;&gt;
  &lt;img src=&quot;/assets/piecewise-nodes/hero.png&quot; style=&quot;width:100%&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;Our model also predicts a &lt;em&gt;hidden state velocity&lt;/em&gt;, \(\dot h\), at each cell update; this enables us to evolve the hidden state dynamics continuously over time according to \(h(t+\Delta t) = h + \dot h \Delta t\). In other words, the hidden state velocity allows us to parameterize &lt;em&gt;the locally-linear dynamics of the hidden state&lt;/em&gt;. Thus when our model needs to simulate long spans of homogeneous change (eg, a billiard ball undergoing linear motion), it can do so with a single cell update.&lt;/p&gt;

&lt;p&gt;In order to compare our model to existing timeseries models (RNNs and Neural ODEs), we used both of them to model a series of simple physics problems including the collisions of two billiards balls. We found that our jumpy model was able to learn these dynamics at least as well as the baseline while using a fraction of the forward simulation steps. This makes it a great candidate for model-based planning because it can predict the outcome of taking an action much more quickly than a baseline model. And since the hidden-state dynamics are piecewise-linear over time, we can solve for the hidden state at arbitrary points along a trajectory. This allows us to simulate the dynamics &lt;em&gt;at a higher temporal resolution than the original training data&lt;/em&gt;:&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
    &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;video_sim2&quot; style=&quot;width:100%;min-width:250px;&quot;&gt;
      &lt;source src=&quot;/assets/piecewise-nodes/video_sim_2.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video_sim2_button&quot; onclick=&quot;playPauseSim2()&quot;&gt;Play&lt;/button&gt; 
    &lt;div style=&quot;text-align: left;margin-left:10px;margin-right:10px;&quot;&gt;This video will give you a sense of the underlying temporal resolution of the billiards dataset on which we trained the model.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video id=&quot;video_interp&quot; style=&quot;width:100%;min-width:250px;&quot;&gt;
    	&lt;source src=&quot;/assets/piecewise-nodes/video_interp_2.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video_interp_button&quot; onclick=&quot;playPauseInterp()&quot;&gt;Play&lt;/button&gt; 
    &lt;div style=&quot;text-align:left;margin-left:10px;&quot;&gt;This video shows how we can use our model to generate simulations at a higher temporal resolution than that of the original simulator. 
&lt;!--     We can do this because the latent dynamics of the model are continuous and piecewise-linear in time. --&gt;
  &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPauseSim2() { 
  var video = document.getElementById(&quot;video_sim2&quot;); 
  var button = document.getElementById(&quot;video_sim2_button&quot;);
  if (video.paused) {
    video.play();
	button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
	button.textContent = &quot;Play&quot;;}
} 

function playPauseJumpy2() { 
  var video = document.getElementById(&quot;video_jumpy2&quot;); 
  var button = document.getElementById(&quot;video_jumpy2_button&quot;);
  if (video.paused) {
    video.play();
	button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
	button.textContent = &quot;Play&quot;;}
} 

function playPauseInterp() { 
  var video = document.getElementById(&quot;video_interp&quot;); 
  var button = document.getElementById(&quot;video_interp_button&quot;);
  if (video.paused) {
    video.play();
	button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
	button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;p&gt;I am going to give more specific examples of how our model improves over regular timeseries models later. But first we need to talk about what these timeseries models are good at and why they are worth improving in the first place.&lt;/p&gt;

&lt;h2 id=&quot;the-value-of-timeseries-models&quot;&gt;The value of timeseries models&lt;/h2&gt;

&lt;p&gt;Neural network-based timeseries models like RNNs and Neural ODEs are interesting because they can learn complex, long-range structure in time series data simply by predicting one point at a time. For example, if you train them on observations of a robot arm, you can use them to generate realistic paths that the arm might take.&lt;/p&gt;

&lt;p&gt;One of the things that makes these models so flexible is that they use a hidden vector \(h\) to store memories of past observations. And they can &lt;em&gt;learn&lt;/em&gt; to read, write, and erase information from \(h\) in order to make accurate predictions about the future. RNNs do this in discrete steps whereas Neural ODEs permit hidden state dynamics to be continuous in time. Both models are Turing-complete and, unlike other models that are Turing-complete (eg. HMMs or FSMs), they can learn and operate on noisy, high-dimensional data. Here is an incomplete list of things people have trained these models (mostly RNNs) to do:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://papers.nips.cc/paper/5346-sequence-to-sequence-learning-with-neural-&quot;&gt;Translate text from one language to another&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://openai.com/blog/solving-rubiks-cube/&quot;&gt;Control a robot hand in order to solve a Rubik’s Cube&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://rdcu.be/bVI7G&quot;&gt;Defeat professional human gamers in StarCraft&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://openaccess.thecvf.com/content_cvpr_2016/html/Johnson_DenseCap_Fully_Convolutional_CVPR_2016_paper.html&quot;&gt;Caption images&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://arxiv.org/abs/1308.0850&quot;&gt;Generate realistic handwriting&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.isca-speech.org/archive/interspeech_2014/i14_1964.html&quot;&gt;Convert text to speech&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.jmlr.org/proceedings/papers/v48/amodei16.html&quot;&gt;Convert speech to text&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://arxiv.org/abs/1704.03477&quot;&gt;Sketch simple images&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://greydanus.github.io/2017/01/07/enigma-rnn/&quot;&gt;Learn the Enigma cipher&lt;/a&gt; [one of my first projects :D]&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://arxiv.org/abs/1907.03907&quot;&gt;Predict patient ICU data such as aiastolic arterial blood pressure&lt;/a&gt; [Neural ODEs]&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;limitations-of-these-sequence-models&quot;&gt;Limitations of these sequence models&lt;/h2&gt;

&lt;p&gt;Let’s begin with the limitations of RNNs, use them to motivate Neural ODEs, and then discuss the contexts in which even Neural ODEs have shortcomings. The first and most serious limitation of RNNs is that they can only predict the future by way of discrete, uniform “ticks”.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Uniform ticks.&lt;/strong&gt; At each tick they make one observation of the world, perform one read-erase-write operation on their memory, and output one state vector. This seems too rigid. We wouldn’t divide our perception of the world into uniform segments of, say, ten minutes. This would be silly because the important events of our daily routines are not spaced equally apart.&lt;/p&gt;

&lt;p&gt;Consider the game of billiards. When you prepare to strike the cue ball, you imagine how it will collide with other balls and eventually send one of them into a pocket. And when you do this, you do not think about the constant motion of the cue ball as it rolls across the table. Instead, you think about the near-instantaneous collisions between the cue ball, walls, and pockets. Since these collisions are separated by variable amounts of time, making this plan requires that you jump from one collision event to another without much regard for the intervening duration. This is something that RNNs cannot do.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
    &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;padding-right:10px;&quot;&gt;
    &lt;video id=&quot;video_pool&quot; style=&quot;width:100%;min-width:250px;&quot;&gt;
      &lt;source src=&quot;/assets/piecewise-nodes/pool_shot.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;video_pool_button&quot; onclick=&quot;playPausePool()&quot;&gt;Play&lt;/button&gt; 
    &lt;div style=&quot;text-align: left;&quot;&gt;A professional pool player making a remarkable shot. We&apos;ll never know exactly what was going through his head when he did this, but we can say at the very least he was planning over a sequence of collisions. An RNN, by contrast, would focus most of its compute on simulating the linear motion of the ball in between collisions.&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt; 
function playPausePool() { 
  var video = document.getElementById(&quot;video_pool&quot;); 
  var button = document.getElementById(&quot;video_pool_button&quot;);
  if (video.paused) {
    video.play();
  button.textContent = &quot;Pause&quot;;}
  else {
    video.pause(); 
  button.textContent = &quot;Play&quot;;}
} 
&lt;/script&gt;

&lt;p&gt;&lt;strong&gt;Discrete time steps.&lt;/strong&gt; Another issue with RNNs is that they perceive time as a series of discrete “time steps” that connect neighboring states. Since time is actually a continuous variable – it has a definite value even in between RNN ticks – we really should use models that treat it as such. In other words, when we ask our model what the world looked like at time \( t=1.42\) seconds, it should not have to locate the two ticks that are nearest in time and then interpolate between them, as is the case with RNNs. Rather, it should be able to give a well-defined answer.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Avoiding discrete, uniform timesteps with Neural ODEs.&lt;/strong&gt; These problems represent some of the core motivations for Neural ODEs. Neural ODEs parameterize the time derivative of the hidden state and, when combined with an ODE integrator, can be used to model dynamical systems where time is a continuous variable. These models represent a young and rapidly expanding area of machine learning research. One unresolved challenge with these models is getting them to run efficiently with adaptive ODE integrators…&lt;/p&gt;

&lt;p&gt;The problem is that adaptive ODE integrators must perform several function evaluations in order to estimate local curvature when performing an integration step. The curvature information determines how far the integrator can step forward in time, subject to a constant error budget. This is a particularly serious issue in the context of neural networks, which may have very irregular local curvatures at initialization. A single Neural ODE training step can take up to five times longer to evaluate than a comparable RNN architecture, making it challenging to scale these models.&lt;sup id=&quot;fnref:fn7&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn7&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; The curvature problem has, in fact, already motivated some work on regularizing the curvature of Neural ODEs so as to train them more efficiently.&lt;sup id=&quot;fnref:fn6&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn6&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; But even with regularization, these models are more difficult to train than RNNs. Furthermore, there are many tasks where regularizing curvature is counterproductive, for example, modeling elastic collisions between two bodies.&lt;sup id=&quot;fnref:fn18&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn18&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;h2 id=&quot;our-results&quot;&gt;Our Results&lt;/h2&gt;

&lt;p&gt;Our work on piecewise-constant Neural ODEs was an attempt to fix these issues. Our model can jump over different durations of time and can tick more often when a lot is happening and less often otherwise. As I explained earlier, these models are different from regular RNNs in that they predict a hidden state velocity in addition to a hidden state. Taken together, these two quantities represent a linear dynamics function in the RNN’s latent space. A second modification is to have the model predict the duration of time \(\Delta t\) over which its dynamics functions are valid. In some cases, when change is happening at a constant rate, this value can be quite large.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Learning linear motion.&lt;/strong&gt; To show this more clearly, we conducted a simple toy experiment. We created a toy dataset of perfectly linear motion and checked to see whether our model would learn to summarize the whole thing in one step. As the figure below shows, it learned to do exactly that. Meanwhile, the regular RNN had to summarize the same motion in a series of tiny steps.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width: 300px&quot;&gt;
  &lt;img src=&quot;/assets/piecewise-nodes/lines.png&quot; style=&quot;width:100%&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Learning a change of basis.&lt;/strong&gt; Physicists will tell you that the way a system changes over time is only linear with respect to a particular coordinate system. For example, an object undergoing constant circular motion has nonlinear dynamics when we use Cartesian coordinates, but linear dynamics when we use polar coordinates. That’s why physicists use different coordinates to describe different physical systems: &lt;u&gt;&lt;i&gt;all else being equal, the best coordinates are those that are maximally linear with respect to the dynamics.&lt;/i&gt;&lt;/u&gt;&lt;/p&gt;

&lt;p&gt;Since our model forces dynamics to be linear in latent space, the encoder and decoder layers naturally learn to transform input data into a basis where the dynamics are linear. For example, when we train our model on a dataset of circular trajectories represented in Cartesian coordinates, it learns to summarize such trajectories in a single step. This implies that our model has learned a Cartesian-to-Polar change of basis.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width: 300px&quot;&gt;
  &lt;img src=&quot;/assets/piecewise-nodes/circles.png&quot; style=&quot;width:100%&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Learning from pixel videos.&lt;/strong&gt; Our model can learn more complicated change-of-basis functions as well. Later in the paper, we trained our model on pixel observations of two billiards balls. The pixel “coordinate system” is extremely nonlinear with respect to the linear motion of the two balls. And yet our model was able to predict the dynamics of the system far more effectively than the baseline model, while using three times fewer “ticks”. The fact that our model could make jumpy predictions on this dataset implies that it found a basis where the billiards dynamics were linear for significant durations of time – something that is strictly impossible in a pixel basis.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width: 300px&quot;&gt;
  &lt;img src=&quot;/assets/piecewise-nodes/pixel_billiards.png&quot; style=&quot;width:100%&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;In fact, we suspect that forcing dynamics to be linear in latent space actually biased our model to find linear dynamics. We hypothesize that the baseline model performed worse on this task because it had no such inductive bias. This is generally a good inductive bias to build into a model because most real-world dynamics can be approximated with piecewise-linear functions&lt;/p&gt;

&lt;h2 id=&quot;planning&quot;&gt;Planning&lt;/h2&gt;

&lt;p&gt;One of the reasons we originally set out to build this model was that we wanted to use it for planning. We were struck by the fact that many events one would want to plan over – collisions, in the case of billiards – are separated by variable durations of time. We suspected that a model that could jump through uneventful time intervals would be particularly effective at planning because it could plan over the events that really mattered (eg, collisions).&lt;/p&gt;

&lt;p&gt;In order to test this hypothesis, we compared our model to RNN and ODE-RNN baselines on a simple planning task in the billiards environment. The goal was to impart one ball, the “cue ball” (visualized in tan) with an initial velocity such that it would collide with the second ball and the second ball would ultimately enter a target region (visualized in black). You can see videos of such plans at the beginning of this post.&lt;/p&gt;

&lt;p&gt;We found that our model used at least half the wall time of the baselines and produced plans with a higher probability of success. These results are preliminary – and part of ongoing work – but they do support our initial hypothesis.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Simulator&lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Baseline RNN&lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Baseline ODE-RNN&lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Our model&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;85.2%&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;55.6%&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;17.0%&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;61.6%&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width: 300px&quot;&gt;
  &lt;img src=&quot;/assets/piecewise-nodes/planning2d.png&quot; style=&quot;width:45%&quot; /&gt;
&lt;/div&gt;

&lt;!-- Quite a few researchers have wrestled with the fact that RNNs tick through time at a uniform rate. So there are a number of recent projects that aim to make RNNs more temporally abstract. Our work is related, and hopefully complementary, to these approaches. --&gt;

&lt;h2 id=&quot;related-work-aside-from-rnns-and-neural-odes&quot;&gt;Related work aside from RNNs and Neural ODEs&lt;/h2&gt;

&lt;!-- Quite a few researchers have wrestled with the same limitations of RNNs that we have. So there are a number of related works aimed at solving the same issues. Among the most relevant of these works is a family of models called Neural ODEs.

**Neural ODEs.** The past few years have seen a surge of interest in these models. The basic idea of a Neural ODE is to parameterize the derivative of some variable with a neural network and then integrate it. For example, if you wanted to obtain the continuous-time dynamics of a hidden state \\(h_t\\), you would start by setting \\(\frac{\partial h_t}{\partial t}=f_{NN}(h_t)\\) where \\(f_{NN}\\) is a neural network. Then you could integrate that function over time to get dynamics:

$$ h_{t_1} ~=~ h_{t_0} + \int_{t_0}^{t_1} f_{NN}(h_t) ~~ dt $$

One of the remarkable things about this approach is that you can literally integrate your model with an ODE integrator, eg. ``scipy.integrate.solve_ivp``. Likewise, you can backpropagate error signals to your model with a second call to the integrator.

**Connection to our work.** Neural ODEs can be integrated _adaptively_; in other words, the size of the integration step can be made proportional to the local curvature. So in theory, if one were to regularize a Neural ODE to have very low curvature, one might be able to see the same jumpy behavior that we document in Jumpy RNNs. In practice, figuring out how to properly regularize the curvature of these models remains an open question.[^fn6] And current versions of Neural ODEs tend to be _more_ computationally demanding to evaluate than regular RNN models. In a recent paper about modeling RNN hidden state dynamics with ODEs[^fn7], for example, the authors mention that the ODE forward passes took 60% -- 120% longer than standard RNNs since they had to be continuously solved even when no observations were occurring.

Jumpy RNNs resemble Neural ODEs in that they parameterize the derivative of a hidden state. But unlike Neural ODEs, Jumpy RNNs assume that the function being integrated is piecewise-linear and they do not require an ODE solver. The local linearity assumption makes our model extremely efficient to integrate over long spans of time -- much more efficient, for example, than a baseline RNN, and by extension, a Neural ODE.[^fn0]

**Other related works.**  --&gt;

&lt;p&gt;Quite a few researchers have wrestled with the same limitations of RNNs and Neural ODEs that we have in this post. For example, there are a number of other RNN-based models designed with temporal abstraction in mind: Koutnik et al. (2014)&lt;sup id=&quot;fnref:fn1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn1&quot; class=&quot;footnote&quot;&gt;4&lt;/a&gt;&lt;/sup&gt; proposed dividing an RNN internal state into groups and only performing cell updates on the \(i^{th}\) group after \(2^{i-1}\) time steps. More recent works have aimed to make this hierarchical structure more adaptive, either by data-specific rules&lt;sup id=&quot;fnref:fn2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn2&quot; class=&quot;footnote&quot;&gt;5&lt;/a&gt;&lt;/sup&gt; or by a learning  mechanism&lt;sup id=&quot;fnref:fn3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;6&lt;/a&gt;&lt;/sup&gt;. But although these hierarchical recurrent models can model data at different timescales, they still must perform cell updates at every time step in a sequence and cannot jump over regions of homogeneous change.&lt;/p&gt;

&lt;p&gt;For a discussion of these methods (and many others), check out &lt;a href=&quot;https://arxiv.org/abs/2106.06621&quot;&gt;the full paper&lt;/a&gt;, which we link to at the top of this post.
&lt;!-- Another relevant work from reinforcement learning is &quot;Embed to Control&quot;[^fn5]. This work is similar to ours in that it assumes that dynamics are linear in latent space. But unlike our work, the E2C model performs inference over discrete, uniform time steps and does not learn a jumpy behavior. --&gt;&lt;/p&gt;

&lt;h2 id=&quot;closing-thoughts&quot;&gt;Closing thoughts&lt;/h2&gt;

&lt;p&gt;Neural networks are already a widely used tool, but they still have fundamental limitations. In this post, we reckoned with the fact that they struggle at adaptive timestepping and the computational expense of integration. In order to make RNNs and Neural ODEs more useful in more contexts, it is essential to find solutions to such restrictions. With this in mind, we proposed a PC-ODE model which can skip over long durations of comparatively homogeneous change and focus on pivotal events as the need arises. We hope that this line of work will lead to models that can represent time more efficiently and flexibly.&lt;/p&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;

&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn7&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Yulia Rubanova, Ricky TQ Chen, and David Duvenaud. &lt;a href=&quot;https://papers.nips.cc/paper/8773-latent-ordinary-differential-equations-for-irregularly-sampled-time-series&quot;&gt;Latent odes for irregularly-sampled time series&lt;/a&gt;. &lt;em&gt;Advances in Neural Information Processing Systems&lt;/em&gt;, 2019. &lt;a href=&quot;#fnref:fn7&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn6&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Chris Finlay, Jörn-Henrik Jacobsen, Levon Nurbekyan, and Adam M Oberman. &lt;a href=&quot;https://arxiv.org/abs/2002.02798&quot;&gt;How to train your neural ode: the world of jacobian and kinetic regularization&lt;/a&gt;. &lt;em&gt;International Conference on Machine Learning&lt;/em&gt;, 2020. &lt;a href=&quot;#fnref:fn6&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn18&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Jia, Junteng, and Austin R. Benson. &lt;a href=&quot;https://papers.nips.cc/paper/2019/hash/59b1deff341edb0b76ace57820cef237-Abstract.html&quot;&gt;Neural jump stochastic differential equations&lt;/a&gt;. Neural Information Processing Systems, 2019 &lt;a href=&quot;#fnref:fn18&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn1&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Jan Koutnik, Klaus Greff, Faustino Gomez, and Juergen Schmidhuber. &lt;a href=&quot;https://arxiv.org/abs/1402.3511&quot;&gt;A Clockwork RNN&lt;/a&gt;. &lt;em&gt;International Conference on Machine Learning&lt;/em&gt;, pp. 1863–1871, 2014. &lt;a href=&quot;#fnref:fn1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Wang Ling, Isabel Trancoso, Chris Dyer, and Alan W Black. &lt;a href=&quot;https://arxiv.org/abs/1511.04586&quot;&gt;Character-based neural machine translation&lt;/a&gt;. &lt;em&gt;Proceedings of the 54th Annual Meeting of the Association for Computational Linguistics&lt;/em&gt;, 2015. &lt;a href=&quot;#fnref:fn2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Junyoung Chung, Sungjin Ahn, and Yoshua Bengio. &lt;a href=&quot;https://arxiv.org/abs/1609.01704&quot;&gt;Hierarchical multiscale recurrent neural networks&lt;/a&gt;. &lt;em&gt;5th International Conference on Learning Representations&lt;/em&gt;, ICLR 2017. &lt;a href=&quot;#fnref:fn3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name>Sam Greydanus, Stefan Lee, and Alan Fern</name></author><summary type="html">We propose a timeseries model that can be integrated adaptively. It jumps over simulation steps that are predictable and spends more time on those that are not.</summary></entry><entry><title type="html">Scaling down Deep Learning</title><link href="http://greydanus.github.io/2020/12/01/scaling-down/" rel="alternate" type="text/html" title="Scaling down Deep Learning" /><published>2020-12-01T03:00:00-08:00</published><updated>2020-12-01T03:00:00-08:00</updated><id>http://greydanus.github.io/2020/12/01/scaling-down</id><content type="html" xml:base="http://greydanus.github.io/2020/12/01/scaling-down/">&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width: 300px&quot;&gt;
    &lt;div style=&quot;min-width:250px; vertical-align: top; text-align:center;&quot;&gt;
    &lt;video id=&quot;demoDisplay&quot; style=&quot;width:100%;min-width:250px;&quot;&gt;
    	&lt;source src=&quot;/assets/scaling-down/construction.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
    &lt;button class=&quot;playbutton&quot; id=&quot;demo_button&quot; onclick=&quot;playPauseDemo()&quot;&gt;Play&lt;/button&gt; 
    &lt;div style=&quot;text-align:left;&quot;&gt;Constructing the MNIST-1D dataset. As with the original MNIST dataset, the task is to learn to classify the digits 0-9. Unlike the MNIST dataset, which consists of 28x28 images, each of these examples is a one-dimensional sequence of points. To generate an example, we begin with 10 digit templates and then randomly pad, translate, add noise, and transform them as shown above.&lt;/div&gt;
  	&lt;/div&gt;
&lt;/div&gt;

&lt;script language=&quot;javascript&quot;&gt;
	function playPauseDemo() { 
	  var video = document.getElementById(&quot;demoDisplay&quot;);
	  var button = document.getElementById(&quot;demo_button&quot;);
	  if (video.paused) {
	    video.play();
		button.textContent = &quot;Pause&quot;;}
	  else {
	    video.pause(); 
		button.textContent = &quot;Play&quot;;}
	} 
&lt;/script&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
	&lt;a href=&quot;https://twitter.com/samgreydanus/status/1333887306940387329&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Twitter thread&lt;/a&gt;
	&lt;a href=&quot;https://arxiv.org/abs/2011.14439&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Read the paper&lt;/a&gt;
	&lt;a href=&quot;https://bit.ly/3fghqVu&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Run&lt;/span&gt; in browser&lt;/a&gt;
	&lt;a href=&quot;https://github.com/greydanus/mnist1d&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Get the code&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;By any scientific standard, the Human Genome Project &lt;a href=&quot;https://deepblue.lib.umich.edu/handle/2027.42/62798&quot;&gt;was enormous&lt;/a&gt;: it involved billions of dollars of funding, dozens of institutions, and over a decade of accelerated research. But that was only the tip of the iceberg. Long before the project began, scientists were hard at work assembling the intricate science of human genetics. And most of the time, they were not studying humans. The foundational discoveries in genetics centered on far simpler organisms such as peas, molds, fruit flies, and mice. To this day, biologists use these simpler organisms as genetic “minimal working examples” in order to save time, energy, and money. A well-designed experiment with Drosophilia, such as &lt;a href=&quot;https://pubmed.ncbi.nlm.nih.gov/10746727/&quot;&gt;Feany and Bender (2000)&lt;/a&gt;, can teach us an astonishing amount about humans.&lt;/p&gt;

&lt;p&gt;The deep learning analogue of Drosophilia is the MNIST dataset. A large number of deep learning innovations including &lt;a href=&quot;https://jmlr.org/papers/v15/srivastava14a.html&quot;&gt;dropout&lt;/a&gt;, &lt;a href=&quot;https://arxiv.org/abs/1412.6980&quot;&gt;Adam&lt;/a&gt;, &lt;a href=&quot;http://yann.lecun.com/exdb/publis/pdf/lecun-89e.pdf&quot;&gt;convolutional networks&lt;/a&gt;, &lt;a href=&quot;https://arxiv.org/abs/1406.2661&quot;&gt;generative adversarial networks&lt;/a&gt;, and &lt;a href=&quot;https://arxiv.org/abs/1312.6114&quot;&gt;variational autoencoders&lt;/a&gt; began life as MNIST experiments. Once these innovations proved themselves on small-scale experiments, scientists found ways to scale them to larger and more impactful applications.&lt;/p&gt;

&lt;p&gt;They key advantage of Drosophilia and MNIST is that they dramatically accelerate the iteration cycle of exploratory research. In the case of Drosophilia, the fly’s life cycle is just a few days long and its nutritional needs are negligible. This makes it much easier to work with than mammals, especially humans. In the case of MNIST, training a strong classifier takes a few dozen lines of code, less than a minute of walltime, and negligible amounts of electricity. This is a stark contrast to state-of-the-art vision, text, and game-playing models which can take months and &lt;a href=&quot;https://arxiv.org/abs/2004.08900&quot;&gt;hundreds of thousands of dollars&lt;/a&gt; of electricity to train.&lt;/p&gt;

&lt;p&gt;Yet in spite of its historical significance, MNIST has three notable shortcomings. First, it does a poor job of differentiating between linear, nonlinear, and translation-invariant models. For example, logistic, MLP, and CNN benchmarks obtain 94, 99+, and 99+% accuracy on it. This makes it hard to measure the contribution of a CNN’s spatial priors or to judge the relative effectiveness of different regularization schemes. Second, it is somewhat large for a toy dataset. Each input example is a 784-dimensional vector and thus it takes a non-trivial amount of computation to perform hyperparameter searches or debug a metalearning loop. Third, MNIST is hard to hack. The ideal toy dataset should be procedurally generated so that researchers can smoothly vary parameters such as background noise, translation, and resolution.&lt;/p&gt;

&lt;p&gt;In order to address these shortcomings, we propose the MNIST-1D dataset. It is a minimalist, low-memory, and low-compute alternative to MNIST, designed for exploratory deep learning research where rapid iteration is a priority. Training examples are 20 times smaller but they are still better at measuring the difference between 1) linear and nonlinear classifiers and 2) models with and without spatial inductive biases (eg. translation invariance). The dataset is procedurally generated but still permits analogies to real-world digit classification.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:50%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/overview_a.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;padding-bottom: 20px;padding-right:10px&quot;&gt;Constructing the MNIST-1D dataset. Like MNIST, the classifier&apos;s objective is to determine which digit is present in the input. Unlike MNIST, each example is a one-dimensional sequence of points. To generate an example, we begin with a digit template and then randomly pad, translate, and transform it.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:49.4%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/overview_b.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;Visualizing the performance of common models on the MNIST-1D dataset. This dataset separates them cleanly according to whether they use nonlinear features (logistic regression vs. MLP) or whether they have spatial inductive biases (MLP vs. CNN). Humans do best of all. Best viewed with zoom.&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/tsne.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;Visualizing the MNIST and MNIST-1D datasets with tSNE. The well-defined clusters in the MNIST plot indicate that the majority of the examples are separable via a kNN classifier in pixel space. The MNIST-1D plot, meanwhile, reveals a lack of well-defined clusters which suggests that learning a nonlinear representation of the data is much more important to achieve successful classification. Thanks to &lt;a href=&quot;https://twitter.com/hippopedoid&quot;&gt;Dmitry Kobak&lt;/a&gt; for making this plot.&lt;/div&gt;
&lt;/div&gt;

&lt;h2 id=&quot;example-use-cases&quot;&gt;Example use cases&lt;/h2&gt;

&lt;p&gt;In this section we will explore several examples of how MNIST-1D can be used to study core “science of deep learning” phenomena.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Finding lottery tickets.&lt;/strong&gt; It is not unusual for deep learning models to have ten or even a hundred times more parameters than necessary. This overparameterization helps training but increases computational overhead. One solution is to progressively prune weights from a model during training so that the final network is just a fraction of its original size. Although this approach works, conventional wisdom holds that sparse networks do not train well from scratch. Recent work by &lt;a href=&quot;https://arxiv.org/abs/1803.03635&quot;&gt;Frankle &amp;amp; Carbin (2019)&lt;/a&gt; challenges this conventional wisdom. The authors report finding sparse subnetworks inside of larger networks that train to equivalent or even higher accuracies. These “lottery ticket” subnetworks can be found through a simple iterative procedure: train a network, prune the smallest weights, and then rewind the remaining weights to their original initializations and retrain.&lt;/p&gt;

&lt;p&gt;Since the original paper was published, a multitude of works have sought to explain this phenomenon and then harness it on larger datasets and models. However, very few works have attempted to isolate a “minimal working example” of this effect so as to investigate it more carefully. The figure below shows that the MNIST-1D dataset not only makes this possible, but also enables us to elucidate, via carefully-controlled experiments, some of the reasons for a lottery ticket’s success. Unlike many follow-up experiments on the lottery ticket, this one took just two days of researcher time to produce. The curious reader can also &lt;a href=&quot;https://bit.ly/3nCEIaL&quot;&gt;reproduce these results&lt;/a&gt; in their browser in a few minutes.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/lottery_a1.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:100%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/lottery_a2.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;Finding and analyzing lottery tickets. In &lt;b&gt;a-b)&lt;/b&gt;, we isolate a &quot;minimum viable example&quot; of the effect. Recent work by &lt;a href=&quot;https://arxiv.org/abs/1906.02773&quot;&gt;Morcos et al (2019)&lt;/a&gt; shows that lottery tickets can transfer between datasets. We wanted to determine whether spatial inductive biases played a role. So we performed a series of experiments: in &lt;b&gt;c)&lt;/b&gt; we plot the asymptotic performance of a 92% sparse ticket. In &lt;b&gt;d)&lt;/b&gt; we reverse all the 1D signals in the dataset, effectively preserving spatial structure but changing the location of individual datapoints. This is analogous to flipping an image upside down. Under this ablation, the lottery ticket continues to win.&lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/lottery_b1.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:100%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/lottery_b2.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
    &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;Next, in &lt;b&gt;e)&lt;/b&gt; we permute the indices of the 1D signal, effectively removing spatial structure from the dataset. This ablation hurts lottery ticket performance significantly more, suggesting that part of the lottery ticket&apos;s performance can be attributed to a spatial inductive bias. Finally, in &lt;b&gt;f)&lt;/b&gt; we keep the lottery ticket sparsity structure but initialize its weights with a different random seed. Contrary to results reported in &lt;a href=&quot;https://arxiv.org/abs/1803.03635&quot;&gt;Frankle &amp;amp; Carbin (2019)&lt;/a&gt;, we see that our lottery ticket continues to outperform a dense baseline, aligning well with our hypothesis that the lottery ticket mask has a spatial inductive bias. In &lt;b&gt;g)&lt;/b&gt;, we verify our hypothesis by measuring how often unmasked weights are adjacent to one another in the first layer of our model. The lottery ticket has many more adjacent weights than chance would predict, implying a local connectivity structure which helps give rise to spatial biases.&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;You can also visualize the actual masks selected via random and lottery pruning:
&lt;br /&gt;&lt;button class=&quot;playbutton&quot; id=&quot;mask_button&quot; style=&quot;width:150px;&quot; onclick=&quot;hideShowMasks()&quot;&gt;Visualize masks&lt;/button&gt;&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; id=&quot;lottery_masks&quot; style=&quot;display: none; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/lottery_mask_vis.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
    &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;Visualizing first layer weight masks of random tickets and lottery tickets. For interpretabilty, we have sorted the mask along the hidden layer axis according to the number of adjacent unmasked parameters. This helps reveal a bias towards local connectivity in the lottery ticket masks. Notice how there are many more vertically-adjacent unmasked parameters in the lottery ticket masks. These vertically-adjacent parameters correspond to local connectivity along the input dimension, which in turn biases the sparse model towards data with spatial structure. Best viewed with zoom.&lt;/div&gt;
&lt;/div&gt;

&lt;script language=&quot;javascript&quot;&gt;
 function hideShowMasks() {
  var x = document.getElementById(&quot;lottery_masks&quot;);
  var button = document.getElementById(&quot;mask_button&quot;);
  if (x.style.display === &quot;none&quot;) {
    x.style.display = &quot;block&quot;;
    button.textContent = &quot;Hide masks&quot;;
  } else {
    x.style.display = &quot;none&quot;;
    button.textContent = &quot;Visualize masks&quot;;
  }
}
&lt;/script&gt;

&lt;p&gt;&lt;strong&gt;Observing deep double descent.&lt;/strong&gt; Another intriguing property of neural networks is the “double descent” phenomenon. This phrase refers to a training regime where more data, model parameters, or gradient steps can actually &lt;em&gt;reduce&lt;/em&gt; a model’s test accuracy&lt;sup id=&quot;fnref:fn1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn1&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; &lt;sup id=&quot;fnref:fn2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn2&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; &lt;sup id=&quot;fnref:fn3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt; &lt;sup id=&quot;fnref:fn4&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn4&quot; class=&quot;footnote&quot;&gt;4&lt;/a&gt;&lt;/sup&gt;. The intuition is that during supervised learning there is an interpolation threshold where the learning procedure, consisting of a model and an optimization algorithm, is just barely able to fit the entire training set. At this threshold there is effectively just one model that can fit the data and this model is very sensitive to label noise and model mis-specification.&lt;/p&gt;

&lt;p&gt;Several properties of this effect, such as what factors affect its width and location, are not well understood in the context of deep models. We see the MNIST-1D dataset as a good tool for exploring these properties. In fact, we were able to reproduce the double descent pattern after a few hours of researcher effort. The figure below shows our results for a fully-connected network and a convolutional model. We also observed a nuance that we had not seen mentioned in previous works: when using a mean square error loss, the interpolation threshold lies at \(n * K\) model parameters where \(n\) is the number of training examples and \(K\) is the number of model outputs. But when using a negative log likelihood loss, the interpolation threshold lies at \(n\) model parameters – it does not depend on the number of model outputs. This is an interesting empirical observation that may explain some of the advantage in using a log likelihood loss over a MSE loss on this type of task. You can reproduce these results &lt;a href=&quot;https://bit.ly/2UBWWNu&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:46.8%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/ddd_a.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:52.5%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/ddd_b.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;Observing deep double descent. MNIST-1D is a good environment for determining how to locate the interpolation threshold of deep models. This threshold is fairly easy to predict in fully-connected models but less easy to predict for other models like CNNs, RNNs, and Transformers. Here we see that a CNN has a double descent peak at the same interpolation threshold but the effect is much less pronounced.&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Gradient-based metalearning.&lt;/strong&gt; The goal of metalearning is to “learn how to learn.” A model does this by having two levels of optimization: the first is a fast inner loop which corresponds to a traditional learning objective and second is a slow outer loop which updates the “meta” properties of the learning process. One of the simplest examples of metalearning is gradient-based hyperparameter optimization. The concept was was proposed by &lt;a href=&quot;https://ieeexplore.ieee.org/document/6789800&quot;&gt;Bengio (2000)&lt;/a&gt; and then scaled to deep learning models by &lt;a href=&quot;https://arxiv.org/abs/1502.03492&quot;&gt;Maclaurin et al. (2015)&lt;/a&gt;. The basic idea is to implement a fully-differentiable neural network training loop and then backpropagate through the entire process in order to optimize hyperparameters like learning rate and weight decay.&lt;/p&gt;

&lt;p&gt;Metalearning is a promising topic but it is very difficult to scale. First of all, metalearning algorithms consume enormous amounts of time and compute. Second of all, implementations tend to grow complex since there are twice as many hyperparameters (one set for each level of optimization) and most deep learning frameworks are not set up well for metalearning. This places an especially high incentive on debugging and iterating metalearning algorithms on small-scale datasets such as MNIST-1D. For example, it took just a few hours to implement and debug the gradient-based hyperparameter optimization of a learning rate shown below. You can reproduce these results &lt;a href=&quot;https://bit.ly/38OSyTu&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:32.4%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/metalearn_lr_a.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:33%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/metalearn_lr_b.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
    &lt;div style=&quot;width:32%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/metalearn_lr_c.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;Metalearning a learning rate: looking at the third plot, the optimal learning rate appears to be 0.6. Unlike many gradient-based metalearning implementations, ours takes seconds to run and occupies a few dozen lines of code. This allows researchers to iterate on novel ideas before scaling.&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Metalearning an activation function.&lt;/strong&gt; Having implemented a “minimal working example” of gradient-based metalearning, we realized that it permitted a simple and novel extension: metalearning an activation function. With a few more hours of researcher time, we were able to parameterize our classifier’s activation function with a second neural network and then learn the weights using meta-gradients. Shown below, our learned activation function substantially outperforms baseline nonlinearities such as ReLU, Elu&lt;sup id=&quot;fnref:fn5&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn5&quot; class=&quot;footnote&quot;&gt;5&lt;/a&gt;&lt;/sup&gt;, and Swish&lt;sup id=&quot;fnref:fn6&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn6&quot; class=&quot;footnote&quot;&gt;6&lt;/a&gt;&lt;/sup&gt;. You can reproduce these results &lt;a href=&quot;https://bit.ly/38V4GlQ&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:32.7%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/metalearn_afunc_a.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:32.5%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/metalearn_afunc_b.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
    &lt;div style=&quot;width:33%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/metalearn_afunc_c.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;Metalearning an activation function. Starting from an ELU shape, we use gradient-based metalearning to find the optimal activation function of a neural network trained on the MNIST-1D dataset. The activation function itself is parameterized by a second (meta) neural network. Note that the ELU baseline (red) is obscured by the &lt;i&gt;tanh&lt;/i&gt; baseline (blue) in the figure above.&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;We transferred this activation function to convolutional models trained on MNIST and CIFAR-10 images and found that it achieves middle-of-the-pack performance. It is especially good at producing low training loss early in optimization, which is the objective that it was trained on in MNIST-1D. When we rank nonlinearities by final test loss, though, it achieves middle-of-the-pack performance. We suspect that running the same metalearning algorithm on larger models and datasets would further refine our activation function, allowing it to at least match the best hand-designed activation function. We leave this to future work, though.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Measuring the spatial priors of deep networks.&lt;/strong&gt; A large part of deep learning’s success is rooted in “deep priors” which include hard-coded translation invariances (e.g., convolutional filters), clever architectural choices (e.g., self-attention layers), and well-conditioned optimization landscapes (e.g., batch normalization). Principle among these priors is the translation invariance of convolution. A primary motivation for this dataset was to construct a toy problem that could effectively quantify a model’s spatial priors. The second figure in this post illustrates that this is indeed possible with MNIST-1D. One could imagine that other models with more moderate spatial priors would sit somewhere along the continuum between the MLP and CNN benchmarks. Reproduce &lt;a href=&quot;https://bit.ly/3fghqVu&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Benchmarking pooling methods.&lt;/strong&gt; Our final case study begins with a specific question: &lt;em&gt;What is the relationship between pooling and sample efficiency?&lt;/em&gt; We had not seen evidence that pooling makes models more or less sample efficient, but this seemed an important relationship to understand. With this in mind, we trained models with different pooling methods and training set sizes and found that, while pooling tended to be effective in low-data regimes, it did not make much of a difference in high-data regimes. We do not fully understand this effect, but hypothesize that pooling is a mediocre architectural prior which is better than nothing in low-data regimes and then ends up restricting model expression in high-data regimes. By the same token, max-pooling may also be a good architectural prior in the low-data regime, but start to delete information – and thus perform worse compared to L2 pooling – in the high-data regime. Reproduce &lt;a href=&quot;https://bit.ly/3lGmTqY&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:33%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/pooling_a.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:32.3%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/pooling_b.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
    &lt;div style=&quot;width:31.9%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/scaling-down/pooling_c.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;Benchmarking common pooling methods. We observe that pooling helps performance in low-data regimes and hinders it in high-data regimes. While we do not entirely understand this effect, we hypothesize that pooling is a mediocre architectural prior that is better than nothing in low-data regimes but becomes overly restrictive in high-data regimes.&lt;/div&gt;
&lt;/div&gt;

&lt;h2 id=&quot;when-to-scale&quot;&gt;When to scale&lt;/h2&gt;

&lt;p&gt;This post is not an argument against large-scale machine learning research. That sort of research has proven its worth time and again and has come to represent one of the most exciting aspects of the ML research ecosystem. Rather, this post argues &lt;em&gt;in favor&lt;/em&gt; of small-scale machine learning research. Neural networks do not have problems with scaling or performance – but they do have problems with interpretability, reproducibility, and iteration speed. We see carefully-controlled, small-scale experiments as a great way to address these problems.&lt;/p&gt;

&lt;p&gt;In fact, small-scale research is complimentary to large-scale research. As in biology, where fruit fly genetics helped guide the Human Genome Project, we believe that small-scale research should always have an eye on how to successfully scale. For example, several of the findings reported in this post are at the point where they should be investigated at scale. We would like to show that large scale lottery tickets also learn spatial inductive biases, and show evidence that they develop local connectivity. We would also like to try metalearning an activation function on a larger model in the hopes of finding an activation that will outperform ReLU and Swish in generality.&lt;/p&gt;

&lt;p&gt;We should emphasize that we are only ready to scale these results now that we have isolated and understood them in a controlled setting. We believe that scaling a system is only a good idea once the relevant causal mechanisms have been isolated and understood.&lt;/p&gt;

&lt;!-- ## Context

The machine learning community has grown rapidly in recent years. This growth has accelerated the rate of scientific innovation, but it has also produced multiple competing narratives about the field&apos;s ultimate direction and objectives. In this section, we will explore three such narratives in order to place MNIST-1D in its proper context.

**Scaling trends.** One of the defining features of machine learning in the 2010&apos;s was a [massive increase](https://openai.com/blog/ai-and-compute/) in the scale of datasets, models, and compute infrastructure. This scaling pattern allowed neural networks to achieve breakthrough results on a wide range of benchmarks. Yet while this scaling effect has helped neural networks take on commercial and political relevance, opinions differ about how much more &quot;intelligence&quot; it can generate. One one hand, many researchers and organizations argue that [scaling is a crucial path](https://openai.com/blog/ai-and-compute/) to making neural networks behave more intelligently. On the other hand, there is a healthy but marginal population of researchers who are not primarily motivated by scale. They are united by a common desire to change research methodologies, advocating a shift [away from human-engineered datasets and architectures](https://arxiv.org/abs/1905.10985), an [emphasis on human-like learning patterns](https://arxiv.org/abs/1911.01547), and [better integration with traditional symbolic AI approaches](https://arxiv.org/abs/1801.00631).

Once again, the genetics analogy is useful. In genetics, scale has been most effective when small-scale experiments have helped to guide the direction and vision of large-scale experiments. For example, the organizers of the Human Genome Project regularly used yeast and fly genomes to [guide analysis of the human genome](https://deepblue.lib.umich.edu/handle/2027.42/62798). Thus one should be suspicious of research agendas that place disproportionate emphasis on large-scale experiments, since a healthy research ecosystem needs both. The fast, small scale projects permit creativity and deep understanding, whereas the large-scale projects expose fertile new research territory.

**Understanding vs. performance.** Researchers are also divided over the value of understanding versus performance. Some contend that a high-performing algorithm [need not be interpretable](https://youtu.be/93Xv8vJ2acI?t=788) so long as it saves lives or produces economic value. Others argue that hard-to-interpret deep learning models should not be deployed in sensitive real-world contexts. Both arguments have merit, but the best path forward seems to be to focus on understanding high-performing algorithms better so that this tradeoff becomes less severe. One way to do this is by identifying things we don&apos;t understand about neural networks, reproducing these things on a toy problem like MNIST-1D, and then performing ablation studies to isolate the causal mechanisms.

**Ecological impacts.** A growing number of researchers and organizations claim that deep learning will have positive [environmental](https://www.sciencedirect.com/science/article/abs/pii/0304380087900974) [applications](https://arxiv.org/abs/1906.05433). This may be true in the long run, but so far artificial intelligence has done little to solve environmental problems. In the meantime, deep learning models are [consuming massive amounts of electricity](https://arxiv.org/abs/1906.02243) to train and deploy. Our hope is that benchmarks like MNIST-1D will encourage researchers to spend more time iterating on small datasets and toy models before scaling, making more efficient use of electricity in the process.

 --&gt;

&lt;h2 id=&quot;other-small-datasets&quot;&gt;Other small datasets&lt;/h2&gt;
&lt;p&gt;The core inspiration for this work stems from an admiration of and, we daresay, infatuation with the &lt;a href=&quot;http://yann.lecun.com/exdb/mnist/&quot;&gt;MNIST dataset&lt;/a&gt;. While it has some notable flaws – some of which we have addressed – it also has many lovable qualities and underappreciated strengths: it is simple, intuitive, and provides the perfect sandbox for exploring creative new ideas.&lt;/p&gt;

&lt;p&gt;Our work also bears philosophical similarities to the &lt;a href=&quot;https://arxiv.org/abs/2005.13092&quot;&gt;Synthetic Petri Dish&lt;/a&gt; by Rawal et al. (2020). It was published concurrently and the authors make similar references to biology in order to motivate the use of small synthetic datasets for exploratory research. Their work differs from ours in that they use metalearning to obtain their datasets whereas we construct ours by hand. The purpose of the Synthetic Petri Dish is to accelerate neural architecture search whereas the purpose of our dataset is to accelerate “science of deep learning” questions.&lt;/p&gt;

&lt;p&gt;There are many other small-scale datasets that are commonly used to investigate “science of deep learning” questions. The examples in the &lt;a href=&quot;https://www.cs.toronto.edu/~kriz/cifar.html&quot;&gt;CIFAR-10 dataset&lt;/a&gt; are four times larger than MNIST examples but the total number of training examples is the same. CIFAR-10 does a better job of discriminating between MLP and CNN architectures, and between various CNN architectures such as vanilla CNNs versus ResNets. The &lt;a href=&quot;https://github.com/zalandoresearch/fashion-mnist&quot;&gt;FashionMNIST dataset&lt;/a&gt; is the same size as MNIST but a bit more difficult. One last option is &lt;a href=&quot;https://scikit-learn.org/stable/modules/classes.html#module-sklearn.datasets&quot;&gt;Scikit-learn&lt;/a&gt;’s datasets: there are dozens of options, some synthetic and others real. But making real world analogies to, say, digit classification, is not possible and one can often do very well on them using simple linear or kernel-based methods.&lt;/p&gt;

&lt;h2 id=&quot;closing-thoughts&quot;&gt;Closing thoughts&lt;/h2&gt;

&lt;p&gt;There is a counterintuitive possibility that in order to explore the limits of how large we can scale neural networks, we may need to explore the limits of how small we can scale them first. Scaling models and datasets downward in a way that preserves the nuances of their behaviors at scale will allow researchers to iterate quickly on fundamental and creative ideas. This fast iteration cycle is the best way of obtaining insights about how to incorporate progressively more complex inductive biases into our models. We can then transfer these inductive biases across spatial scales in order to dramatically improve the sample efficiency and generalization properties of large-scale models. We see the humble MNIST-1D dataset as a first step in that direction.&lt;/p&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn1&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Trunk, Gerard V. “&lt;a href=&quot;https://ieeexplore.ieee.org/document/4766926&quot;&gt;A problem of dimensionality: A simple example&lt;/a&gt;.” IEEE Transactions on pattern analysis and machine intelligence 3 (1979): 306-307. &lt;a href=&quot;#fnref:fn1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Belkin, Mikhail, et al. “&lt;a href=&quot;https://www.pnas.org/content/116/32/15849&quot;&gt;Reconciling modern machine-learning practice and the classical bias–variance trade-off&lt;/a&gt;.” Proceedings of the National Academy of Sciences 116.32 (2019): 15849-15854. &lt;a href=&quot;#fnref:fn2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Spigler, Stefano, et al. “&lt;a href=&quot;https://arxiv.org/abs/1810.09665&quot;&gt;A jamming transition from under-to over-parametrization affects loss landscape and generalization&lt;/a&gt;.” arXiv preprint arXiv:1810.09665 (2018). &lt;a href=&quot;#fnref:fn3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn4&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Nakkiran, Preetum, et al. “&lt;a href=&quot;https://arxiv.org/abs/1912.02292&quot;&gt;Deep double descent: Where bigger models and more data hurt&lt;/a&gt;.” arXiv preprint arXiv:1912.02292 (2019). &lt;a href=&quot;#fnref:fn4&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn5&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Clevert, Djork-Arné, Thomas Unterthiner, and Sepp Hochreiter. &lt;a href=&quot;https://arxiv.org/abs/1511.07289&quot;&gt;Fast and accurate deep network learning by exponential linear units (elus).&lt;/a&gt; ICLR 2016. &lt;a href=&quot;#fnref:fn5&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn6&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Ramachandran, Prajit, Barret Zoph, and Quoc V. Le. &lt;a href=&quot;https://arxiv.org/abs/1710.05941&quot;&gt;Searching for activation functions&lt;/a&gt;. (2017). &lt;a href=&quot;#fnref:fn6&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html">In order to explore the limits of how large we can scale neural networks, we may need to explore the limits of how small we can scale them first.</summary></entry><entry><title type="html">Optimizing a Wing</title><link href="http://greydanus.github.io/2020/10/14/optimizing-a-wing/" rel="alternate" type="text/html" title="Optimizing a Wing" /><published>2020-10-14T04:00:00-07:00</published><updated>2020-10-14T04:00:00-07:00</updated><id>http://greydanus.github.io/2020/10/14/optimizing-a-wing</id><content type="html" xml:base="http://greydanus.github.io/2020/10/14/optimizing-a-wing/">&lt;p style=&quot;font-size: 20px;text-align: center;color: #999;&quot;&gt;&lt;i&gt;(My last post in a series about human flight; &lt;a target=&quot;_blank&quot; style=&quot;color: #777;&quot; href=&quot;../../../../2020/10/12/story-of-flight/&quot;&gt;post 1&lt;/a&gt;, &lt;a target=&quot;_blank&quot; style=&quot;color: #777;&quot; href=&quot;../../../../2020/10/13/stepping-stones/&quot;&gt;post 2&lt;/a&gt;).&lt;/i&gt;&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; text-align:center; width:80%&quot;&gt;
    &lt;img alt=&quot;&quot; src=&quot;/assets/optimizing-a-wing/wing_shape.png&quot; onclick=&quot;toggleWingShape()&quot; style=&quot;width:315px&quot; id=&quot;wingShapeImage&quot; /&gt;
    &lt;img alt=&quot;&quot; src=&quot;/assets/optimizing-a-wing/wing_flow.png&quot; onclick=&quot;toggleWingFlow()&quot; style=&quot;width:315px&quot; id=&quot;wingFlowImage&quot; /&gt;
	&lt;div class=&quot;thecap&quot; style=&quot;text-align:left;&quot;&gt;&lt;b&gt;Figure 1:&lt;/b&gt; In this post, we&apos;ll simulate a wind tunnel, place a rectangular occlusion in it, and then use gradient descent to turn it into a wing. &lt;p style=&quot;color:grey; display:inline;&quot;&gt;[The images above are videos. Click to pause or play.]&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; text-align:center;&quot;&gt;
	&lt;a href=&quot;https://bit.ly/3j3Wcu4&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Read the paper&lt;/a&gt;
	&lt;a href=&quot;https://bit.ly/2H5r401&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;colab-span&quot;&gt;Run&lt;/span&gt; in browser&lt;/a&gt;
	&lt;a href=&quot;https://github.com/greydanus/optimize_wing&quot; id=&quot;linkbutton&quot; target=&quot;_blank&quot;&gt;Get the code&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;Legos are an excellent meta-toy in that they represent the potential for a near-infinite number of toys depending on how you assemble them. Each brick has structure. But each brick is only interesting to the extent that it can combine with other bricks, forming new and more complex structures. So in order to enjoy Legos, you have to figure out how they fit together and come up with a clever way of making the particular toy you have in mind. Once you have mastered a few simple rules, the open-ended design of Lego bricks lets you build anything you can imagine.&lt;/p&gt;

&lt;p&gt;Our universe has the same versatile structure. It seems to run according to just a few simple forces, but as those forces interact, they give rise to intricate patterns across many scales of space and time. You see this everywhere you look in nature – in the fractal design of a seashell or the intricate polities of a coral. In the convection of a teacup or the circulation of the atmosphere. And this simple structure even determines the shape and behavior of man’s most complicated flying machines.&lt;/p&gt;

&lt;p&gt;To see this more clearly, we are going to start from the basic physical laws of airflow and use them to derive the shape of a wing.&lt;sup id=&quot;fnref:fn18&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn18&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; Since we are using so few assumptions, the wing shape we come up with will be as fundamental as the physics of the air that swirls around it. This is pretty fundamental. In fact, if an alien species started building flying machines on another planet, they would probably converge on a similar shape.&lt;/p&gt;

&lt;h2 id=&quot;navier-stokes&quot;&gt;Navier-Stokes&lt;/h2&gt;

&lt;p&gt;We will begin this journey with the &lt;a href=&quot;https://www.britannica.com/science/Navier-Stokes-equation&quot;&gt;Navier-Stokes equation&lt;/a&gt;, which sums up pretty much everything we know about fluid dynamics. It describes how tiny fluid parcels interact with their neighbors. The process of solving fluid dynamics problems comes down to writing out this equation and then deciding which terms we can safely ignore. In our case, we would like to simulate the flow of air through a wind tunnel and then use it to evaluate various wing shapes.&lt;/p&gt;

&lt;p&gt;Since the pressure differences across a wind tunnel are small, one of the first assumptions we can make is that air is incompressible. This lets us use the &lt;a href=&quot;https://en.wikipedia.org/wiki/Navier%E2%80%93Stokes_equations#Incompressible_flow&quot;&gt;incompressible form&lt;/a&gt; of the Navier-Stokes equation:&lt;/p&gt;

&lt;p&gt;&lt;span id=&quot;longEqnWithSmallScript_A&quot; style=&quot;display:block; margin-left:auto;margin-right:auto;text-align:center;&quot;&gt;
\(\underbrace{\frac{\partial \mathbf{u}}{\partial t}}_{\text{velocity update}} ~=~ - \underbrace{(\mathbf{u} \cdot \nabla)\mathbf{u}}_{\text{self-advection}} ~+~ \underbrace{\nu \nabla^2 \mathbf{u}}_{\text{viscous diffusion}} \\
~+~ \underbrace{f}_{\text{velocity $\uparrow$ due to forces}}\)
&lt;/span&gt;
&lt;span id=&quot;longEqnWithLargeScript_A&quot; style=&quot;display:block; margin-left:auto;margin-right:auto;text-align:center;&quot;&gt;
\(\underbrace{\frac{\partial \mathbf{u}}{\partial t}}_{\text{velocity update}} ~=~ - \underbrace{(\mathbf{u} \cdot \nabla)\mathbf{u}}_{\text{self-advection}} ~+~ \underbrace{\nu \nabla^2 \mathbf{u}}_{\text{viscous diffusion}} ~+~ \underbrace{f}_{\text{velocity $\uparrow$ due to forces}}\)
&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Another term we can ignore is viscous diffusion. Viscous diffusion describes how fluid parcels distribute their momenta due to sticky interactions with their neighbors. We would say that a fluid with high viscosity is “thick”: common examples include molasses and motor oil. Even though air is much thinner, viscous interactions still cause a layer of slow-moving air to form along the surface of an airplane wing. However, we can ignore this boundary layer because its contribution to the aerodynamics of the wing is small compared to that of self-advection.&lt;/p&gt;

&lt;p&gt;The final term we can ignore is the forces term, as there will be no forces on the air once it enters the wind tunnel. And so we are left with but a hair of the original Navier-Stokes hairball:&lt;/p&gt;

\[\underbrace{\frac{\partial \mathbf{u}}{\partial t}}_{\text{velocity update}} = \underbrace{- (\mathbf{u} \cdot \nabla)\mathbf{u}}_{\text{self-advection (&quot;velocity follows itself&quot;)}}\]

&lt;p&gt;This simple expression describes the effects that really dominate wind tunnel physics. It says, intuitively, that “the change in velocity over time is due to the fact that velocity follows itself.” So the entire simulation comes down to two simple rules:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;
		Rule 1: Velocity follows itself &lt;div id=&quot;advection_info_toggle&quot; onclick=&quot;hideShowAdvection()&quot; style=&quot;cursor: pointer;display:inline&quot;&gt;(+)&lt;/div&gt;
		&lt;ul&gt;
		&lt;div id=&quot;advection_info&quot; style=&quot;display: none;&quot;&gt;&lt;i&gt;The technical term for this effect is &quot;self-advection.&quot; Advection is when a field, say, of smoke, is moved around by the velocity of a fluid. Self-advection is a special case where the field being advected is the velocity field, and so it actually advects itself. In principle, a self-advection step is as simple as moving the velocity field according to x&apos; = v * dt + x at every point on the grid. We can simulate self-advection over time by repeating this over and over again.&lt;/i&gt;&lt;/div&gt;
		&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;
		&lt;!-- &lt;b&gt;Rule 1: Velocity follows itself&lt;/b&gt; --&gt;
		Rule 2: Volume is conserved &lt;div id=&quot;projection_info_toggle&quot; onclick=&quot;hideShowProjection()&quot; style=&quot;cursor: pointer;display:inline&quot;&gt;(+)&lt;/div&gt;
		&lt;ul&gt;
		&lt;div id=&quot;projection_info&quot; style=&quot;display: none;&quot;&gt;&lt;i&gt;This rule comes from our incompressibility assumption and the process of enforcing it is called projection. Since volume is conserved, fluid parcels can only move into positions that their neighbors have recently vacated. This puts a strong constraint on our simulation&apos;s velocity field: it needs to be volume-conserving. Fortunately, Helmholtz’s theorem tells us that any vector field can be decomposed into an incompressible field and a gradient field, as a figure from &lt;a href=&quot;https://drive.google.com/file/d/1upKFdtnM0xcTVxNsPHI1KCvmcanAJheL/view?usp=sharing&quot;&gt;this paper&lt;/a&gt; shows:
			&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:70%&quot;&gt;
				&lt;img src=&quot;/assets/optimizing-a-wing/decomposition.png&quot; style=&quot;width:100%&quot; /&gt;
			&lt;/div&gt;
		One way to make our velocity field incompressible is to find the gradient field and then subtract it from the original field as shown above. This &lt;i&gt;projects&lt;/i&gt; our velocity field onto a volume-conserving manifold.&lt;/i&gt;
		&lt;/div&gt;
		&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;By alternating between these two rules, we can iteratively 1) move the system forward in time and 2) enforce conservation of volume and mass. In practice, we implement each rule as a separate function and then apply both functions to the system at every time step. This allows us to simulate, say, a gust of wind passing through the wind tunnel. But before we can direct this wind over a wing, we need to decide how to represent the wing itself.&lt;/p&gt;

&lt;h2 id=&quot;representing-the-wing&quot;&gt;Representing the Wing&lt;/h2&gt;

&lt;div&gt;
&lt;div style=&quot;display:inline&quot;&gt;The wing is an internal boundary, or occlusion, of the flow. A good way to represent an occlusion is with a mask of zeros and ones. But since the goal of our wind tunnel is to try out different wing shapes, we need our wing to be continuously deformable. So we will allow the mask to take on continuous values between zero and one, making it semi-permeable in proportion to its mask values. This lets us add semi-permeable obstructions to the wind tunnel as shown:&lt;/div&gt; &lt;div id=&quot;filter_info_toggle&quot; onclick=&quot;hideShowFilter()&quot; style=&quot;cursor: pointer;display:inline&quot;&gt;(+)&lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;filter_info&quot; style=&quot;display: none;&quot;&gt;&lt;i&gt;&lt;b&gt;A note on filtering.&lt;/b&gt; In practice, the wing is still not quite continuously deformable. Big differences in the mask at neighboring grid points can lead to sharp boundary conditions and non-physical airflows around the mask. One way to reduce this effect is to apply a Gaussian filter around the edges of the mask so as to prevent these grid-level pathologies. This approach may seem a bit arbitrary at first glance, but it is actually a common simulation technique used in, for example, &lt;a href=&quot;https://doi.org/10.1007/s00158-010-0594-7&quot;&gt;topology optimization&lt;/a&gt;, &lt;a href=&quot;https://web.stanford.edu/group/ctr/ResBriefs03/gullbrand.pdf&quot;&gt;large&lt;/a&gt; &lt;a href=&quot;https://doi.org/10.1063/1.3485774&quot;&gt;eddy simulation&lt;/a&gt;, and &lt;a href=&quot;https://graphics.stanford.edu/courses/cs468-03-fall/Papers/Levin_MovingLeastSquares.pdf&quot;&gt;3D graphics&lt;/a&gt;.&lt;/i&gt;&lt;/div&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:19.5%; min-width:150px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/mask/mask_0.00.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;Mask = 0.0&lt;/div&gt;
  &lt;/div&gt;
    &lt;div style=&quot;width:19.5%; min-width:150px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/mask/mask_0.05.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;Mask = 0.05&lt;/div&gt;
  &lt;/div&gt;
    &lt;div style=&quot;width:19.5%; min-width:150px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/mask/mask_0.12.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;Mask = 0.12&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:19.5%; min-width:150px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/mask/mask_0.50.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;Mask = 0.5&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:19.5%; min-width:150px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/mask/mask_1.00.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;Mask = 1.0&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;h2 id=&quot;choosing-an-objective&quot;&gt;Choosing an Objective&lt;/h2&gt;

&lt;p&gt;Now we are at the point where we can simulate how air flows over arbitrary, semi-permeable shapes. But in order to determine which of these shapes makes a better wing, we still need to define a measure of performance. There are many qualities that one could look for in a good wing, but we will begin with the most obvious: it should convert horizontal air velocity into upward force as efficiently as possible. We can measure this ability using something called the lift-drag ratio where “lift” measures the upward force generated by the wing and “drag” measures the frictional forces between the air and the wing. Since “change in downward airflow” in the tunnel is proportional to the upward force on the wing, we can use it as a proxy for lift. Likewise, “change in rightward airflow” is a good proxy for the drag forces on the wing. With this in mind, we can write out the objective function as&lt;/p&gt;

\[\max_{\theta} L/D\]

&lt;p&gt;where \(\theta\) represents some tunable parameters associated with the shape of the wing mask and \(L/D\) can be obtained using the initial and final wind velocities of the simulation according to&lt;/p&gt;

\[\begin{align}
     L/D &amp;amp;= \frac{\text{lift}}{\text{drag}}\\
    &amp;amp;= \frac{\text{change in downward airflow}}{-\text{change in rightward airflow}}\\
    &amp;amp;= \frac{ -\big ( v_y(t)-v_y(0) \big )}{-\big ( v_x(t)-v_x(0) \big )}\\
    &amp;amp;= \frac{ v_y(t)-v_y(0) }{ v_x(t)-v_x(0)}
\end{align}\]

&lt;p&gt;Solving this optimization problem will give us a wing shape that generates the most efficient lift possible. In other words, we new have the correct problem setup; what remains is to figure out how to solve it.&lt;/p&gt;

&lt;h2 id=&quot;optimization&quot;&gt;Optimization&lt;/h2&gt;

&lt;div&gt;
&lt;div style=&quot;display:inline&quot;&gt;We are going to solve this problem with gradient ascent. Gradient ascent is simple and easy to implement, but there is one important caveat: we need a way to efficiently compute the gradient of the objective function with respect to the wing mask parameters. This involves differentiating through each step of the fluid simulation in turn – all of the way back to the initial conditions. This would be difficult to implement by hand, but fortunately there is a tool called &lt;a href=&quot;https://github.com/HIPS/autograd&quot;&gt;Autograd&lt;/a&gt; which can perform this back-propagation of gradients automatically. We will use Autograd to compute the gradients of the mask parameters, move the mask parameters in that direction, and then repeat this process until the lift-drag ratio reaches a local maximum.&lt;/div&gt; &lt;div id=&quot;autograd_info_toggle&quot; onclick=&quot;hideShowAutograd()&quot; style=&quot;cursor: pointer;display:inline&quot;&gt;(+)&lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;autograd_info&quot; style=&quot;display: none;&quot;&gt;&lt;i&gt;&lt;b&gt;A note on Autograd.&lt;/b&gt; Amazingly, every mathematical operation we&apos;ve described so far – from the wing masking operation to the advection and projection functions to the lift-drag ratio – is differentiable. This is why we can use Autograd to compute analytic gradients with respect to the mask parameters. Autograd uses &lt;a href=&quot;https://en.wikipedia.org/wiki/Automatic_differentiation&quot;&gt;automatic differentiation&lt;/a&gt;, closely related to the &lt;a href=&quot;http://www.dolfin-adjoint.org/en/latest/documentation/maths/2-problem.html&quot;&gt;adjoint method&lt;/a&gt;, to propagate gradient information backwards through the simulation until it reaches the parameters of the wing mask. We can do all of this in a one-line function transformation:&lt;code&gt;grad_fn = autograd.value_and_grad(get_lift_drag_ratio)&lt;/code&gt;.&lt;/i&gt;&lt;/div&gt;

&lt;p&gt;So let’s review. Our goal is to simulate a wind tunnel and use it to derive a wing shape. We began by writing down the general Navier-Stokes equation and eliminating irrelevant terms: all of them but self-advection. Next, we figured out how to represent a wing shape in the tunnel using a continuously-deformable occlusion. Finally, we wrote down an equation for what a good wing should do and discussed how to optimize it. Now it is time to put everything together in about two hundred lines of code and see what happens when we run it…&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%; min-width: 300px; text-align:center;&quot;&gt;
	&lt;img alt=&quot;&quot; src=&quot;/assets/optimizing-a-wing/optimize_wing.png&quot; /&gt;
&lt;/div&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:43%; min-width: 300px; text-align:center;&quot;&gt;
	&lt;p style=&quot;display:inline;&quot;&gt;&lt;div style=&quot;color:black;font-size: 18px&quot;&gt;Final result&lt;/div&gt; &lt;div style=&quot;color:grey;&quot;&gt;[Click image to pause or play.]&lt;/div&gt;&lt;/p&gt;
	&lt;img style=&quot;width:100%&quot; alt=&quot;&quot; src=&quot;/assets/optimizing-a-wing/wing.png&quot; onclick=&quot;toggleBasicWing()&quot; id=&quot;basicWing&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;Sure enough, we get a beautiful little wing. Of all possible shapes, this is the very best one for creating efficient lift in our wind tunnel. This wing is definitely a toy solution since our simulation is coarse and not especially accurate. However, after making a few simple improvements we would be able to design real airplane wings this way. We would just need to:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Simulate in 3D instead of 2D&lt;/li&gt;
  &lt;li&gt;Use a mesh parameterization instead of a grid&lt;/li&gt;
  &lt;li&gt;Make the flow laminar and compressible&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Aside from these improvements, the overall principle is much the same. In both cases, we write down some words and symbols, turn them into code, and then use the code to shape our wing.&lt;sup id=&quot;fnref:fn14&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn14&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; The fact that we can do all of this without ever building a physical wing makes it feel a bit like magic. But this process really works, for when we &lt;a href=&quot;http://aero-comlab.stanford.edu/Papers/jameson-cincin-pm.pdf#page=36&quot;&gt;put these wings on airplanes&lt;/a&gt; and trust them with our lives, they carry us safely to our destinations.&lt;sup id=&quot;fnref:fn3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt; &lt;sup id=&quot;fnref:fn17&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn17&quot; class=&quot;footnote&quot;&gt;4&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;Just like the real wind tunnels of the twentieth century, these simulated wind tunnels need to go through lots of debugging before we can trust them. In fact, while building this demo we discovered a number of ways that things can go wrong. Here are some of the most amusing failure cases:&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
	&lt;img src=&quot;/assets/optimizing-a-wing/sim_bloopers.png&quot; style=&quot;width:100%&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;Several of these wings are just plain dreadful. But others seem reasonable, if unexpected. The two-wing solution is particularly amusing. We did not intend for this “biplane” solution to occur, and yet it is a completely viable way of solving the objective we wrote down. One advantage to keeping the problem setup so simple is that, in doing so, we left space for these surprising behaviors to occur.&lt;/p&gt;

&lt;h2 id=&quot;the-manifold-of-solutions&quot;&gt;The Manifold of Solutions&lt;/h2&gt;

&lt;p&gt;There are variations on the base wing shape which excel in particular niches. Sometimes we will want a wing that is optimal at high speeds and other times we will want one that is optimal at low speeds. In order to accommodate a large fuselage, we might want an extra-thick wing. Alternatively, in order to reduce its overall weight, we might want to keep it thin. It turns out that we can change simulation parameters and add auxiliary losses to find optimal wing shapes for each of these scenarios.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:60%; min-width: 300px&quot;&gt;
	&lt;img src=&quot;/assets/optimizing-a-wing/sim_manifold.png&quot; style=&quot;width:100%&quot; /&gt;
&lt;/div&gt;
&lt;p&gt;Our wind tunnel simulation is interesting first, because it illustrates how the Platonic ideal of wing design is rooted in the laws of physics. As we saw in the earlier posts, there were many cultural and technological forces that contributed to airfoil design. These forces were important for many reasons, but they were not the primary factor in the wing shapes they produced – physics was.&lt;/p&gt;

&lt;p&gt;But to balance this idea, we have also shown how a million variants of the Platonic form of a wing can fulfill particular needs. Indeed, these variants could be said to occupy complimentary niches in the same way that different birds and flying insects occupy different niches in nature. After all, even though nature follows the laws of physics with absolute precision, she takes a consummate joy in variation. Look at the variety of wing shapes in birds, for example.&lt;sup id=&quot;fnref:fn4&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn4&quot; class=&quot;footnote&quot;&gt;5&lt;/a&gt;&lt;/sup&gt; Species of hummingbirds have wings with low aspect ratios that enable quick, agile flight patterns. Other birds, like the albatross, have high aspect ratios for extreme efficiency. Still others, like the common raven, are good all-around fliers. Remarkably, we are beginning to see this same speciation occur in modern aircraft as well. There are surveillance planes built for speed and stealth, short-winged bush planes built for maneuverability, and massive commercial airliners built for efficiency.&lt;sup id=&quot;fnref:fn5&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn5&quot; class=&quot;footnote&quot;&gt;6&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:36.4815%; min-width:200px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/bird_shapes.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;A figure from &lt;a href=&quot;https://doi.org/10.2307/3677110&quot;&gt;Lockwood (1998)&lt;/a&gt; arranging bird species by wing pointedness and wingtip convexity. Different wing designs stem from adaptations to different ecological niches.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:62.073%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/norberg2002.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;A plot by &lt;a href=&quot;https://doi.org/10.1002/jmor.10013&quot;&gt;Lindhe (2002)&lt;/a&gt; showing aspect ratio versus wing loading index in some birds, airplanes, a hang-glider, a butterfly, and a maple seed. Just like the families of birds, different human flying machines display substantial variation along these axes.&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Perhaps less intuitively, even a single bird is capable of a huge range of wing shapes. The falcon, for example, uses different wing shapes for soaring, diving, turning, and landing. Its wings are not static things, but rather deformable, dynamic objects which are constantly adapting to their surroundings. And once again, we are beginning to see the same thing happen in modern aircrafts like the Boeing 747. The figure below shows how its triple-slotted wing design lets pilots reconfigure the airfoil shape during takeoff, cruising, and landing.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:55%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/bird_morph.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:44.3%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/optimizing-a-wing/plane_morph.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;h2 id=&quot;closing-thoughts&quot;&gt;Closing Thoughts&lt;/h2&gt;

&lt;p&gt;One of the lessons from attempting to optimize a wing is that the optimization itself is never the full story. When we write down the optimization objective (like we did above), our minds already have a vague desire to obtain a wing. And behind that desire, our minds may want to obtain a wing because we are drawn to the technology of flight. And perhaps we are drawn to flight for the same reasons that the early aviators were – because it promises freedom, glory, and adventure. And behind those desires – what? The paradox of an objective function is that it always seems to have a deeper objective behind it.&lt;/p&gt;

&lt;p&gt;The deeper objectives do not change as quickly. Even as the early aviators progressed from wingsuits to gliders to planes, they retained the same fundamental desire to fly. Their specific desires, of course, were different: some wanted to survive a tower jump and others wanted to break the speed of sound. And their specific desires led to specific improvements in technology such as a better understanding of the Smeaton coefficient or a stable supercritical airfoil. Once they made these improvements, the next generation was able to use them to pursue more ambitious goals. But even as this cycle progressed, the more deeply-held desire to fly continued to inspire and unify their efforts.&lt;/p&gt;

&lt;!-- The desire to fly is remarkable in that it is something that our biology alone cannot satisfy. In this way we are a bit like hermit crabs -- creatures who are born without the ability to grow a shell and yet need one to survive as adults. As they mature, they must cast about their tide pools for a suitable shell. And when they find one, they clean it, fit themselves to it, and their bodies grow or shrink to make the fit perfect. But whereas hermit crabs seek out shells because they want safety, humans seek out flight because they are after things like freedom, adventure, and beauty. We are not trying to achieve stasis; rather, we are aiming for a future that is different and better. That is what made us a flying species in the first place and that is what will propel us even higher tomorrow. --&gt;
&lt;div class=&quot;imgcap_noborder&quot; style=&quot;text-align:center&quot;&gt;
  &lt;img src=&quot;/assets/optimizing-a-wing/hummingbird.png&quot; style=&quot;width:15%;min-width:150px;&quot; /&gt;
&lt;/div&gt;

&lt;!-- So we beat on, wings angled into the wind, borne ceaselessly into the future. --&gt;

&lt;h2 id=&quot;thanks&quot;&gt;Thanks&lt;/h2&gt;

&lt;p&gt;Thanks to Maclaurin et al. (2018) for releasing Autograd&lt;sup id=&quot;fnref:fn18:1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn18&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; to the world along with a number of thought-provoking demos.
Thanks to Stephan Hoyer, Shan Carter, and Matthew Johnson for conversations that shaped some of the early versions
of this work. And thanks to Andrew Sosanya, Jason Yosinski, and Tina White for feedback on early versions of this
essay. Special thanks to my family and friends for serving as guinea pigs for early iterations of this story.&lt;/p&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;

&lt;script language=&quot;javascript&quot;&gt;
	function toggleWingShape() {

		path = document.getElementById(&quot;wingShapeImage&quot;).src
	    if (path.split(&apos;/&apos;).pop() == &quot;wing_shape.png&quot;) {
	        document.getElementById(&quot;wingShapeImage&quot;).src = &quot;/assets/optimizing-a-wing/wing_shape.gif&quot;;
	    } else {
	        document.getElementById(&quot;wingShapeImage&quot;).src = &quot;/assets/optimizing-a-wing/wing_shape.png&quot;;
	    }
	}
&lt;/script&gt;

&lt;script language=&quot;javascript&quot;&gt;
	function toggleWingFlow() {

		path = document.getElementById(&quot;wingFlowImage&quot;).src
	    if (path.split(&apos;/&apos;).pop() == &quot;wing_flow.png&quot;) {
	        document.getElementById(&quot;wingFlowImage&quot;).src = &quot;/assets/optimizing-a-wing/wing_flow.gif&quot;;
	    } else {
	        document.getElementById(&quot;wingFlowImage&quot;).src = &quot;/assets/optimizing-a-wing/wing_flow.png&quot;;
	    }
	}

function toggleBasicWing() {

    path = document.getElementById(&quot;basicWing&quot;).src
      if (path.split(&apos;/&apos;).pop() == &quot;wing.png&quot;) {
          document.getElementById(&quot;basicWing&quot;).src = &quot;/assets/optimizing-a-wing/wing_flow.gif&quot;;
      } else {
          document.getElementById(&quot;basicWing&quot;).src = &quot;/assets/optimizing-a-wing/wing.png&quot;;
      }
  }

function hideShowAdvection() {
  var x = document.getElementById(&quot;advection_info&quot;);
  var y = document.getElementById(&quot;advection_info_toggle&quot;);
  if (x.style.display === &quot;none&quot;) {
    x.style.display = &quot;inline&quot;; y.textContent = &quot;(–)&quot;
  } else {
    x.style.display = &quot;none&quot;; y.textContent = &quot;(+)&quot;
  }
}
function hideShowProjection() {
  var x = document.getElementById(&quot;projection_info&quot;);
  var y = document.getElementById(&quot;projection_info_toggle&quot;);
  if (x.style.display === &quot;none&quot;) {
    x.style.display = &quot;inline&quot;; y.textContent = &quot;(–)&quot;
  } else {
    x.style.display = &quot;none&quot;; y.textContent = &quot;(+)&quot;
  }
}
function hideShowFilter() {
  var x = document.getElementById(&quot;filter_info&quot;);
  var y = document.getElementById(&quot;filter_info_toggle&quot;);
  if (x.style.display === &quot;none&quot;) {
    x.style.display = &quot;inline&quot;; y.textContent = &quot;(–)&quot;
  } else {
    x.style.display = &quot;none&quot;; y.textContent = &quot;(+)&quot;
  }
}
function hideShowAutograd() {
  var x = document.getElementById(&quot;autograd_info&quot;);
  var y = document.getElementById(&quot;autograd_info_toggle&quot;);
  if (x.style.display === &quot;none&quot;) {
    x.style.display = &quot;inline&quot;; y.textContent = &quot;(–)&quot;
  } else {
    x.style.display = &quot;none&quot;; y.textContent = &quot;(+)&quot;
  }
}
&lt;/script&gt;

&lt;script&gt;
    function getBrowserSize(){
       var w, h;

         if(typeof window.innerWidth != &apos;undefined&apos;)
         {
          w = window.innerWidth; //other browsers
          h = window.innerHeight;
         } 
         else if(typeof document.documentElement != &apos;undefined&apos; &amp;&amp; typeof      document.documentElement.clientWidth != &apos;undefined&apos; &amp;&amp; document.documentElement.clientWidth != 0) 
         {
          w =  document.documentElement.clientWidth; //IE
          h = document.documentElement.clientHeight;
         }
         else{
          w = document.body.clientWidth; //IE
          h = document.body.clientHeight;
         }
       return {&apos;width&apos;:w, &apos;height&apos;: h};
}

if(parseInt(getBrowserSize().width) &lt; 600){
 document.getElementById(&quot;longEqnWithLargeScript_A&quot;).style.display = &quot;none&quot;;
}
if(parseInt(getBrowserSize().width) &gt; 600){
 document.getElementById(&quot;longEqnWithSmallScript_A&quot;).style.display = &quot;none&quot;;
}
&lt;/script&gt;

&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn18&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Specifically, we build on ideas laid out in &lt;a href=&quot;https://github.com/HIPS/autograd/blob/master/examples/fluidsim/wing.png&quot;&gt;Maclaurin et al. (2018)&lt;/a&gt;. &lt;a href=&quot;#fnref:fn18&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt; &lt;a href=&quot;#fnref:fn18:1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn14&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;See &lt;a href=&quot;https://optimization.mccormick.northwestern.edu/index.php/Wing_Shape_Optimization&quot;&gt;this online textbook page&lt;/a&gt; for an overview of full-scale wing optimization techniques. &lt;a href=&quot;#fnref:fn14&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Jameson, Antony and Vassberg, John. &lt;a href=&quot;https://doi.org/10.2514/6.2001-538&quot;&gt;Computational fluid dynamics for aerodynamic design - Its current and future impact&lt;/a&gt;, &lt;em&gt;American Institute of Aeronautics &amp;amp; Astronautics&lt;/em&gt;, 2012. &lt;a href=&quot;#fnref:fn3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn17&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Jameson, Antony. &lt;a href=&quot;http://aero-comlab.stanford.edu/Papers/AirplaneDesignShanghai.pdf&quot;&gt;Airplane Design with Aerodynamic Shape Optimization&lt;/a&gt;, &lt;em&gt;Commercial Aircraft Company of China, Shanghai&lt;/em&gt;, 2010. &lt;a href=&quot;#fnref:fn17&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn4&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Lockwood, Rowan and Swaddle, John P. and Rayner, Jeremy M. V. &lt;a href=&quot;https://doi.org/10.2307/3677110&quot;&gt;Avian Wingtip Shape Reconsidered: Wingtip Shape Indices and Morphological Adaptations to Migration&lt;/a&gt;, &lt;em&gt;Journal of Avian Biology&lt;/em&gt; Vol. 29, No. 3, pp. 273-292, 1998. &lt;a href=&quot;#fnref:fn4&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn5&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Norberg, Ulla M. Lindhe. &lt;a href=&quot;https://doi.org/10.1002/jmor.10013&quot;&gt;Structure, Form, and Function of Flight in Engineering and the Living World&lt;/a&gt;. &lt;em&gt;Journal of Morphology&lt;/em&gt;, 2002. &lt;a href=&quot;#fnref:fn5&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html">How does physics shape flight? To show how fundamental wings are, I derive one from scratch by differentiating through a wind tunnel simulation.</summary></entry><entry><title type="html">The Stepping Stones of Flight</title><link href="http://greydanus.github.io/2020/10/13/stepping-stones/" rel="alternate" type="text/html" title="The Stepping Stones of Flight" /><published>2020-10-13T04:00:00-07:00</published><updated>2020-10-13T04:00:00-07:00</updated><id>http://greydanus.github.io/2020/10/13/stepping-stones</id><content type="html" xml:base="http://greydanus.github.io/2020/10/13/stepping-stones/">&lt;p&gt;By the year 1900, humans seemed to have figured out all the important ideas of aviation. There were patents for dozens of self-powered aircrafts including biplanes,&lt;sup id=&quot;fnref:fn1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn1&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; seaplanes,&lt;sup id=&quot;fnref:fn2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn2&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; and bombers.&lt;sup id=&quot;fnref:fn3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt; There were also designs for retractable landing gear,&lt;sup id=&quot;fnref:fn4&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn4&quot; class=&quot;footnote&quot;&gt;4&lt;/a&gt;&lt;/sup&gt; aileron wing controls,&lt;sup id=&quot;fnref:fn5&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn5&quot; class=&quot;footnote&quot;&gt;5&lt;/a&gt;&lt;/sup&gt; and curved airfoils.&lt;sup id=&quot;fnref:fn6&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn6&quot; class=&quot;footnote&quot;&gt;6&lt;/a&gt;&lt;/sup&gt; To many people, these designs indicated that the age of the airplane was at hand. Indeed, by this time there were already two commercial airline startups&lt;sup id=&quot;fnref:fn7&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn7&quot; class=&quot;footnote&quot;&gt;7&lt;/a&gt;&lt;/sup&gt; and one program for constructing bombers, fully funded by the French government.&lt;sup id=&quot;fnref:fn3:1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt; But there was just one problem: nobody had managed to fly a real airplane yet. In fact, the Wright brothers were still several years from achieving that breakthrough. As for bombers, seaplanes, and airline companies – such things were still many decades away.&lt;/p&gt;

&lt;p&gt;This bizarre gap between theory and practice brings into question the meaning of the word invention. Generally speaking, one would think of an invention as a detailed design of the sort that could be patented. But in the case of the airplane, dozens of people patented airplanes that never could have flown. Did those people really invent airplanes? Otto Lilienthal, the first glider pilot, would have answered in the negative. “To design an aircraft is nothing” he wrote, “To build one is something. But to fly is everything.”&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot;&gt;
  &lt;img src=&quot;/assets/stepping-stones/lilienthal.png&quot; style=&quot;width:35%; min-width:250px&quot; /&gt;
  &lt;div style=&quot;text-align: center;&quot;&gt;Otto Lilienthal&lt;/div&gt;
&lt;/div&gt;

&lt;h3 id=&quot;airfoils&quot;&gt;Airfoils&lt;/h3&gt;

&lt;p&gt;In order to focus on the practical stepping stones of flight, let’s adopt Lilienthal’s perspective. In other words, let’s focus on the changes in wing design that led to the most significant empirical improvements in flight. When we start down this path, one of the first things we notice is that most of these improvements are related to the cross-sectional shape of a wing, also known as the airfoil. Generally speaking, an airfoil has no moving parts. In fact, it is just a two-dimensional shape that influences the speed of air above and below a wing. Prior to the Wright brothers, few people gave serious thought to airfoil design. But it just so happened that the details of this shape play a critical role in determining the lift and drag profile of a wing. Only through repeated iteration of design and demonstration did we become aware of the airfoil’s surprising complexity.&lt;/p&gt;

&lt;p&gt;Lilienthal, with his emphasis on practical results, was the first person to realize how much airfoils matter. They came to his attention when he set out to build a glider that could support the weight of a man. In order to build such an apparatus, he needed to know how the lift and drag characteristics of various wings scaled with length, width, and thickness. In thinking about these questions, he quickly realized that the cross-sectional shape was an important design parameter. He started by studying the airfoils of bird wings, especially those of storks. Then, with their shapes in mind, he built artificial replicas in his laboratory and tested their lift coefficients. These methodical experiments took nearly twenty years of work, after which he published his findings in his thorough (and beautifully illustrated) book, &lt;em&gt;Birdflight as the Basis of Aviation&lt;/em&gt;.&lt;sup id=&quot;fnref:fn14&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn14&quot; class=&quot;footnote&quot;&gt;8&lt;/a&gt;&lt;/sup&gt; Taking what he had learned from biology, Lilienthal spent the latter part of his life building and flying human-scale gliders – the first winged flying machines that could carry a human through the air. And so, with an eye on nature and great attention to detail, Lilienthal achieved the goal he had been working towards since his twenties.&lt;/p&gt;

&lt;p&gt;But even Lilienthal, for all his care, made some errors. The Wright brothers used his results to design their first glider, and when that glider crashed unexpectedly, they realized that something was wrong. After performing their own set of wind tunnel experiments, they determined that the widely-accepted value of the Smeaton coefficient – a key part of Lilienthal’s lift and drag equations – was about 60% too high.&lt;sup id=&quot;fnref:fn15&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn15&quot; class=&quot;footnote&quot;&gt;9&lt;/a&gt;&lt;/sup&gt; Starting from this discovery, they reworked their entire wing design. They tested out hundreds of airfoils in a miniature wind tunnel and finally settled on a new airfoil shape. It was slightly wider and more arched, and the highest point of its arch was closer to the front of the wing (more “forward camber”). In spite of these changes, it looked only slightly different from their original wing shape. And yet its improved lift and stability was what the Wrights needed in order to build the world’s first self-propelled airplane.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:53%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/storks.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;A figure from Otto Lilienthal&apos;s book &lt;a href=&quot;http://www.luftfahrt-bibliothek.de/datenarchiv/otto-lilienthal-der-vogelflug-als-grundlage-der-fliegekunst.pdf&quot;&gt;&lt;i&gt;Birdflight as the Basis of Aviation&lt;/i&gt;&lt;/a&gt;. Lilienthal studied bird wings and carried out small scale experiments for two decades (1867-1889) in preparation for building his gliders.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:45%; min-width:250px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/lilienthal_vs_wright.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;Years of careful experiments by the Wright brothers yielded a new wing shape with a slightly more forward camber. This seemingly small change was crucial to the &lt;i&gt;Flyer&apos;s&lt;/i&gt; success..&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Although Lilienthal and the Wrights lived on different continents and had very different lives, they were united by the fact that they each spent years doing tedious, small-scale experiments in order to understand flight on a deep level. Only after this exploratory phase did they build real flying machines. In a way, those long hours of tedium are a sacrifice one must make when they set out to pursue the romantic ideal of flight. In profiling the early aviators, we saw that the frontier of flight often attracted radical and temperamental dreamers. These were not reliable people. And yet each of them had to discipline and civilize themselves, becoming the most practical of the lot of us, before they could become heroes. Interestingly, the next breakthroughs in flight were to involve the same dynamic, but this time playing out across nations rather than individuals. This was the era of the national labs.&lt;/p&gt;

&lt;h3 id=&quot;the-national-labs&quot;&gt;The National Labs&lt;/h3&gt;

&lt;p&gt;National labs were a new phenomenon that emerged in the 1910’s and 1920’s as forward-thinking governments started to reckon with the military and economic applications of flight. Leading up to World War I, airplanes were still slow, unreliable, and expensive. They were great for stunts and parades, but close to useless on the battlefield. One of the main goals of the national labs was to change this.&lt;/p&gt;

&lt;p&gt;The first improvements in airfoil design came out of Britain’s National Physical Laboratory. Managers at this lab used its infrastructure and manpower to test airfoil designs much more thoroughly than the hobbyist-inventors before them. One of their key findings was that thicker wings with even more forward camber gave better lift. As soon as they made this discovery, they built it into military planes like the Airco DH.2 fighter (1915) and the Vickers Vimy bomber (1917).&lt;/p&gt;

&lt;p&gt;But even though these changes in airfoil design improved lift, they did not improve stability. World War I era biplanes suffered from a dangerous effect called “thin airfoil stall.” This effect occurred when streams of air above and below a wing collided behind it, creating unpredictable drag and sending the plane into a stall. German engineers were the first to find a solution to this problem. They found that thicker airfoils like the Göttingen 398 could mitigate thin airfoil stall and make fighter planes more maneuverable. They used these insights to build the Fokker Dr. I (1917) which was one of the most dangerous fighters of the war.&lt;sup id=&quot;fnref:fn8&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn8&quot; class=&quot;footnote&quot;&gt;10&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;The most amazing thing about flight research during World War I was the speed at which national labs turned research into real technology. Often it only took a year or two. The condensed timeline and extreme real-world impact of airplanes led to dramatic improvements in their designs and finalized their transition from the world of ideas to the world of things. And the wonderful thing about having an idea take root in the world is its tendency to become the bedrock for an entirely new generation of ideas.&lt;/p&gt;

&lt;p&gt;That is the story of the 1920’s and 1930’s, which is when the mathematical theory of flight got started. Government physicists in the United States finally had time to come up with theories that explained experimental results. Then they used these theories to make airfoils better in small but important ways. Their work culminated in the 1933 National Advisory Committee for Aeronautics (NACA) Report 460, which set the industry standard for the next several decades. World War II planes like the DC-2 transport and the B-17 Flying Fortress used these results.&lt;sup id=&quot;fnref:fn9&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn9&quot; class=&quot;footnote&quot;&gt;11&lt;/a&gt;&lt;/sup&gt; And after the war, designs like the NACA 2412 found their way into commercial plane designs, some of which are still in use today.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:32.6%; min-width:220px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/wright_tunnel.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;The 1901 wind tunnel that the Wright brothers used to study airfoil shapes.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:28.2%; min-width:220px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/langley.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;A man standing in the enormous Langley wind tunnel in 1925.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:38.1%; min-width:220px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/ww1_vs_laminar.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;The progression of notable airfoils developed by national labs between 1915 and 1945.&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;The process of minor improvements based on theory continued into the 1940’s, when NACA researchers invented the laminar flow airfoil and installed it on the P-51 Mustang.&lt;sup id=&quot;fnref:fn9:1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn9&quot; class=&quot;footnote&quot;&gt;11&lt;/a&gt;&lt;/sup&gt; In practice, the laminar flow “correction” was rather small and it led to modest improvements. But it represented a milestone in that it was one of the first major innovations motivated by theory rather than human intuition or observations of biology. Focusing on the causal mechanisms of flight ended up being crucial for later innovations in the supersonic regime since the way air behaves at those speeds is much less intuitive.&lt;/p&gt;

&lt;p&gt;In fact, there is a deep connection between how well we understand the laws of nature and what we can build in the world. The laws of nature are the rules of the game. We are constantly learning more about these rules and we can only innovate in proportion to how well we understand them. To see this, consider evolution for a moment. Over millions of years, it has deformed life so as to probe the laws of nature at many different scales. So with time, the fundamental forces of nature have constrained and shaped life into the variety of forms we see today. Human design mimics this trial-and-error approach, but our mental models of the world give us an advantage. They speed our search in proportion to how much of the physical world they can explain. And by acting on our mental models, we can make intuitive leaps that evolution, in all of its billions of years, never could have managed. One such intuitive leap was made by Richard Whitcomb when he discovered supercritical airfoils.&lt;/p&gt;

&lt;h3 id=&quot;supercritical-airfoils&quot;&gt;Supercritical Airfoils&lt;/h3&gt;

&lt;p&gt;This discovery occurred in 1965, which was a time when the aerospace industry was trying to improve supersonic flight. Jet engines, which were invented at the end of World War II, had improved to the point where they produced enough force to accelerate planes to supersonic speeds. But once planes reached these speeds, the physics of airflow started to change and existing airfoil designs stopped working. NACA researchers realized that they would have to rethink every aspect of wing design in order to adapt. One of the most challenging problems was what to do with airfoil design.&lt;sup id=&quot;fnref:fn9:2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn9&quot; class=&quot;footnote&quot;&gt;11&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;At the time, many of Whitcomb’s colleagues were looking for solutions in aerodynamic theory. Whitcomb took a different approach: he grabbed a can of putty and headed for the Langley wind tunnel.&lt;sup id=&quot;fnref:fn10&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn10&quot; class=&quot;footnote&quot;&gt;12&lt;/a&gt;&lt;/sup&gt; He knew that the problem with existing airfoils was that air flowed at a higher rate around the top of the wing than the bottom. As the plane approached supersonic speeds, the air on top was the first to hit the sound barrier. Energy, normally dissipated as sound, would then be moving at the same speed as the air itself and slowly start to accumulate. A shock wave would form. Then the shock wave would create all sorts of pathological drag and instabilities.&lt;sup id=&quot;fnref:fn11&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn11&quot; class=&quot;footnote&quot;&gt;13&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:99%; min-width:350px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/supercritical_wide.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;With this in mind, Whitcomb used putty to decrease the camber of the wing so as to lower the airspeed above it. Then he added a slight concavity to the underside of the wing to maintain lift and stability. All of this was based on his intuition for how air flowed over a wing at high speeds, but it ended up being extraordinarily effective. His “supercritical” wing design allowed the United States to build the fastest bombers, fighters, and reconnaissance planes of the Cold War. And surprisingly, this wing design turned out to be stable and efficient even at subsonic speeds. Today’s commercial airliners, which cruise at speeds around Mach 0.85, all use supercritical airfoils to improve fuel efficiency.&lt;/p&gt;

&lt;p&gt;Looking over the history of wing design, it is easy to see that the boundary between imagination and the constraints of the real world is where invention happens. When ideas are fully constrained to our minds, we have the tendency to indulge in impractical fantasies. And yet we need imagination too. For without it, we are limited to the incremental trial-and-error pace of evolution. Imagination is our one clear advantage over evolution, for it requires no intermediary. For evolution to invent a wing, there needed to be a half-winged precursor. But imagination has a strangely liberating effect in that it allows us to move from the ground to the sky in a single intuitive leap.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:54.8%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/kurochkin2010.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;An evolutionary pathway from small sauropods to flying birds, proposed by &lt;a href=&quot;10.1134/S0031030110120129&quot;&gt;Kurochkin and Bogdanovich (2010)&lt;/a&gt;. Each intermediary took hundreds of thousands of years of natural selection.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:44.4%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/sound_barrier.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;The Supermarine Spitfire (top) was one of the fastest planes of World War II. The Bell X-1 (bottom) unseated the Spitfire and broke the sound barrier a few years later. Notice how different the two planes look; human design lacks intermediaries.&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;h3 id=&quot;physical-theories&quot;&gt;Physical Theories&lt;/h3&gt;

&lt;p&gt;Since the first half of the twentieth century when the core breakthroughs of aeronautics occurred, scientists have been hard at work on physical theories that can explain those breakthroughs. These theories have expanded into fields of study like “computational fluid dynamics,” “aeronautical science,” and “turbulent flow.” Such principles are quite complex, but the question they aim to answer is simple: &lt;em&gt;how do wings work?&lt;/em&gt; We are going to answer that question in the next section by obtaining our own wing starting from nothing but the physics of airflow.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%;margin-bottom: 200px; margin-top: 50px&quot;&gt;
    &lt;a href=&quot;../../../../2020/10/14/optimizing-a-wing/&quot; id=&quot;featuredlink&quot; target=&quot;_blank&quot; style=&quot;margin-right: 10px;&quot;&gt;Post #3: Optimizing a Wing&lt;/a&gt;
&lt;/div&gt;

&lt;h3 id=&quot;appendix-airfoil-timeline&quot;&gt;Appendix: Airfoil Timeline&lt;/h3&gt;

&lt;p&gt;Here is a complete timeline of the airfoils we discussed in this post. Outlines in the first three columns were obtained from primary sources and are technically accurate. Outlines in the fourth row are believed to be technically accurate – or close 🤷‍♂️&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%;&quot;&gt;
  &lt;div style=&quot;width:99%; min-width:350px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/stepping-stones/airfoil-timeline-full.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;

&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn1&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Wenham, Francis Herbert. &lt;a href=&quot;https://babel.hathitrust.org/cgi/pt?id=uc1.b4513625&amp;amp;view=1up&amp;amp;seq=24&quot;&gt;On aërial locomotion and the laws by which heavy bodies impelled through the air are sustained&lt;/a&gt;, &lt;em&gt;Annual Report of the Aëronautical Society of Great Britain&lt;/em&gt;, p. 10-20, 1866. &lt;a href=&quot;#fnref:fn1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Allward, Maurice. An Illustrated History of Seaplanes and Flying Boats, &lt;em&gt;New York: Dorset Press&lt;/em&gt;, p. 11, 1981. &lt;a href=&quot;#fnref:fn2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Crosby, Francis. The Complete Guide to Fighters &amp;amp; Bombers of the World: An Illustrated History of the World’s Greatest Military Aircraft, &lt;em&gt;London: Anness Publishing Ltd.&lt;/em&gt;, p. 16, 2006. &lt;a href=&quot;#fnref:fn3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt; &lt;a href=&quot;#fnref:fn3:1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn4&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Gibbs-Smith, Charles Harvard. Aviation. &lt;em&gt;London: NMSI&lt;/em&gt;, p. 57, 2003. &lt;a href=&quot;#fnref:fn4&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn5&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Boulton, Matthew Piers Watt. On Aerial Locomotion. &lt;em&gt;Bradbury &amp;amp; Evans, London&lt;/em&gt;, 1864. &lt;a href=&quot;#fnref:fn5&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn6&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Gibbs-Smith, 2003. p. 68. &lt;a href=&quot;#fnref:fn6&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn7&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;National Air and Space Museum. The Ariel: The First Carriage Of The Ærial Transit Company. &lt;em&gt;National Air and Space Museum Collection&lt;/em&gt;, 1843. &lt;a href=&quot;#fnref:fn7&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn14&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Otto Lilienthal. &lt;em&gt;Birdflight as the Basis of Aviation.&lt;/em&gt; Longmans, Green, and Co., London, 1 edition, 1889. &lt;a href=&quot;#fnref:fn14&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn15&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;The wrong value of this coefficient had been in use for more than a hundred years and was part of the accepted equation for lift. So in determining that this number was wrong, the Wrights made a major discovery. &lt;a href=&quot;#fnref:fn15&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn8&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Topnotch Gist. &lt;a href=&quot;https://youtu.be/NGZ7gRlwLJs&quot;&gt;The History And Evolution of Modern Airplane Wing Design&lt;/a&gt;. &lt;em&gt;YouTube&lt;/em&gt;, 2020. &lt;a href=&quot;#fnref:fn8&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn9&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;&lt;a href=&quot;http://www.century-of-flight.freeola.com/Aviation%20history/evolution%20of%20technology/Airfoils.htm&quot;&gt;Airfoils&lt;/a&gt; and &lt;a href=&quot;http://www.century-of-flight.freeola.com/Aviation%20history/evolution%20of%20technology/Supercritical%20Airfoil.htm&quot;&gt;Supercritical Airfoils&lt;/a&gt;. &lt;em&gt;Century of Flight&lt;/em&gt;. &lt;a href=&quot;#fnref:fn9&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt; &lt;a href=&quot;#fnref:fn9:1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; &lt;a href=&quot;#fnref:fn9:2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn10&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Garrison, Peter. &lt;a href=&quot;https://www.airspacemag.com/history-of-flight/the-man-who-could-see-air-28723910/?page=2&quot;&gt;The Man Who Could See Air&lt;/a&gt;. &lt;em&gt;Air &amp;amp; Space Magazine&lt;/em&gt;, 2002 &lt;a href=&quot;#fnref:fn10&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn11&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Many of the airfoil shapes used in this post were taken from NASA’s &lt;a href=&quot;https://history.nasa.gov/SP-4305/p115.htm&quot;&gt;historical archives&lt;/a&gt;. See “SP-4305 Engineer in Charge” &lt;a href=&quot;https://history.nasa.gov/&quot;&gt;&lt;em&gt;NASA History Division&lt;/em&gt;&lt;/a&gt;, 1986. &lt;a href=&quot;#fnref:fn11&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html">How did flight become a reality? Let&apos;s look at the inventors who took flight from the world of ideas to the world of things – focusing in particular on airfoil design.</summary></entry><entry><title type="html">The Story of Flight</title><link href="http://greydanus.github.io/2020/10/12/story-of-flight/" rel="alternate" type="text/html" title="The Story of Flight" /><published>2020-10-12T04:00:00-07:00</published><updated>2020-10-12T04:00:00-07:00</updated><id>http://greydanus.github.io/2020/10/12/story-of-flight</id><content type="html" xml:base="http://greydanus.github.io/2020/10/12/story-of-flight/">&lt;div&gt;
  &lt;style&gt;
      #linkbutton:link, #linkbutton:visited {
        padding: 6px 0px;
        text-decoration: none;
        display: inline-block;

        border: 2px solid #777;
        padding: 10px;
        font-size: 20px;
        min-width: 200px;
        width: 50%;
        text-align: center;
        color: #999;
        margin: 0px auto;
        cursor: pointer;
        margin-bottom: 10px;
      }

      #linkbutton:hover, #linkbutton:active {
        background-color: rgba(245, 245, 245);
      }

    .playbutton {
      background-color: rgba(0, 153, 51);
      /*background-color: rgba(255, 130, 0);*/
      border-radius: 4px;
      color: white;
      padding: 3px 8px;
      /*width: 60px;*/
      text-align: center;
      text-decoration: none;
      text-transform: uppercase;
      font-size: 12px;
      /*display: block;*/
      /*margin-left: auto;*/
      margin: 8px 0px;
      margin-right: auto;
      min-width:80px;
    }
  &lt;/style&gt;
&lt;/div&gt;

&lt;!-- &lt;div class=&quot;imgcap_noborder&quot;&gt;
  &lt;img src=&quot;/assets/story-of-flight/hummingbird.png&quot; style=&quot;width:10%;min-width:150px;&quot;&gt;
&lt;/div&gt; --&gt;

&lt;p&gt;When I was growing up, hummingbirds used to fly into our garage and get stuck. I remember finding one perched on a windowsill, weak from exertion. It let me fold my hands around it and carry it outside. And when I opened my hands, it lay on my palms for a moment. That’s when the sunlight ignited its iridescent plumage and engulfed its whole body in a cloud of blues and greens. Then it understood it was free, whirred its wings, and vanished into the open air. Long after it had departed, my mind’s eye gazed upon the little bird. With an idle curiosity, I tried to imagine how natural forces could have wrought such a thing. We know of lift and drag, thrust and gravity as rough textbook concepts. But it’s another thing entirely to gaze upon a creature of beauty and sophistication and realize that it was shaped in part by those simple forces.&lt;/p&gt;

&lt;p&gt;Since my encounter with the hummingbird, I have always been naturally drawn to flight. It’s a bizarre desire to possess, since humans did not evolve to fly. And yet many humans have felt the same way over the years. Entire cultures, even, have dreamed of flight. And step by step, they have used technology to fashion their own artificial wings and bring about the modern-day miracle of flight. The purpose of this series of posts is to recount that epic adventure. I will tell it through the lens of history, looking at the individual people who wanted to fly, the lens of technology, looking at the key inventions leading up to modern airplanes, and the lens of physics, looking at the equations of airflow that made it all possible. As a final flourish, I will derive a wing from scratch by simulating a wind tunnel, differentiating through it, and using gradient descent to deform a rectangular occlusion into a wing.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:32.8%; min-width:200px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/story-of-flight/leonardo.jpg&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;Leonardo da Vinci, an important figure in the history of flight.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:32.8%; min-width:200px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/story-of-flight/lilienthal.jpg&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;Otto Lilienthal, who made key technological breakthroughs in wing shape and design.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:32.8%; min-width:200px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/story-of-flight/wing_shape.png&quot; id=&quot;wingShapeImage&quot; onclick=&quot;toggleWingShape()&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;Optimizing our own wing in a fluid simulation. &lt;p style=&quot;color:grey;display:inline;&quot;&gt;[Click to pause or play.]&lt;/p&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;h3 id=&quot;the-early-aviators&quot;&gt;The Early Aviators&lt;/h3&gt;

&lt;p&gt;In the past century alone, airplane design has progressed from the Wright brothers’ ramshackle &lt;em&gt;Flyer&lt;/em&gt; to Lockheed Martin’s streamlined &lt;em&gt;SR-71 Blackbird&lt;/em&gt;. In parallel, our commercial aviation system has developed to the point where anyone can enjoy the possibilities of flight. Flight has become so common and so reasonable that it’s easy to forget the towering lusts and follies that accompanied its invention. But if we are to understand why humans wanted to fly in the first place, we need to relive those lusts and follies. One way to do this is by looking back at the lives of the early aviators.&lt;/p&gt;

&lt;p&gt;Perhaps none of the early aviators wanted to fly as much as the tower jumpers. Beginning in the Middle Ages, there was a string of inventors who fashioned wings for themselves and then leaped from towers in imitation of birds. These daredevils were the tower jumpers. Having neglected the essential calculations of lift and drag, they relied mostly on wits, intuition, and dumb luck to survive. Alas, gravity tended to be stronger. Most of their attempts ended in death or serious injury. But one exception to the rule was the Andalusian inventor Abbas ibn Firnas. The story goes that he made his jump at the astonishing age of seventy years. Once he was airborne, his feather suit cushioned his fall and allowed him to glide to the ground unharmed.&lt;sup id=&quot;fnref:fn1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn1&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; Somehow, in spite of his wild deeds, Abbas lived on to the respectable age of 78.&lt;/p&gt;

&lt;p&gt;The common folk of Andalusia must have enjoyed laughter and endless conversations about Abbas and his wingsuit. They would have asked, why does he want to fly? Pigs do not have wings and they are quite content about it. Why should humans, who likewise have no wings, want to pretend at flight? They would have been making a good point. After all, the tower jumpers needed to be more than half mad to take the risks they did. But on a fundamental level, they were probably driven by things that most humans can relate to: the desires for freedom, glory, and adventure.&lt;/p&gt;

&lt;h3 id=&quot;the-freedom-of-flight&quot;&gt;The Freedom of Flight&lt;/h3&gt;

&lt;p&gt;We can see this in Leonardo da Vinci, whose work on flight was deeply rooted in a desire for freedom. Most people know that da Vinci painted the Mona Lisa and sketched a number of remarkable flying machines. However, few of them are aware of the pressures that shaped him.&lt;sup id=&quot;fnref:fn2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn2&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; Leonardo began life as the illegitimate son of an Italian aristocrat and a peasant woman. And so he had to support himself from an early age by taking on strict apprenticeships and painting for wealthy patrons. The fact that he was gay complicated things even further.&lt;/p&gt;

&lt;p&gt;His life reached a moment of crisis on his 27th birthday when he and his friends were imprisoned for acts of sodomy. Imprisonment affected him deeply. As soon as he was released, he sketched a machine meant to “open a prison from the inside” and another for tearing bars off of windows. Around the same time, he became obsessed with bird flight and began buying birds at markets in order to sketch them. When he finished sketching them, he would free them from their cages. “Once you have tasted flight,” he wrote, “you will forever walk the earth with your eyes turned skyward. For there you have been, and there you will always long to return.” For da Vinci, flight seems to have been a metaphor for freedom and an antidote to the horrors of captivity.&lt;/p&gt;

&lt;h3 id=&quot;the-glory-of-flight&quot;&gt;The Glory of Flight&lt;/h3&gt;

&lt;p&gt;But freedom is not the only reason people wanted to fly. For others, flight was a shot at glory – and nobody loved glory more than the French chemist Pilatre de Rozier. This man was quite a character. He was known to breathe fire, seduce older women, and give himself fake titles.&lt;sup id=&quot;fnref:fn3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;As a young scientist, he signed his papers, “Apothecary,” then “first Apothecary,”” and finally, “Pharmacy Inspector” of the Prince of Limbourg. This impressed his colleagues until they discovered that the Prince of Limbourg did not, in fact, exist. In a twist of irony, it was this same hunger for glory that also led de Rozier to his greatest scientific breakthroughs. The first was the match, which he invented in order to show off his fire breathing skills in a public lecture. The second was the gas mask, which he used in a stunt that involved lowering himself into the fumes of a vat of fermenting beer. The final, and most significant breakthrough, was his completion of the first manned voyage in a hot air balloon. King Louis XVI wanted to put criminals in the balloon but de Rozier objected, saying “The glory should not be given to criminals!”&lt;sup id=&quot;fnref:fn4&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn4&quot; class=&quot;footnote&quot;&gt;4&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;Pilatre was far from perfect, but his bravery and showmanship inspired people and gave aeronauts an immensely positive image in France. His initial balloon launch attracted a crowd of over a hundred thousand people. When these people saw him land safely, common attitudes about flight changed. No longer was human flight seen as a thing of folly. It became a source of national pride and a crowning achievement of science. And for many, it began to represent an exciting new frontier.&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:35.5%; min-width:180px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/story-of-flight/davinci_glider.jpg&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align: left;&quot;&gt;A page from one of da Vinci&apos;s journals describes an &quot;air screw&quot; that resembles a modern helicopter. &lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:26.9%; min-width:130px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/story-of-flight/balloon.png&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;Pilatre de Rozier and his companion take off in a hot air balloon.&lt;/div&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:36.4%; min-width:180px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/story-of-flight/earhart.jpg&quot; style=&quot;width:100%&quot; /&gt;
    &lt;div style=&quot;text-align:left;&quot;&gt;Amelia Earhart sitting upon the nose of her plane in 1936.&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Like any new frontier, flight called most strongly to those with a sense of imagination and adventure. One person who heeded this call was &lt;a href=&quot;https://en.wikipedia.org/wiki/Antoine_de_Saint-Exup%C3%A9ry&quot;&gt;Antoine de Saint-Exupery&lt;/a&gt;. In his short life, he became both a decorated military pilot and one of France’s best poets and novelists. He managed this double act by blending his writing with his flying until they became almost the same activity. There are eccentric stories about how he wrote poetry during military scouting missions and once circled a landing strip for an hour to finish reading a good novel.&lt;sup id=&quot;fnref:fn6&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn6&quot; class=&quot;footnote&quot;&gt;5&lt;/a&gt;&lt;/sup&gt; To Saint-Exupery, flight was as much an adventure of the mind as it was the body. In fact, he argued that these two adventures were inseparable: the way a mind perceives the physical world determines how the body will eventually shape it. Or, as he put it, “A rock pile ceases to be a rock pile the moment a single man contemplates it, bearing within him the image of a cathedral.” His own life supports that idea, for, in thinking and writing about flight from the lens of an artist, he transformed it into something that promised not only freedom and glory, but also beauty and adventure.&lt;/p&gt;

&lt;p&gt;The other side of venturing into a frontier is that one must leave behind the comforts of civilized life. Even as airplanes improved in the early 1900’s, they remained costly, dangerous, and generally impractical. So every one of the early aviators had to make sacrifices in order to fly. But one person who had to make especially tough choices was Amelia Earhart.&lt;/p&gt;

&lt;p&gt;Earhart was one of the best early airplane pilots and famously went missing during an attempt to fly around the world. The first, and most obvious choice she had to make was to risk her life in pursuit of that goal. But apart from safety, she had to risk bankruptcy throughout her twenties – taking odd jobs and once selling her plane in order to support herself. And finally, once she was able to support herself financially, she had to risk losing love and the chance at marriage. The publicist George Putnam had proposed and the two were preparing for marriage when she explained to him, “I cannot endure at all times even an attractive cage.”&lt;sup id=&quot;fnref:fn8&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn8&quot; class=&quot;footnote&quot;&gt;6&lt;/a&gt;&lt;/sup&gt; Putnam eventually agreed to an unconventional open marriage, but Earhart’s letter suggests she was prepared to forgo it entirely if it interfered with her ability to fly. Like Earhart, many of the early aviators had to lose wealth, love, or life in the pursuit of flight.&lt;/p&gt;

&lt;p&gt;That was the nature of life on the new frontier.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%;margin-bottom: 100px; margin-top: 50px&quot;&gt;
    &lt;a href=&quot;../../../../2020/10/13/stepping-stones/&quot; id=&quot;featuredlink&quot; target=&quot;_blank&quot; style=&quot;margin-right: 10px;&quot;&gt;Post #2: The Stepping Stones of Flight&lt;/a&gt;
&lt;/div&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;

&lt;script language=&quot;javascript&quot;&gt;
  function toggleWingShape() {

    path = document.getElementById(&quot;wingShapeImage&quot;).src
      if (path.split(&apos;/&apos;).pop() == &quot;wing_shape.png&quot;) 
      {
          document.getElementById(&quot;wingShapeImage&quot;).src = &quot;/assets/story-of-flight/wing_summary.gif&quot;;
      }
      else 
      {
          document.getElementById(&quot;wingShapeImage&quot;).src = &quot;/assets/story-of-flight/wing_shape.png&quot;;
      }
  }
&lt;/script&gt;

&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn1&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;White, Lynn Townsend Jr. &lt;a href=&quot;https://www.jstor.org/stable/pdf/3101411.pdf?seq=1&quot;&gt;Eilmer of Malmesbury, an Eleventh Century Aviator: A Case Study of Technological Innovation, Its Context and Tradition&lt;/a&gt;, &lt;em&gt;Technology and Culture 2&lt;/em&gt;, p. 97-111, 1961. For a quick but less scholarly overview, try &lt;a href=&quot;https://www.thefamouspeople.com/profiles/abbas-ibn-firnas-33319.php&quot;&gt;this online article&lt;/a&gt;. &lt;a href=&quot;#fnref:fn1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Isaacson, Walter. Leonardo da Vinci, &lt;em&gt;Simon &amp;amp; Schuster&lt;/em&gt;, 2017. See also this New Yorker &lt;a href=&quot;https://www.newyorker.com/magazine/2017/10/16/the-secret-lives-of-leonardo-da-vinci&quot;&gt;review article&lt;/a&gt; about the book. &lt;a href=&quot;#fnref:fn2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Duval, Clément. &lt;a href=&quot;https://online.ucpress.edu/hsns/article/doi/10.2307/27757275/33554/Pilatre-de-Rozier-1754-1785-Chemist-and-First&quot;&gt;Pilatre de Rozier (1754-1785), Chemist and First Aeronaut&lt;/a&gt;, &lt;em&gt;Chymia&lt;/em&gt;, 1967. This article is well written, and quite fun to read. I’d recommend the whole thing. &lt;a href=&quot;#fnref:fn3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn4&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Penenberg, Adam L. &lt;a href=&quot;https://books.google.com/books?id=WCmUCwAAQBAJ&amp;amp;pg=PT56&amp;amp;lpg=PT56&amp;amp;dq=rozier+louis+criminal+balloon&amp;amp;source=bl&amp;amp;ots=c0b-7imHWp&amp;amp;sig=ACfU3U14AFxunsLlX7D6PxEp82CYpVC5FQ&amp;amp;hl=en&amp;amp;sa=X&amp;amp;ved=2ahUKEwjHyZCZxJvqAhUU7J4KHRStCqcQ6AEwDHoECAwQAQ#v=onepage&amp;amp;q=rozier%20louis%20criminal%20balloon&amp;amp;f=false&quot;&gt;Sky Rivals: Two Men. Two Planes. An Epic Race Around the World.&lt;/a&gt;, &lt;em&gt;Wayzgoose Press&lt;/em&gt;, 2016 &lt;a href=&quot;#fnref:fn4&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn6&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Schiff, Stacy. &lt;a href=&quot;https://web.archive.org/web/20161020193505/https://books.google.com/books?id=2G4Q_GNpCUMC&amp;amp;hl=en&quot;&gt;Saint-Exupéry: A Biography&lt;/a&gt;, &lt;em&gt;Da Capo Press&lt;/em&gt;, 1997. See also the &lt;a href=&quot;https://en.wikipedia.org/wiki/Antoine_de_Saint-Exup%C3%A9ry&quot;&gt;Wikipedia article&lt;/a&gt; about Saint-Exupéry. &lt;a href=&quot;#fnref:fn6&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn8&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;&lt;a href=&quot;https://www.huffpost.com/entry/amelia-earhart-prenup_n_2280057&quot;&gt;Amelia Earhart’s Prenup Is Remarkably Modern&lt;/a&gt;, &lt;em&gt;Huffington Post&lt;/em&gt;, 2017. An image of the prenuptual letter itself is &lt;a href=&quot;https://images.huffingtonpost.com/2012-12-11-earhart.jpg&quot;&gt;here&lt;/a&gt;. &lt;a href=&quot;#fnref:fn8&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html">Why do humans want to fly? Let&apos;s start by looking at the humans for whom the desire to fly was strongest: the early aviators.</summary></entry><entry><title type="html">Self-classifying MNIST Digits</title><link href="http://greydanus.github.io/2020/08/27/selforg-mnist/" rel="alternate" type="text/html" title="Self-classifying MNIST Digits" /><published>2020-08-27T04:00:00-07:00</published><updated>2020-08-27T04:00:00-07:00</updated><id>http://greydanus.github.io/2020/08/27/selforg-mnist</id><content type="html" xml:base="http://greydanus.github.io/2020/08/27/selforg-mnist/">&lt;div&gt;
	&lt;style&gt;
        #linkbutton:link, #linkbutton:visited {
          padding: 6px 0px;
          text-decoration: none;
          display: inline-block;

          border: 2px solid #777;
          padding: 10px;
          font-size: 20px;
          min-width: 200px;
          width: 50%;
          text-align: center;
          color: #999;
          margin: 0px auto;
          cursor: pointer;
          margin-bottom: 10px;
        }

        #linkbutton:hover, #linkbutton:active {
          background-color: rgba(245, 245, 245);
        }

		.playbutton {
		  background-color: rgb(148, 196, 146);
		  border-width: 0;
		  /*background-color: rgba(255, 130, 0);*/
		  border-radius: 4px;
		  color: white;
		  padding: 5px 8px;
		  /*width: 60px;*/
		  text-align: center;
		  text-decoration: none;
		  text-transform: uppercase;
		  font-size: 12px;
		  /*display: block;*/
		  /*margin-left: auto;*/
		  margin: 8px 0px;
		  margin-right: auto;
		  min-width:60px;
		}

		.playbutton:hover, .playbutton:active {
		  background-color: rgb(128, 176, 126);
		}
	&lt;/style&gt;
&lt;/div&gt;

&lt;p&gt;In this project, we treat every pixel in an image as a biological cell. Then we train these cells to send signals to their neighbors so that, over time, the entire population will agree on what digit they are shaping. Every cell “votes” on the global shape by turning one of ten different colors, corresponding to the ten digits. Sometimes the truth prevails and sometimes they are collectively misguided. I like &lt;a href=&quot;https://twitter.com/hardmaru/status/1299152583328559105&quot;&gt;@hardmaru’s example&lt;/a&gt;, reproduced below, of a 4 vs. a 2 (🔴 🔵). It’s similar to an election process – it even has “swing states:”&lt;/p&gt;

&lt;div class=&quot;imgcap&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:100%; min-width:250px; display: inline-block; vertical-align: top;text-align:center;&quot;&gt;
    &lt;video style=&quot;width:100%;min-width:250px;&quot; controls=&quot;&quot;&gt;
    	&lt;source src=&quot;/assets/selforg-digits/screencapture.mp4&quot; type=&quot;video/mp4&quot; /&gt;
    &lt;/video&gt;
&lt;!--     &lt;div style=&quot;text-align: left;margin-left:10px;margin-right:10px;padding-top: 20px;&quot;&gt;

    	&lt;/div&gt; --&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;I encourage you to read the article and try the interactive demo for yourself on Distill:&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:100%&quot;&gt;
	&lt;a href=&quot;https://distill.pub/2020/selforg/mnist/&quot; id=&quot;featuredlink&quot; target=&quot;_blank&quot; style=&quot;margin-right: 10px;&quot;&gt;Read the article on Distill&lt;/a&gt;
&lt;/div&gt;

&lt;h2 id=&quot;useful-properties-of-cellular-automata&quot;&gt;Useful properties of Cellular Automata&lt;/h2&gt;

&lt;p&gt;One of the takeaways from helping write this Distill article is that cellular automata are fascinating and underrated. In particular, I like them because they are:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Local.&lt;/strong&gt; All interactions in physics are local – aside from quantum entanglement, and even that is up for debate.&lt;sup id=&quot;fnref:fn2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn2&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; All interactions in chemistry and biology are also local, including the interactions between neurons that allow us to learn. The value of locality is that it is one of the &lt;em&gt;strongest&lt;/em&gt; bounds on the complexity of a system. Without locality, any unit (atom, molecule, cell, human) can interact with any other, leading to an exponential growth in causal influences on each unit as the size of the system increases. This is bad news if you want to establish any interesting chains of causality between various sub-units.&lt;sup id=&quot;fnref:fn3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn3&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; For example, when you store information using a small chunk of matter, you do so under the assumption that that information will remain where it is and not change in response to external factors.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Parallelizable.&lt;/strong&gt; One particularly important advantage of locality is that it makes CAs immensely parallelizable. It’s not hard to train or evaluate a large population of CAs asynchronously: disparate parts of the system never have to communicate or synchronize with one another. This is why, if we do live in a simulation, it is probably implemented with a CA.&lt;sup id=&quot;fnref:fn4&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:fn4&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Scalable in number of cells.&lt;/strong&gt; This is closely connected to “parallelizable.” Imagine training a 20x20 population of cells to do something and then running a 200x200 population of them on some downstream task. The numbers are different, but we actually do this in the demo. This is not something you can do with neural networks.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Expressive.&lt;/strong&gt; Given how simple some CAs can be – for example, Conway’s Game of Life – they have impressive theoretical properties. They are Turing complete and can simulate any other system. You could even use Conway’s Game of Life to simulate Conway’s Game of Life…and yes, &lt;a href=&quot;https://twitter.com/AlanZucconi/status/1315967202797981696&quot;&gt;someone actually did this&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Resilient.&lt;/strong&gt; Systems where local interactions eventually lead to global behavior are extraordinarily resilient. You can cut a 2-headed planarian in half and both halves will regenerate. You can cut a limb from a tree and the tree will survive. You can leave your company and your coworkers will continue on without you, barely noticing your absence. Ok, that was a joke, they will miss you, but in theory they should be able to cover for you when you take a few vacation days.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Likely to fail gracefully.&lt;/strong&gt; It’s hard to define what it means to “fail gracefully” so this last point is a bit subjective. Consider the failure case of the 4/2 pattern from the video above, reproduced below. That shape is far outside of the CA’s training distribution, but it responded in a fairly intuitive manner. On the left is another fun failure case where a CA was trained to grow, from a single cell, into a yellow fish emoji. The population of cells kept growing even after it became a mature fish, but did so in a way that preserved the fish’s shape and body texture.&lt;/p&gt;

&lt;div class=&quot;imgcap_noborder&quot; style=&quot;display: block; margin-left: auto; margin-right: auto; width:99.9%&quot;&gt;
  &lt;div style=&quot;width:47.3%; min-width:200px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/selforg-digits/42_color.png&quot; style=&quot;width:100%&quot; /&gt;
  &lt;/div&gt;
  &lt;div style=&quot;width:52%; min-width:300px; display: inline-block; vertical-align: top;&quot;&gt;
    &lt;img src=&quot;/assets/selforg-digits/fish.png&quot; style=&quot;width:100%&quot; /&gt;
&lt;!--     &lt;div style=&quot;text-align:left;&quot;&gt;A plot by &lt;a href=&quot;https://doi.org/10.1002/jmor.10013&quot;&gt;Lindhe (2002)&lt;/a&gt; showing aspect ratio versus wing loading index in some birds, airplanes, a hang-glider, a butterfly, and a maple seed. Just like the families of birds, different human flying machines display substantial variation along these axes.&lt;/div&gt; --&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;I like CA as a design motif. They capture a set of elegant design principles that, even if we don’t follow them strictly at all times in other areas of science, are worth thinking about.&lt;/p&gt;

&lt;h2 id=&quot;parting-words&quot;&gt;Parting words&lt;/h2&gt;

&lt;p&gt;It feels good to have released the Distill article and demo to the world. Now, on thousands of different browser screens, our little cells are coming to life. They are looking at their particular MNIST pixels, talking to their neighbors, and trying to figure out what their overall digit shape is. Little do they know, they are part of a human scientific endeavor that is much the same. For we humans, too, are looking at our local surroundings, talking with our neighbors, and trying to agree on the overall shape of our reality.&lt;/p&gt;

&lt;p&gt;Best of luck to the little cells and to us humans as well.&lt;/p&gt;

&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:fn2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;I want to write a post on this, but I have more reading to do first. &lt;a href=&quot;#fnref:fn2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;One of the problems with fully-connected neural networks is that they use very dense connectivity patterns – denser, perhaps, than locality constraints permit in the brain. In recent years, we’ve seen that particular connectivity patterns (e.g. the local connectivity of ConvNets) have major advantages. &lt;a href=&quot;#fnref:fn3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:fn4&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;Which makes the fact that this article is about CA pretty meta. &lt;a href=&quot;#fnref:fn4&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html">We treat every pixel in an image as a biological cell. We train these cells to signal to one another and determine what digit they are shaping.</summary></entry></feed>